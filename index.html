<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Factory Grid Simulator - Place machines, connect with belts, and optimize layouts" />
  <title>Factory Grid Simulator</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš™</text></svg>" />
  <script type="module" crossorigin>(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var Ct=(t=>(t.M3x3="3x3",t.M5x3="5x3",t.M5x5="5x5",t))(Ct||{}),Y=(t=>(t.NORTH="NORTH",t.EAST="EAST",t.SOUTH="SOUTH",t.WEST="WEST",t))(Y||{}),te=(t=>(t.INPUT="INPUT",t.OUTPUT="OUTPUT",t))(te||{}),Z=(t=>(t.EMPTY="EMPTY",t.MACHINE="MACHINE",t.BELT="BELT",t))(Z||{}),at=(t=>(t.UP="UP",t.DOWN="DOWN",t.LEFT="LEFT",t.RIGHT="RIGHT",t))(at||{});const Ce={"3x3":{baseWidth:3,baseHeight:3},"5x3":{baseWidth:5,baseHeight:3},"5x5":{baseWidth:5,baseHeight:5}};function U(t){const o=Ce[t.type];return t.orientation==="EAST"||t.orientation==="WEST"?{width:o.baseHeight,height:o.baseWidth}:{width:o.baseWidth,height:o.baseHeight}}function ee(t){return Ce[t.type].baseWidth}function Te(t){switch(t){case"UP":return"DOWN";case"DOWN":return"UP";case"LEFT":return"RIGHT";case"RIGHT":return"LEFT"}}function Ee(t){switch(t){case"UP":return{dx:0,dy:-1};case"DOWN":return{dx:0,dy:1};case"LEFT":return{dx:-1,dy:0};case"RIGHT":return{dx:1,dy:0}}}function Ae(t){switch(t){case"NORTH":return"UP";case"EAST":return"RIGHT";case"SOUTH":return"DOWN";case"WEST":return"LEFT"}}function en(t){return Te(Ae(t))}let nn=1;function ke(){return`id_${nn++}`}function ce(t,o){const n=[];for(let e=0;e<o;e++){n[e]=[];for(let i=0;i<t;i++)n[e][i]={type:Z.EMPTY,beltConnectionIds:[]}}return{width:t,height:o,cells:n,machines:new Map,connections:new Map,beltPaths:new Map}}function Nt(t,o,n){return o>=0&&n>=0&&o<t.width&&n<t.height}function le(t,o,n){const{width:e,height:i}=U(o);for(let s=0;s<i;s++)for(let r=0;r<e;r++){const a=o.x+r,c=o.y+s;if(!Nt(t,a,c))return!1;const d=t.cells[c][a];if(d.type===Z.MACHINE&&d.machineId!==n)return!1}return!0}function mt(t,o){if(!le(t,o))return!1;const{width:n,height:e}=U(o);for(let i=0;i<e;i++)for(let s=0;s<n;s++){const r=o.x+s,a=o.y+i;t.cells[a][r]={type:Z.MACHINE,machineId:o.id,beltConnectionIds:[]}}return t.machines.set(o.id,o),!0}function de(t,o){const n=t.machines.get(o);if(!n)return;const{width:e,height:i}=U(n);for(let s=0;s<i;s++)for(let r=0;r<e;r++){const a=n.x+r,c=n.y+s;t.cells[c][a]={type:Z.EMPTY,beltConnectionIds:[]}}t.machines.delete(o)}function F(t){const{width:o,height:n}=U(t),e=ee(t),i=Ae(t.orientation),s=en(t.orientation),r=i,a=s,c=[],d=[];for(let l=0;l<e;l++){let m,u,h,p;switch(t.orientation){case Y.NORTH:m=t.x+l,u=t.y,h=t.x+l,p=t.y+n-1;break;case Y.SOUTH:m=t.x+l,u=t.y+n-1,h=t.x+l,p=t.y;break;case Y.EAST:m=t.x+o-1,u=t.y+l,h=t.x,p=t.y+l;break;case Y.WEST:m=t.x,u=t.y+l,h=t.x+o-1,p=t.y+l;break}c.push({machineId:t.id,portType:te.INPUT,index:l,x:m,y:u,approachDirection:r}),d.push({machineId:t.id,portType:te.OUTPUT,index:l,x:h,y:p,approachDirection:a})}return{inputs:c,outputs:d}}function vt(t){const o=Ee(t.approachDirection);return{x:t.x+o.dx,y:t.y+o.dy}}function qt(t){const o=[];for(let n=0;n<t.height;n++){o[n]=[];for(let e=0;e<t.width;e++){const i=t.cells[n][e];o[n][e]={type:i.type,machineId:i.machineId,beltConnectionIds:[...i.beltConnectionIds]}}}return{width:t.width,height:t.height,cells:o,machines:new Map(Array.from(t.machines.entries()).map(([n,e])=>[n,{...e}])),connections:new Map(Array.from(t.connections.entries()).map(([n,e])=>[n,{...e}])),beltPaths:new Map(Array.from(t.beltPaths.entries()).map(([n,e])=>[n,{connectionId:e.connectionId,segments:e.segments.map(i=>({...i}))}]))}}class on{heap=[];comparator;constructor(o){this.comparator=o}get size(){return this.heap.length}push(o){this.heap.push(o),this.bubbleUp(this.heap.length-1)}pop(){if(this.heap.length===0)return;const o=this.heap[0],n=this.heap.pop();return this.heap.length>0&&(this.heap[0]=n,this.sinkDown(0)),o}peek(){return this.heap[0]}bubbleUp(o){for(;o>0;){const n=o-1>>1;if(this.comparator(this.heap[o],this.heap[n])<0)[this.heap[o],this.heap[n]]=[this.heap[n],this.heap[o]],o=n;else break}}sinkDown(o){const n=this.heap.length;for(;;){let e=o;const i=2*o+1,s=2*o+2;if(i<n&&this.comparator(this.heap[i],this.heap[e])<0&&(e=i),s<n&&this.comparator(this.heap[s],this.heap[e])<0&&(e=s),e!==o)[this.heap[o],this.heap[e]]=[this.heap[e],this.heap[o]],o=e;else break}}}function Rt(t,o,n,e){return Math.abs(t-n)+Math.abs(o-e)}function Jt(t,o){return`${t},${o}`}const rn=[at.UP,at.DOWN,at.LEFT,at.RIGHT];function sn(t,o,n,e,i){const s=t.cells[e][n];if(s.type!==Z.BELT||s.beltConnectionIds.length===0)return!1;const r=t.cells[o.y][o.x];if(r.type!==Z.BELT||r.beltConnectionIds.length===0)return!1;for(const a of s.beltConnectionIds)if(a!==i&&r.beltConnectionIds.includes(a))return!0;return!1}function Ht(t,o,n,e){const i=vt(o),s=vt(n);if(!Nt(t,i.x,i.y)||!Nt(t,s.x,s.y)||t.cells[i.y][i.x].type===Z.MACHINE||t.cells[s.y][s.x].type===Z.MACHINE)return null;const r=o.approachDirection,a=new on((m,u)=>m.f-u.f),c=new Set,d=new Map,l={x:i.x,y:i.y,g:0,h:Rt(i.x,i.y,s.x,s.y),f:Rt(i.x,i.y,s.x,s.y),parent:null,direction:r};for(a.push(l),d.set(Jt(i.x,i.y),0);a.size>0;){const m=a.pop(),u=Jt(m.x,m.y);if(m.x===s.x&&m.y===s.y)return an(m,e);if(!c.has(u)){c.add(u);for(const h of rn){const p=Ee(h),f=m.x+p.dx,y=m.y+p.dy,g=Jt(f,y);if(c.has(g)||!Nt(t,f,y))continue;const b=t.cells[y][f];if(b.type===Z.MACHINE||sn(t,m,f,y,e))continue;const I=m.direction!==null&&m.direction!==h?2:0,v=b.type===Z.BELT?.5:0,M=m.g+1+I+v,w=d.get(g);w!==void 0&&M>=w||(d.set(g,M),a.push({x:f,y,g:M,h:Rt(f,y,s.x,s.y),f:M+Rt(f,y,s.x,s.y),parent:m,direction:h}))}}}return null}function ct(t,o){const n=vt(t),e=vt(o);return Math.abs(n.x-e.x)+Math.abs(n.y-e.y)}function an(t,o){const n=[];let e=t;for(;e!==null;)n.unshift({x:e.x,y:e.y,fromDirection:e.parent?Te(e.direction):null,toDirection:null}),e=e.parent;for(let i=0;i<n.length-1;i++){const s=n[i+1],r=s.x-n[i].x,a=s.y-n[i].y;r===1?n[i].toDirection=at.RIGHT:r===-1?n[i].toDirection=at.LEFT:a===1?n[i].toDirection=at.DOWN:a===-1&&(n[i].toDirection=at.UP)}return{connectionId:o,segments:n}}function Ut(t,o){for(const n of o.segments){const e=t.cells[n.y][n.x];e.type===Z.EMPTY&&(e.type=Z.BELT),e.beltConnectionIds.includes(o.connectionId)||e.beltConnectionIds.push(o.connectionId)}t.beltPaths.set(o.connectionId,o)}function Re(t,o){const n=t.beltPaths.get(o);if(n){for(const e of n.segments){const i=t.cells[e.y][e.x];i.beltConnectionIds=i.beltConnectionIds.filter(s=>s!==o),i.beltConnectionIds.length===0&&i.type===Z.BELT&&(i.type=Z.EMPTY)}t.beltPaths.delete(o)}}const Be=1,Oe=.5,Ne=.3;function ht(t){let o=0,n=0,e=t.width,i=t.height,s=-1,r=-1;for(let d=0;d<t.height;d++)for(let l=0;l<t.width;l++)t.cells[d][l].type!==Z.EMPTY&&(e=Math.min(e,l),i=Math.min(i,d),s=Math.max(s,l),r=Math.max(r,d));for(const d of t.beltPaths.values()){o+=d.segments.length;for(let l=1;l<d.segments.length;l++){const m=d.segments[l-1],u=d.segments[l];m.toDirection!==null&&u.toDirection!==null&&m.toDirection!==u.toDirection&&n++}}const a=s>=0?(s-e+1)*(r-i+1):0,c=o*Be+a*Oe+n*Ne;return{totalBelts:o,boundingBoxArea:a,cornerCount:n,totalScore:c}}const K={background:"#1a1a2e",gridLine:"#1f1f38",gridLineAccent:"#2a2a50",machineBody:"#2a2960",machineBorder:"#5b57d1",machineLabel:"#c0bfff",portInput:"#5bc0eb",portOutput:"#f4845f",selectedHighlight:"#ffd166",beltColors:["#e8c547","#f4845f","#5bc0eb","#7bc950","#e056a0","#56e0d0","#c05beb","#eb5b5b"]};class cn{canvas;ctx;cellSize=32;camera={x:0,y:0,zoom:1};selectedMachineId=null;ghost=null;constructor(o){this.canvas=o,this.ctx=o.getContext("2d"),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){this.canvas.width=this.canvas.parentElement?.clientWidth||window.innerWidth,this.canvas.height=this.canvas.parentElement?.clientHeight||window.innerHeight}setSelectedMachine(o){this.selectedMachineId=o}setGhost(o){this.ghost=o}screenToGrid(o,n){const e=this.cellSize*this.camera.zoom;return{gx:Math.floor((o-this.camera.x)/e),gy:Math.floor((n-this.camera.y)/e)}}gridToScreen(o,n){const e=this.cellSize*this.camera.zoom;return{sx:o*e+this.camera.x,sy:n*e+this.camera.y}}cellCenter(o,n,e){return{cx:o*e+this.camera.x+e/2,cy:n*e+this.camera.y+e/2}}render(o){const{ctx:n,canvas:e}=this,i=this.cellSize*this.camera.zoom;n.fillStyle=K.background,n.fillRect(0,0,e.width,e.height),this.drawGridLines(o,i);for(const s of o.beltPaths.values())this.drawBeltPath(s,i,o);for(const s of o.machines.values())this.drawMachine(s,i);this.ghost&&this.drawGhost(this.ghost,i)}drawGridLines(o,n){const{ctx:e,canvas:i,camera:s}=this,r=Math.max(0,Math.floor(-s.x/n)),a=Math.max(0,Math.floor(-s.y/n)),c=Math.min(o.width,Math.ceil((i.width-s.x)/n)),d=Math.min(o.height,Math.ceil((i.height-s.y)/n));for(let l=r;l<=c;l++){const m=l*n+s.x;e.strokeStyle=l%5===0?K.gridLineAccent:K.gridLine,e.lineWidth=l%5===0?1:.5,e.beginPath(),e.moveTo(m,a*n+s.y),e.lineTo(m,d*n+s.y),e.stroke()}for(let l=a;l<=d;l++){const m=l*n+s.y;e.strokeStyle=l%5===0?K.gridLineAccent:K.gridLine,e.lineWidth=l%5===0?1:.5,e.beginPath(),e.moveTo(r*n+s.x,m),e.lineTo(c*n+s.x,m),e.stroke()}}drawMachine(o,n){const{ctx:e,camera:i}=this,{width:s,height:r}=U(o),a=this.selectedMachineId===o.id,c=o.x*n+i.x,d=o.y*n+i.y,l=s*n,m=r*n,u=3,h=6;e.fillStyle=K.machineBody,this.roundRect(c+u,d+u,l-u*2,m-u*2,h),e.fill(),e.strokeStyle=a?K.selectedHighlight:K.machineBorder,e.lineWidth=a?2.5:1.5,this.roundRect(c+u,d+u,l-u*2,m-u*2,h),e.stroke();const p=Math.max(10,n*.38);e.fillStyle=K.machineLabel,e.font=`bold ${p}px 'JetBrains Mono', monospace`,e.textAlign="center",e.textBaseline="middle",e.fillText(`${o.type} `,c+l/2,d+m/2-n*.12);const f=Math.max(8,n*.22);e.font=`${f}px 'JetBrains Mono', monospace`,e.fillStyle="#8080aa",e.fillText(o.orientation,c+l/2,d+m/2+n*.2),this.drawPorts(o,n)}drawPorts(o,n){const{ctx:e}=this,{inputs:i,outputs:s}=F(o),r=Math.max(3,n*.2);for(const a of i){const{cx:c,cy:d}=this.cellCenter(a.x,a.y,n);e.beginPath(),e.arc(c,d,r,0,Math.PI*2),e.fillStyle=K.portInput,e.fill(),e.beginPath(),e.arc(c,d,r*.4,0,Math.PI*2),e.fillStyle="#fff",e.fill()}for(const a of s){const{cx:c,cy:d}=this.cellCenter(a.x,a.y,n);e.beginPath(),e.arc(c,d,r,0,Math.PI*2),e.fillStyle=K.portOutput,e.fill(),e.beginPath(),e.arc(c,d,r*.45,0,Math.PI*2),e.fillStyle=K.machineBody,e.fill()}}drawBeltPath(o,n,e){const{ctx:i}=this;if(o.segments.length===0)return;const s=Math.abs(ln(o.connectionId))%K.beltColors.length,r=K.beltColors[s],a=Math.max(3,n*.22),c=this.buildBeltPolyline(o,n,e);if(c.length<2)return;i.strokeStyle="rgba(0,0,0,0.4)",i.lineWidth=a+3,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(c[0].x,c[0].y);for(let l=1;l<c.length;l++)i.lineTo(c[l].x,c[l].y);i.stroke(),i.strokeStyle=r,i.lineWidth=a,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(c[0].x,c[0].y);for(let l=1;l<c.length;l++)i.lineTo(c[l].x,c[l].y);i.stroke(),this.drawCrossingDots(o,n,e,r,a);const d=Math.max(2.5,n*.12);if(i.beginPath(),i.arc(c[0].x,c[0].y,d,0,Math.PI*2),i.fillStyle=r,i.fill(),c.length>=2){const l=c[c.length-1],m=c[c.length-2],u=Math.atan2(l.y-m.y,l.x-m.x),h=n*.3;i.fillStyle=r,i.beginPath(),i.moveTo(l.x+Math.cos(u)*h,l.y+Math.sin(u)*h),i.lineTo(l.x+Math.cos(u+2.4)*h*.6,l.y+Math.sin(u+2.4)*h*.6),i.lineTo(l.x+Math.cos(u-2.4)*h*.6,l.y+Math.sin(u-2.4)*h*.6),i.closePath(),i.fill()}}buildBeltPolyline(o,n,e){const i=[],s=e.connections.get(o.connectionId);if(s){const r=e.machines.get(s.sourceMachineId);if(r){const c=F(r).outputs[s.sourcePortIndex];if(c){const{cx:d,cy:l}=this.cellCenter(c.x,c.y,n);i.push({x:d,y:l})}}}for(const r of o.segments){const{cx:a,cy:c}=this.cellCenter(r.x,r.y,n);i.push({x:a,y:c})}if(s){const r=e.machines.get(s.targetMachineId);if(r){const c=F(r).inputs[s.targetPortIndex];if(c){const{cx:d,cy:l}=this.cellCenter(c.x,c.y,n);i.push({x:d,y:l})}}}return i}drawCrossingDots(o,n,e,i,s){const{ctx:r}=this;for(const a of o.segments){const c=e.cells[a.y]?.[a.x];if(!c||c.beltConnectionIds.length<2)continue;const{cx:d,cy:l}=this.cellCenter(a.x,a.y,n),m=s*.9;r.beginPath(),r.arc(d,l,m,0,Math.PI*2),r.fillStyle=i,r.fill(),r.strokeStyle="#fff",r.lineWidth=1.5,r.stroke()}}drawGhost(o,n){const{ctx:e,camera:i}=this,s={id:"__ghost__",type:o.type,x:o.gx,y:o.gy,orientation:o.orientation},{width:r,height:a}=U(s),c=o.gx*n+i.x,d=o.gy*n+i.y,l=r*n,m=a*n,u=3,h=6;e.globalAlpha=.45,e.fillStyle=o.valid?"#2a6040":"#602a2a",this.roundRect(c+u,d+u,l-u*2,m-u*2,h),e.fill(),e.strokeStyle=o.valid?"#4ae080":"#e04a4a",e.lineWidth=2,e.setLineDash([6,4]),this.roundRect(c+u,d+u,l-u*2,m-u*2,h),e.stroke(),e.setLineDash([]);const p=F(s),f=Math.max(2,n*.14);for(const b of p.inputs){const{cx:x,cy:I}=this.cellCenter(b.x,b.y,n);e.beginPath(),e.arc(x,I,f,0,Math.PI*2),e.fillStyle=K.portInput,e.fill()}for(const b of p.outputs){const{cx:x,cy:I}=this.cellCenter(b.x,b.y,n);e.beginPath(),e.arc(x,I,f,0,Math.PI*2),e.fillStyle=K.portOutput,e.fill()}e.fillStyle="#fff";const y=Math.max(9,n*.32);e.font=`bold ${y}px 'JetBrains Mono', monospace`,e.textAlign="center",e.textBaseline="middle",e.fillText(o.type,c+l/2,d+m/2-n*.08);const g=Math.max(7,n*.2);e.font=`${g}px 'JetBrains Mono', monospace`,e.fillStyle="#aaa",e.fillText(o.orientation,c+l/2,d+m/2+n*.18),e.globalAlpha=1}roundRect(o,n,e,i,s){const{ctx:r}=this;s=Math.min(s,e/2,i/2),r.beginPath(),r.moveTo(o+s,n),r.arcTo(o+e,n,o+e,n+i,s),r.arcTo(o+e,n+i,o,n+i,s),r.arcTo(o,n+i,o,n,s),r.arcTo(o,n,o+e,n,s),r.closePath()}}function ln(t){let o=0;for(let n=0;n<t.length;n++){const e=t.charCodeAt(n);o=(o<<5)-o+e,o|=0}return o}const st=[Y.NORTH,Y.EAST,Y.SOUTH,Y.WEST],dn={initialTemp:100,coolingRate:.965,minTemp:.3,iterPerTemp:12,batchSize:50,useFastScore:!0},un={initialTemp:30,coolingRate:.98,minTemp:.1,iterPerTemp:6,batchSize:30,useFastScore:!1},hn={initialTemp:130,coolingRate:.975,minTemp:.08,iterPerTemp:16,batchSize:72,useFastScore:!0},fn={initialTemp:45,coolingRate:.985,minTemp:.04,iterPerTemp:10,batchSize:44,useFastScore:!1},pn=2e3,gn=60,mn=25;async function ge(t,o={},n){const e=yn(o),i=De(e.seed),s=Array.from(t.machines.values()).map(T=>({...T})),r=Array.from(t.connections.values()).map(T=>({...T}));if(s.length===0)return{grid:qt(t),score:ht(t),iterations:0};const a=t.width,c=t.height;let d=0;const l=qt(t),m=ht(t),u=performance.now(),h=Number.isFinite(e.timeBudgetMs)?u+e.timeBudgetMs:Number.POSITIVE_INFINITY,p=()=>e.mode==="deep"&&performance.now()>=h,f={largeMoveRate:e.largeMoveRate,clusterMoveMinSize:Math.min(e.clusterMoveMinSize,e.clusterMoveMaxSize),clusterMoveMaxSize:Math.max(e.clusterMoveMinSize,e.clusterMoveMaxSize),adaptiveOps:e.adaptiveOps,adaptiveWindow:e.adaptiveWindow,adaptiveWarmupIterations:e.adaptiveWarmupIterations,adaptiveMaxOperatorProb:e.adaptiveMaxOperatorProb,adaptiveStagnationResetWindow:e.adaptiveStagnationResetWindow,adaptiveFlattenFactor:e.adaptiveFlattenFactor,largeMoveRateEarly:e.largeMoveRateEarly,largeMoveRateLate:e.largeMoveRateLate,largeMoveCooldownAfterImprove:e.largeMoveCooldownAfterImprove,criticalNetRate:e.criticalNetRate,repairBeamWidth:e.repairBeamWidth},y=[],g=e.persistEliteArchive?In(o.incomingEliteArchive):[];let b={grid:l,score:m};const x=(T,_)=>{const D=Wt(T,_,a,c);if(!D)return;const H=ht(D);H.totalScore<b.score.totalScore&&(b={grid:qt(D),score:H})},I=(T,_)=>{if(e.elitePoolSize<=0)return;const D=An(T),j=gt(T,_,a,c)?.score.totalScore,L=tt(T,_,a,c,!0),rt=Number.isFinite(j)?j:Number.isFinite(L)?L+1e3:1/0;if(Number.isFinite(rt)){if(e.eliteDiversityHash||e.eliteMinDistance>0){for(const V of y){const xt=e.eliteDiversityHash&&V.fingerprint===D,Xt=e.eliteMinDistance>0&&be(T,V.machines)<e.eliteMinDistance;if((xt||Xt)&&rt>=V.score)return}for(let V=y.length-1;V>=0;V--){const xt=y[V],Xt=e.eliteDiversityHash&&xt.fingerprint===D,tn=e.eliteMinDistance>0&&be(T,xt.machines)<e.eliteMinDistance;(Xt||tn)&&y.splice(V,1)}}y.push({machines:T.map(V=>({...V})),connections:_.map(V=>({...V})),score:rt,fingerprint:D}),y.sort((V,xt)=>V.score-xt.score),y.length>e.elitePoolSize&&y.splice(e.elitePoolSize)}},v=(T,_)=>{let D=T.map(L=>({...L}));if(y.length>0){const L=Math.min(y.length-1,Math.floor(Math.pow(i(),1.6)*y.length)),rt=y[L];D=rt.machines.map(V=>({...V})),r.length=0,r.push(...rt.connections.map(V=>({...V})))}let H=D.map(L=>({...L}));const j=1+Math.floor(i()*2);for(let L=0;L<j;L++)H=ze(H,r,a,c,i,f);return tt(H,r,a,c,_)<1/0?H:D};if(e.persistEliteArchive&&g.length>0)for(const T of g)I(T.machines,T.connections);I(s,r);const M=e.useExplorationSeeds?[{name:"Greedy placement",machines:vn(s,r,a,c)},{name:"Layered topology placement",machines:wn(s,r,a,c)},{name:"Current layout",machines:s.map(T=>({...T}))}]:[{name:"Current layout",machines:s.map(T=>({...T}))}];if(e.useExplorationSeeds){const T=Cn(s,r,a,c);T&&M.unshift({name:"Pattern-aware placement",machines:T});const _=Pn(s,r,a,c);_&&M.push({name:"Two-layer exhaustive placement",machines:_})}let w=M[0].machines.map(T=>({...T})),B=1/0,R=1/0,N=!1,k=null;for(const T of M){if(p())break;const _=T.machines.map(L=>({...L})),D=r.map(L=>({...L}));Lt(_,D,a,c),x(_,D),I(_,D);const H=gt(_,D,a,c);H&&(!k||H.score.totalScore<k.totalScore)&&(k=H.score),H&&H.score.totalScore<R&&(R=H.score.totalScore,N=!0,w=_.map(L=>({...L})),r.length=0,r.push(...D.map(L=>({...L}))));const j=tt(_,D,a,c,!0);!N&&j<B&&(B=j,w=_.map(L=>({...L})),r.length=0,r.push(...D.map(L=>({...L}))))}n&&k&&n(k,0,e.mode==="deep"?"Phase 0: Current-layout seed":"Phase 0: Seed placement");let G=w.map(T=>({...T})),S=tt(G,r,a,c,!0);const P=Math.max(1,e.phase1Restarts);let A=G.map(T=>({...T}));for(let T=0;T<P&&!p();T++){let _=0;const D=await Kt(A,r,a,c,{...e.phase1SA,random:i,shouldStop:p,operators:f},(j,L)=>{if(_=L,!n)return;const rt=P>1?`Phase 1: Fast SA (${T+1}/${P})`:"Phase 1: Fast SA";n(j,d+L,rt)});d+=_,x(D,r),I(D,r);const H=tt(D,r,a,c,!0);H<S&&(S=H,G=D.map(j=>({...j}))),A=G.map(j=>({...j})),e.mode==="deep"&&T+1<P&&(A=v(G,!0))}const C=Lt(G,r,a,c);x(C,r),I(C,r);let O=C.map(T=>({...T})),$=tt(O,r,a,c,!1);const X=Math.max(1,e.phase2Attempts);let et=O.map(T=>({...T}));for(let T=0;T<X&&!p();T++){let _=0;const D=await Kt(et,r,a,c,{...e.phase2SA,random:i,shouldStop:p,operators:f},(j,L)=>{if(_=L,!n)return;const rt=X>1?`Phase 2: Fine-tune SA (${T+1}/${X})`:"Phase 2: Fine-tune SA";n(j,d+L,rt)});d+=_,x(D,r),I(D,r);const H=tt(D,r,a,c,!1);H<$&&($=H,O=D.map(j=>({...j}))),et=O.map(j=>({...j})),e.mode==="deep"&&T+1<X&&(et=v(O,!1))}const nt=Lt(O,r,a,c);x(nt,r),I(nt,r);let J=nt.map(T=>({...T}));const ft=Math.max(1,e.localPolishPasses);for(let T=0;T<ft&&!p();T++){const _=Un(J,r,a,c);if(x(_,r),I(_,r),J=kn(_,r,a,c),x(J,r),I(J,r),e.mode==="deep"&&T+1<ft){let D=0;const H=await Kt(J,r,a,c,{...e.phase2SA,initialTemp:Math.max(8,e.phase2SA.initialTemp*.55),iterPerTemp:Math.max(4,Math.floor(e.phase2SA.iterPerTemp*.65)),batchSize:Math.max(14,Math.floor(e.phase2SA.batchSize*.65)),random:i,shouldStop:p,operators:f},(j,L)=>{D=L,n&&n(j,d+L,`Phase 4: Local polish SA (${T+1}/${ft})`)});d+=D,x(H,r),I(H,r),J=H}if(n){const D=gt(J,r,a,c);if(D){const H=ft>1?`Phase 4: Compaction/orient (${T+1}/${ft})`:"Phase 4: Compaction/orient";n(D.score,d,H)}}}I(J,r);const jt=Wt(J,r,a,c);if(jt){const T=ht(jt);T.totalScore<b.score.totalScore&&(b={grid:jt,score:T})}if(m.totalScore<b.score.totalScore&&(b={grid:l,score:m}),e.persistEliteArchive&&(o.outgoingEliteArchive=Sn(y)),n){const T=p()?"Done (time budget reached)":"Done";n(b.score,d,T)}return{grid:b.grid,score:b.score,iterations:d}}function yn(t){const o=t.mode==="deep"?"deep":"normal",n=o==="deep"?{timeBudgetMs:7e3,phase1Restarts:3,phase2Attempts:3,localPolishPasses:3,useExplorationSeeds:!1,elitePoolSize:12,eliteDiversityHash:!0,eliteMinDistance:0,largeMoveRate:.2,clusterMoveMinSize:2,clusterMoveMaxSize:5,adaptiveOps:!0,adaptiveWindow:120,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,persistEliteArchive:!1,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1,phase1SA:hn,phase2SA:fn}:{timeBudgetMs:Number.POSITIVE_INFINITY,phase1Restarts:1,phase2Attempts:1,localPolishPasses:1,useExplorationSeeds:!0,elitePoolSize:8,eliteDiversityHash:!0,eliteMinDistance:0,largeMoveRate:.12,clusterMoveMinSize:2,clusterMoveMaxSize:4,adaptiveOps:!1,adaptiveWindow:100,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,persistEliteArchive:!1,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1,phase1SA:dn,phase2SA:un},e=bt(t.largeMoveRate,n.largeMoveRate,0,.6),i=bt(t.largeMoveRateEarly,e,0,.7),s=bt(t.largeMoveRateLate,e,0,.7),r=bt(t.criticalNetRate,n.criticalNetRate,0,e);return{mode:o,timeBudgetMs:Mn(t.timeBudgetMs,n.timeBudgetMs),phase1Restarts:ut(t.phase1Restarts,n.phase1Restarts),phase2Attempts:ut(t.phase2Attempts,n.phase2Attempts),localPolishPasses:ut(t.localPolishPasses,n.localPolishPasses),useExplorationSeeds:Bt(t.useExplorationSeeds,n.useExplorationSeeds),elitePoolSize:ut(t.elitePoolSize,n.elitePoolSize),eliteDiversityHash:Bt(t.eliteDiversityHash,n.eliteDiversityHash),eliteMinDistance:xn(t.eliteMinDistance,n.eliteMinDistance),largeMoveRate:e,clusterMoveMinSize:ut(t.clusterMoveMinSize,n.clusterMoveMinSize),clusterMoveMaxSize:ut(t.clusterMoveMaxSize,n.clusterMoveMaxSize),adaptiveOps:Bt(t.adaptiveOps,n.adaptiveOps),adaptiveWindow:ut(t.adaptiveWindow,n.adaptiveWindow),adaptiveWarmupIterations:Vt(t.adaptiveWarmupIterations,n.adaptiveWarmupIterations),adaptiveMaxOperatorProb:bt(t.adaptiveMaxOperatorProb,n.adaptiveMaxOperatorProb,.12,1),adaptiveStagnationResetWindow:Vt(t.adaptiveStagnationResetWindow,n.adaptiveStagnationResetWindow),adaptiveFlattenFactor:bt(t.adaptiveFlattenFactor,n.adaptiveFlattenFactor,0,1),persistEliteArchive:Bt(t.persistEliteArchive,n.persistEliteArchive),largeMoveRateEarly:i,largeMoveRateLate:s,largeMoveCooldownAfterImprove:Vt(t.largeMoveCooldownAfterImprove,n.largeMoveCooldownAfterImprove),criticalNetRate:r,repairBeamWidth:ut(t.repairBeamWidth,n.repairBeamWidth),seed:bn(t.seed),phase1SA:n.phase1SA,phase2SA:n.phase2SA}}function ut(t,o){return typeof t!="number"||!Number.isFinite(t)?o:Math.max(1,Math.floor(t))}function Vt(t,o){return typeof t!="number"||!Number.isFinite(t)?o:Math.max(0,Math.floor(t))}function Mn(t,o){return typeof t!="number"||!Number.isFinite(t)||t<=0?o:t}function xn(t,o){return typeof t!="number"||!Number.isFinite(t)||t<0?o:t}function bt(t,o,n,e){return typeof t!="number"||!Number.isFinite(t)?o:Math.max(n,Math.min(e,t))}function Bt(t,o){return typeof t!="boolean"?o:t}function bn(t){if(!(typeof t!="number"||!Number.isFinite(t)))return Math.floor(t)}function De(t){if(t===void 0)return Math.random;let o=t>>>0||1831565813;return()=>(o=o*1664525+1013904223>>>0,o/4294967296)}function In(t){if(!Array.isArray(t))return[];const o=[];for(const n of t){if(!n||typeof n!="object")continue;const e=n.machines,i=n.connections;if(!Array.isArray(e)||!Array.isArray(i))continue;const s=[];for(const a of e){if(!a||typeof a!="object")continue;const c=a;typeof c.id!="string"||typeof c.type!="string"||typeof c.x!="number"||!Number.isFinite(c.x)||typeof c.y!="number"||!Number.isFinite(c.y)||typeof c.orientation!="string"||s.push({id:c.id,type:c.type,x:c.x,y:c.y,orientation:c.orientation})}const r=[];for(const a of i){if(!a||typeof a!="object")continue;const c=a;typeof c.id!="string"||typeof c.sourceMachineId!="string"||typeof c.targetMachineId!="string"||typeof c.sourcePortIndex!="number"||!Number.isFinite(c.sourcePortIndex)||typeof c.targetPortIndex!="number"||!Number.isFinite(c.targetPortIndex)||r.push({id:c.id,sourceMachineId:c.sourceMachineId,sourcePortIndex:Math.floor(c.sourcePortIndex),targetMachineId:c.targetMachineId,targetPortIndex:Math.floor(c.targetPortIndex)})}s.length===0||r.length===0||o.push({machines:s,connections:r})}return o}function Sn(t){return t.map(o=>({machines:o.machines.map(n=>({...n})),connections:o.connections.map(n=>({...n}))}))}function vn(t,o,n,e){if(t.length===0)return[];const i=new Map;for(const f of t)i.set(f.id,new Map);for(const f of o){const y=i.get(f.sourceMachineId),g=i.get(f.targetMachineId);!y||!g||(y.set(f.targetMachineId,(y.get(f.targetMachineId)||0)+1),g.set(f.sourceMachineId,(g.get(f.sourceMachineId)||0)+1))}const s=new Map;for(const[f,y]of i){let g=0;for(const b of y.values())g+=b;s.set(f,g)}const r=t.map(f=>({...f})),a=new Set,c=new Map(r.map(f=>[f.id,f]));let d=null,l=0;for(const[f,y]of i)for(const[g,b]of y)b>l&&(l=b,d=[f,g]);const m=d?d[0]:t[0].id,u=c.get(m);let h=u.orientation,p=1/0;for(const f of st){u.orientation=f;const y=U(u),g=y.width*y.height;g<p&&(p=g,h=f)}if(u.orientation=h,u.x=2,u.y=2,a.add(m),d){const f=d[1],y=c.get(f),g=me(y,u,o,r,a,n,e,c);g&&(y.x=g.x,y.y=g.y,y.orientation=g.orientation),a.add(f)}for(;a.size<r.length;){let f=null,y=-1;for(const v of r){if(a.has(v.id))continue;const M=i.get(v.id);let w=0;for(const[B,R]of M)a.has(B)&&(w+=R);(w>y||w===y&&f===null)&&(y=w,f=v.id)}f||(f=r.find(v=>!a.has(v.id)).id);const g=c.get(f),b=i.get(f),x=[];for(const[v,M]of b)a.has(v)&&x.push({id:v,count:M});x.sort((v,M)=>M.count-v.count);const I=x.length>0?x[0].id:null;if(I){let v=null;for(const w of x){const B=c.get(w.id),R=me(g,B,o,r,a,n,e,c);if(!R)continue;g.x=R.x,g.y=R.y,g.orientation=R.orientation;let N=0;for(const k of o){if(k.sourceMachineId!==g.id&&k.targetMachineId!==g.id)continue;const G=k.sourceMachineId===g.id?k.targetMachineId:k.sourceMachineId;if(!a.has(G))continue;const S=c.get(k.sourceMachineId),P=c.get(k.targetMachineId);if(!S||!P)continue;const A=F(S),C=F(P),O=A.outputs[k.sourcePortIndex],$=C.inputs[k.targetPortIndex];O&&$&&(N+=ct(O,$))}(!v||N<v.cost)&&(v={x:R.x,y:R.y,orientation:R.orientation,cost:N})}const M=v;if(M)g.x=M.x,g.y=M.y,g.orientation=M.orientation;else{const w=c.get(I);ye(g,w,o,r,a,n,e,c)}}else{const v=r.find(M=>a.has(M.id));ye(g,v,o,r,a,n,e,c)}a.add(f)}return r}function me(t,o,n,e,i,s,r,a){const c=U(o);let d=null,l=1/0;for(const m of st){t.orientation=m;const u=U(t),h=[];for(let p=-(u.width-1);p<=c.width-1;p++)h.push({x:o.x+p,y:o.y+c.height+1});for(let p=-(u.width-1);p<=c.width-1;p++)h.push({x:o.x+p,y:o.y-u.height-1});for(let p=-(u.height-1);p<=c.height-1;p++)h.push({x:o.x+c.width+1,y:o.y+p});for(let p=-(u.height-1);p<=c.height-1;p++)h.push({x:o.x-u.width-1,y:o.y+p});for(const p of h){if(t.x=p.x,t.y=p.y,!lt(t,e,i,s,r))continue;let f=0,y=!0;for(const g of n){if(g.sourceMachineId!==t.id&&g.targetMachineId!==t.id)continue;const b=a.get(g.sourceMachineId),x=a.get(g.targetMachineId);if(!b||!x)continue;const I=g.sourceMachineId===t.id?g.targetMachineId:g.sourceMachineId;if(!i.has(I)&&I!==o.id)continue;const v=F(b),M=F(x),w=v.outputs[g.sourcePortIndex],B=M.inputs[g.targetPortIndex];if(!w||!B){y=!1;break}f+=ct(w,B)}y&&f<l&&(l=f,d={x:p.x,y:p.y,orientation:m})}}return d}function ye(t,o,n,e,i,s,r,a){let c=1/0,d=o.x,l=o.y+5,m=t.orientation;for(const u of st){t.orientation=u;const h=Fe(o.x,o.y,t,e,i,s,r);if(!h)continue;t.x=h.x,t.y=h.y;let p=0;for(const f of n){if(f.sourceMachineId!==t.id&&f.targetMachineId!==t.id)continue;const y=a.get(f.sourceMachineId),g=a.get(f.targetMachineId);if(!y||!g)continue;const b=f.sourceMachineId===t.id?f.targetMachineId:f.sourceMachineId;if(!i.has(b))continue;const x=F(y),I=F(g),v=x.outputs[f.sourcePortIndex],M=I.inputs[f.targetPortIndex];v&&M&&(p+=ct(v,M))}p<c&&(c=p,d=h.x,l=h.y,m=u)}t.x=d,t.y=l,t.orientation=m}function wn(t,o,n,e){if(t.length===0)return[];const i=t.map(S=>({...S,orientation:Y.NORTH})),s=new Map,r=new Map,a=new Map;for(const S of i)s.set(S.id,[]),r.set(S.id,[]),a.set(S.id,0);for(const S of o)!s.has(S.targetMachineId)||!r.has(S.sourceMachineId)||(s.get(S.targetMachineId).push(S.sourceMachineId),r.get(S.sourceMachineId).push(S.targetMachineId),a.set(S.targetMachineId,(a.get(S.targetMachineId)||0)+1));const c=new Map;for(const S of i)c.set(S.id,(s.get(S.id)?.length||0)+(r.get(S.id)?.length||0));const d=i.map(S=>S.id).filter(S=>(a.get(S)||0)===0).sort((S,P)=>{const A=(c.get(P)||0)-(c.get(S)||0);return A!==0?A:S.localeCompare(P)}),l=[];for(;d.length>0;){const S=d.shift();l.push(S);for(const P of r.get(S)||[])a.set(P,(a.get(P)||0)-1),(a.get(P)||0)===0&&d.push(P);d.sort((P,A)=>{const C=(c.get(A)||0)-(c.get(P)||0);return C!==0?C:P.localeCompare(A)})}if(l.length<i.length){const S=i.map(P=>P.id).filter(P=>!l.includes(P)).sort((P,A)=>{const C=(c.get(A)||0)-(c.get(P)||0);return C!==0?C:P.localeCompare(A)});l.push(...S)}const m=new Map;for(let S=0;S<l.length;S++)m.set(l[S],S);const u=new Map;for(const S of l){let P=0;for(const A of s.get(S)||[])P=Math.max(P,(u.get(A)||0)+1);u.set(S,P)}let h=0;for(const S of u.values())S>h&&(h=S);const p=new Map(i.map(S=>[S.id,S])),f=Array.from({length:h+1},()=>[]);for(const[S,P]of u){const A=p.get(S);A&&f[P].push(A)}for(const S of f)S.sort((P,A)=>(m.get(P.id)||0)-(m.get(A.id)||0));const y=(S,P,A)=>{if(S.length===0)return A;let C=0,O=0;for(const $ of S){const X=P.get($);X!==void 0&&(C+=X,O++)}return O>0?C/O:A};for(let S=0;S<2;S++){for(let P=1;P<=h;P++){const A=new Map;f[P-1].forEach((C,O)=>A.set(C.id,O)),f[P].sort((C,O)=>{const $=y(s.get(C.id)||[],A,m.get(C.id)||0),X=y(s.get(O.id)||[],A,m.get(O.id)||0);return $-X})}for(let P=h-1;P>=0;P--){const A=new Map;f[P+1].forEach((C,O)=>A.set(C.id,O)),f[P].sort((C,O)=>{const $=y(r.get(C.id)||[],A,m.get(C.id)||0),X=y(r.get(O.id)||[],A,m.get(O.id)||0);return $-X})}}const g=1,b=1,x=2,I=3,v=f.map(S=>{let P=0;for(const A of S)P=Math.max(P,U(A).height);return P}),M=v.reduce((S,P)=>S+P,0),w=f.length,B=e-b*2-M,R=w>1&&B>=w-1?Math.min(I,Math.floor(B/(w-1))):0;let N=b;for(let S=0;S<f.length;S++){const P=f[S];if(P.length===0)continue;const A=P.reduce((nt,J)=>nt+U(J).width,0),C=P.length-1,O=C>0?Math.floor((n-g*2-A)/C):0,$=C>0&&O>=1?Math.min(x,O):0,X=A+$*C;let et=Math.max(0,Math.floor((n-X)/2));for(const nt of P){const J=U(nt);nt.x=et,nt.y=Math.max(0,Math.min(e-J.height,N)),et+=J.width+$}N+=v[S]+R}const k=new Set,G=i.slice().sort((S,P)=>S.y-P.y||S.x-P.x);for(const S of G){if(!lt(S,i,k,n,e)){const P=Math.max(0,Math.min(n-1,S.x)),A=Math.max(0,Math.min(e-1,S.y)),C=Fe(P,A,S,i,k,n,e);C&&(S.x=C.x,S.y=C.y)}k.add(S.id)}return i}function Pn(t,o,n,e){if(t.length<2)return null;const i=t.map(x=>({...x,orientation:Y.NORTH})),s=new Map,r=new Map,a=new Map;for(const x of i)s.set(x.id,[]),r.set(x.id,[]),a.set(x.id,0);for(const x of o)!s.has(x.targetMachineId)||!r.has(x.sourceMachineId)||(s.get(x.targetMachineId).push(x.sourceMachineId),r.get(x.sourceMachineId).push(x.targetMachineId),a.set(x.targetMachineId,(a.get(x.targetMachineId)||0)+1));const c=i.map(x=>x.id).filter(x=>(a.get(x)||0)===0),d=[];for(;c.length>0;){const x=c.shift();d.push(x);for(const I of r.get(x)||[])a.set(I,(a.get(I)||0)-1),(a.get(I)||0)===0&&c.push(I)}if(d.length!==i.length)return null;const l=new Map;for(const x of d){let I=0;for(const v of s.get(x)||[])I=Math.max(I,(l.get(v)||0)+1);l.set(x,I)}let m=0;for(const x of l.values())x>m&&(m=x);if(m!==1)return null;const u=new Map(i.map(x=>[x.id,x])),h=[],p=[];for(const[x,I]of l){const v=u.get(x);v&&(I===0?h.push(v):I===1&&p.push(v))}if(h.length===0||p.length===0||Me(h.length)*Me(p.length)>4e3)return null;const y=xe(h),g=xe(p);let b=null;for(const x of y)for(const I of g){const v=i.map(C=>({...C})),M=new Map(v.map(C=>[C.id,C])),w=x.map(C=>M.get(C.id)),B=I.map(C=>M.get(C.id)),R=w.reduce((C,O)=>Math.max(C,U(O).height),0),N=1,k=N+R+2;if(!zt(w,N,n)||!zt(B,k,n))continue;const G=new Set(v.map(C=>C.id));let S=!0;for(const C of v)if(!lt(C,v,G,n,e)){S=!1;break}if(!S)continue;const P=o.map(C=>({...C}));Lt(v,P,n,e);const A=gt(v,P,n,e);A&&(!b||A.score.totalScore<b.score)&&(b={machines:v.map(C=>({...C})),score:A.score.totalScore})}return b?b.machines:null}function zt(t,o,n){return Dt(t,o,n,2)}function Dt(t,o,n,e){if(t.length===0)return!0;const i=t.map(d=>U(d).width),s=i.reduce((d,l)=>d+l,0);let r=t.length>1?e:0;for(;r>0&&s+r*(t.length-1)>n;)r--;const a=s+r*(t.length-1);if(a>n)return!1;let c=Math.floor((n-a)/2);for(let d=0;d<t.length;d++)t[d].x=c,t[d].y=o,c+=i[d]+r;return!0}function Me(t){let o=1;for(let n=2;n<=t;n++)o*=n;return o}function xe(t){const o=[],n=new Array(t.length).fill(!1),e=[];function i(){if(e.length===t.length){o.push([...e]);return}for(let s=0;s<t.length;s++)n[s]||(n[s]=!0,e.push(t[s]),i(),e.pop(),n[s]=!1)}return i(),o}function Cn(t,o,n,e){const i=Tn(t,o,n,e);if(i)return i;const s=En(t,o,n,e);return s||null}function Tn(t,o,n,e){if(t.length<6)return null;const i=t.map(M=>({...M,orientation:Y.NORTH})),s=new Map(t.map((M,w)=>[M.id,w])),r=new Map,a=new Map;for(const M of i)r.set(M.id,[]),a.set(M.id,[]);for(const M of o)!r.has(M.targetMachineId)||!a.has(M.sourceMachineId)||(r.get(M.targetMachineId).push(M.sourceMachineId),a.get(M.sourceMachineId).push(M.targetMachineId));const c=i.filter(M=>(r.get(M.id)?.length||0)===0&&(a.get(M.id)?.length||0)>0),d=i.filter(M=>(r.get(M.id)?.length||0)>0&&(a.get(M.id)?.length||0)>0),l=i.filter(M=>(r.get(M.id)?.length||0)>0&&(a.get(M.id)?.length||0)===0);if(c.length===0||d.length===0||l.length===0||c.length+d.length+l.length!==i.length)return null;const m=new Set(c.map(M=>M.id)),u=new Set(d.map(M=>M.id)),h=new Set(l.map(M=>M.id));for(const M of o)if(!(m.has(M.sourceMachineId)&&u.has(M.targetMachineId))&&!(u.has(M.sourceMachineId)&&h.has(M.targetMachineId)))return null;c.sort((M,w)=>(s.get(M.id)||0)-(s.get(w.id)||0));const p=new Map(c.map((M,w)=>[M.id,w]));if(c.length===d.length&&d.length===l.length)d.sort((M,w)=>(s.get(M.id)||0)-(s.get(w.id)||0)),l.sort((M,w)=>(s.get(M.id)||0)-(s.get(w.id)||0));else{d.sort((w,B)=>{const R=Ot(r.get(w.id)||[],p,p.size),N=Ot(r.get(B.id)||[],p,p.size);return R!==N?R-N:(s.get(w.id)||0)-(s.get(B.id)||0)});const M=new Map(d.map((w,B)=>[w.id,B]));l.sort((w,B)=>{const R=Ot(r.get(w.id)||[],M,M.size),N=Ot(r.get(B.id)||[],M,M.size);return R!==N?R-N:(s.get(w.id)||0)-(s.get(B.id)||0)})}const y=Tt(c),g=Tt(d),b=Tt(l),x=1,I=x+y+2,v=I+g+2;return v+b>e||!Dt(c,x,n,1)||!Dt(d,I,n,1)||!Dt(l,v,n,1)?null:Le(i,n,e)?i:null}function En(t,o,n,e){if(t.length<8||o.length<t.length+Math.floor(t.length/3))return null;const i=t[0].type;if(t.some(M=>M.type!==i))return null;const s=t.map(M=>({...M,orientation:Y.NORTH})),r=new Map(s.map(M=>[M.id,M])),a=new Map,c=new Map,d=new Map;for(const M of s)a.set(M.id,0),c.set(M.id,0),d.set(M.id,new Map);for(const M of o){if(!r.has(M.sourceMachineId)||!r.has(M.targetMachineId))continue;c.set(M.sourceMachineId,(c.get(M.sourceMachineId)||0)+1),a.set(M.targetMachineId,(a.get(M.targetMachineId)||0)+1);const w=d.get(M.sourceMachineId);w.set(M.targetMachineId,(w.get(M.targetMachineId)||0)+1)}for(const M of s)if((a.get(M.id)||0)===0||(c.get(M.id)||0)===0)return null;const l=M=>(a.get(M)||0)+(c.get(M)||0),m=s.map(M=>M.id),u=new Set(m),h=[];let p=m[0];for(const M of m)l(M)>l(p)&&(p=M);for(;u.size>0&&(u.has(p)||(p=Array.from(u).sort((R,N)=>l(N)-l(R)||R.localeCompare(N))[0]),h.push(p),u.delete(p),u.size!==0);){const M=d.get(p);let w=null,B=-1;if(M)for(const[R,N]of M){if(!u.has(R))continue;const k=N*10+l(R);k>B&&(B=k,w=R)}w||(w=Array.from(u).sort((R,N)=>l(N)-l(R)||R.localeCompare(N))[0]),p=w}if(h.length!==s.length)return null;const f=Math.ceil(h.length/2),y=h.slice(0,f).map(M=>r.get(M)),g=h.slice(f).reverse().map(M=>r.get(M)),b=Tt(y),x=Tt(g),I=1;let v=I+b+Math.max(4,Math.floor(Math.max(b,x)*1.4));return v+x>e&&(v=e-x-1),v<=I+b||!zt(y,I,n)||!zt(g,v,n)?null:Le(s,n,e)?s:null}function Tt(t){let o=0;for(const n of t)o=Math.max(o,U(n).height);return o}function Ot(t,o,n){let e=0,i=0;for(const s of t){const r=o.get(s);r!==void 0&&(e+=r,i++)}return i>0?e/i:n}function Le(t,o,n){const e=new Set(t.map(i=>i.id));for(const i of t)if(!lt(i,t,e,o,n))return!1;return!0}function lt(t,o,n,e,i){const s=U(t);if(t.x<0||t.y<0||t.x+s.width>e||t.y+s.height>i)return!1;for(const r of o)if(!(r.id===t.id||!n.has(r.id))&&ue(t,r))return!1;return!0}function ue(t,o){const n=U(t),e=U(o);return!(t.x+n.width<=o.x||o.x+e.width<=t.x||t.y+n.height<=o.y||o.y+e.height<=t.y)}function Fe(t,o,n,e,i,s,r){for(let a=1;a<Math.max(s,r);a++)for(let c=-a;c<=a;c++)for(let d=-a;d<=a;d++)if(!(Math.abs(c)!==a&&Math.abs(d)!==a)&&(n.x=t+c,n.y=o+d,lt(n,e,i,s,r)))return{x:n.x,y:n.y};return null}function An(t){return t.slice().sort((o,n)=>o.id.localeCompare(n.id)).map(o=>`${o.id}:${o.x},${o.y},${o.orientation}`).join("|")}function be(t,o){if(t.length===0||o.length===0)return 1/0;const n=new Map(o.map(s=>[s.id,s]));let e=0,i=0;for(const s of t){const r=n.get(s.id);r&&(e+=Math.abs(s.x-r.x),e+=Math.abs(s.y-r.y),e+=s.orientation===r.orientation?0:1,i++)}return i===0?1/0:e/i}function kn(t,o,n,e){const i=t.map(r=>({...r}));let s=tt(i,o,n,e,!1);s===1/0&&(s=tt(i,o,n,e,!0));for(const r of i){const a=r.orientation;let c=a,d=s;for(const l of st){if(l===a)continue;r.orientation=l;const m=U(r);if(r.x+m.width>n||r.y+m.height>e)continue;let u=!0;for(const p of i)if(p.id!==r.id&&ue(r,p)){u=!1;break}if(!u)continue;const h=tt(i,o,n,e,!1);h<d&&(d=h,c=l)}r.orientation=c,s=d}return i}function Kt(t,o,n,e,i,s){return new Promise(r=>{let a=t.map(k=>({...k})),c=tt(a,o,n,e,i.useFastScore),d=a.map(k=>({...k})),l=c,m=i.initialTemp,u=0,h=0,p=0,f=0;const y=i.random??Math.random,g=i.operators??{largeMoveRate:.15,clusterMoveMinSize:2,clusterMoveMaxSize:4,adaptiveOps:!1,adaptiveWindow:80,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,largeMoveRateEarly:.15,largeMoveRateLate:.15,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1},b=ne(g),x=new Map;for(const k of b)x.set(k.id,{attempts:0,accepted:0,improved:0,recentGain:[]});const I=Math.max(20,g.adaptiveWindow),v=.9,M=k=>Math.max(6,k*.0125);let w=g;const B=()=>{w=Rn(g,m,i.initialTemp,i.minTemp,p,f);const k=ne(w),G=g.adaptiveOps&&u>=g.adaptiveWarmupIterations,S=k.map($=>$.baseWeight),P=k.map($=>$.minProbability);let A=S.slice();G&&(A=k.map(($,X)=>{const et=x.get($.id),nt=et?Bn(et.recentGain,v):0,J=1+Math.log1p(Math.max(0,nt));return S[X]*J}));let C=Ie(A,P,G?g.adaptiveMaxOperatorProb:1);if(G&&g.adaptiveStagnationResetWindow>0&&p>=g.adaptiveStagnationResetWindow&&g.adaptiveFlattenFactor>0){const $=Ie(S,P,1);C=C.map((X,et)=>X*(1-g.adaptiveFlattenFactor)+$[et]*g.adaptiveFlattenFactor),C=Et(C)}const O=On(C,y);return k[O]??k[k.length-1]},R=()=>!!(i.shouldStop&&i.shouldStop()||i.maxIterations!==void 0&&u>=i.maxIterations);function N(){if(R()){r(d);return}const k=l;t:for(let G=0;G<i.batchSize&&m>i.minTemp;G++){for(let S=0;S<i.iterPerTemp;S++){if(R())break t;u++;const P=B(),A=c,C=ze(a,o,n,e,y,w,P.id),O=tt(C,o,n,e,i.useFastScore),$=x.get(P.id);$.attempts++;let X=0,et=!1;if(O<1/0){const nt=O-c;if((nt<0||y()<Math.exp(-nt/m))&&(a=C,c=O,X=Math.max(0,A-O),$.accepted++,O<l)){const J=l-O;l=O,d=C.map(ft=>({...ft})),$.improved++,et=!0,g.largeMoveCooldownAfterImprove>0&&J>=M(l)&&(f=g.largeMoveCooldownAfterImprove)}}$.recentGain.push(X),$.recentGain.length>I&&$.recentGain.shift(),p=et?0:p+1,f>0&&f--}m*=i.coolingRate}if(l>=k?h++:h=0,s){const G=gt(d,o,n,e);if(G)s(G.score,u);else{const S=$e(d,o,new Map(d.map(P=>[P.id,P])));S.totalScore<1/0&&s(S,u)}}h>5&&m>i.minTemp&&(m=Math.min(i.initialTemp*.5,m*3),a=d.map(G=>({...G})),c=l,h=0),m>i.minTemp&&!R()?setTimeout(N,0):r(d)}setTimeout(N,0)})}function Rn(t,o,n,e,i,s){const r=Math.max(1e-6,n-e);let d=Math.max(0,Math.min(1,(o-e)/r))>=.45?t.largeMoveRateEarly:t.largeMoveRateLate;i>Math.max(30,Math.floor(t.adaptiveStagnationResetWindow*.6))&&(d=Math.max(d,t.largeMoveRateEarly)),s>0&&(d=0);const l=Math.max(1e-6,Math.max(t.largeMoveRate,t.criticalNetRate)),m=Math.max(0,Math.min(1,t.criticalNetRate/l)),u=d*m;return{...t,largeMoveRate:d,criticalNetRate:u}}function Bn(t,o){if(t.length===0)return 0;let n=0,e=0,i=1;for(let s=t.length-1;s>=0;s--){const r=Math.max(0,t[s]);n+=r*i,e+=i,i*=o}return e>0?n/e:0}function Et(t){if(t.length===0)return[];const o=t.map(e=>Number.isFinite(e)&&e>0?e:0),n=o.reduce((e,i)=>e+i,0);return n<=1e-12?o.map(()=>1/o.length):o.map(e=>e/n)}function Ie(t,o,n){const e=t.length;if(e===0)return[];const i=Math.max(1/e,Math.min(1,n)),s=o.map(u=>Math.max(0,Math.min(i,u))),r=s.reduce((u,h)=>u+h,0);if(r>=1-1e-9)return Et(s);const a=Et(t),c=s.slice();let d=Math.max(0,1-r),l=Array.from({length:e},(u,h)=>h).filter(u=>c[u]<i-1e-9),m=0;for(;d>1e-9&&l.length>0&&m<e*6;){m++;const u=l.reduce((g,b)=>g+a[b],0),h=u<=1e-12,p=h?l.length:u;let f=0,y=!1;for(const g of l){const b=h?1:a[g],x=d*(b/p),I=i-c[g],v=Math.min(I,x);c[g]+=v,f+=v,I-v<=1e-9&&(y=!0)}if(f<=1e-12||(d=Math.max(0,1-c.reduce((g,b)=>g+b,0)),!y))break;l=l.filter(g=>c[g]<i-1e-9)}if(d>1e-9){const u=Array.from({length:e},(h,p)=>p).filter(h=>c[h]<i-1e-9);if(u.length>0){const h=d/u.length;for(const p of u)c[p]+=Math.min(i-c[p],h)}}return Et(c)}function On(t,o){const n=Et(t),e=o();let i=0;for(let s=0;s<n.length;s++)if(i+=n[s],e<=i)return s;return Math.max(0,n.length-1)}function tt(t,o,n,e,i){for(let r=0;r<t.length;r++){const a=U(t[r]);if(t[r].x<0||t[r].y<0||t[r].x+a.width>n||t[r].y+a.height>e)return 1/0;for(let c=r+1;c<t.length;c++)if(ue(t[r],t[c]))return 1/0}const s=new Map(t.map(r=>[r.id,r]));if(i)return _t(t,o,s);{const r=Wt(t,o,n,e);if(r)return ht(r).totalScore;const a=_t(t,o,s);if(a===1/0)return 1/0;const c=pn+o.length*gn+t.length*mn;return a+c}}function _t(t,o,n){return $e(t,o,n).totalScore}function $e(t,o,n){let e=0,i=0,s=1/0,r=1/0,a=-1/0,c=-1/0;const d=(h,p)=>{s=Math.min(s,h),r=Math.min(r,p),a=Math.max(a,h),c=Math.max(c,p)},l=h=>{const p=U(h);d(h.x,h.y),d(h.x+p.width-1,h.y+p.height-1)};for(const h of t)l(h);for(const h of o){const p=n.get(h.sourceMachineId),f=n.get(h.targetMachineId);if(!p||!f)return{totalBelts:1/0,boundingBoxArea:1/0,cornerCount:1/0,totalScore:1/0};const y=F(p),g=F(f),b=y.outputs[h.sourcePortIndex],x=g.inputs[h.targetPortIndex];if(!b||!x)return{totalBelts:1/0,boundingBoxArea:1/0,cornerCount:1/0,totalScore:1/0};const I=vt(b),v=vt(x);d(I.x,I.y),d(v.x,v.y);const M=Math.abs(I.x-v.x),w=Math.abs(I.y-v.y);e+=M+w,M>0&&w>0&&i++}const m=s<=a&&r<=c?(a-s+1)*(c-r+1):0,u=e*Be+m*Oe+i*Ne;return{totalBelts:e,boundingBoxArea:m,cornerCount:i,totalScore:u}}function ne(t){const o=Math.max(0,Math.min(.6,t?.largeMoveRate??.15)),n=Math.max(0,Math.min(o,t?.criticalNetRate??0)),e=Math.max(0,o-n),i=e>1e-9?Math.min(.03,e*.35):0,s=n>1e-9?Math.min(.02,n*.35):0,r=Math.max(.05,1-o);return[{id:"move_toward_neighbor",baseWeight:.25*r,minProbability:.02},{id:"port_facing_jump",baseWeight:.15*r,minProbability:.02},{id:"random_shift",baseWeight:.15*r,minProbability:.02},{id:"swap_positions",baseWeight:.15*r,minProbability:.02},{id:"rotate_best",baseWeight:.15*r,minProbability:.02},{id:"joint_move_rotate",baseWeight:.15*r,minProbability:.02},{id:"cluster_destroy_repair",baseWeight:e,minProbability:i},{id:"critical_net_focus",baseWeight:n,minProbability:s}]}function Nn(t,o){const n=t.reduce((s,r)=>s+r.baseWeight,0),e=o()*(n||1);let i=0;for(const s of t)if(i+=s.baseWeight,e<=i)return s;return t[t.length-1]}function ze(t,o,n,e,i=Math.random,s,r){const a=t.map(h=>({...h})),c=ne(s),d=r?c.find(h=>h.id===r)??c[0]:Nn(c,i),l=Math.min(s?.clusterMoveMinSize??2,s?.clusterMoveMaxSize??5),m=Math.max(s?.clusterMoveMinSize??2,s?.clusterMoveMaxSize??5),u=Math.max(1,Math.floor(s?.repairBeamWidth??1));switch(d.id){case"move_toward_neighbor":Wn(a,o,i);break;case"port_facing_jump":Gn(a,o,n,e,i);break;case"random_shift":{const h=Math.floor(i()*a.length),p=Math.floor(i()*3)+1;switch(Math.floor(i()*4)){case 0:a[h].x+=p;break;case 1:a[h].x-=p;break;case 2:a[h].y+=p;break;case 3:a[h].y-=p;break}a[h].x=Math.max(0,Math.min(n-1,a[h].x)),a[h].y=Math.max(0,Math.min(e-1,a[h].y));break}case"swap_positions":if(a.length>1){const h=Math.floor(i()*a.length),p=(h+1+Math.floor(i()*(a.length-1)))%a.length,f=a[h].x,y=a[h].y;a[h].x=a[p].x,a[h].y=a[p].y,a[p].x=f,a[p].y=y}break;case"rotate_best":{const h=Math.floor(i()*a.length),p=new Map(a.map(g=>[g.id,g]));let f=a[h].orientation,y=1/0;for(const g of st){a[h].orientation=g;const b=U(a[h]);if(a[h].x+b.width>n||a[h].y+b.height>e)continue;let x=0;for(const I of o){if(I.sourceMachineId!==a[h].id&&I.targetMachineId!==a[h].id)continue;const v=p.get(I.sourceMachineId),M=p.get(I.targetMachineId);if(!v||!M)continue;const w=F(v).outputs[I.sourcePortIndex],B=F(M).inputs[I.targetPortIndex];w&&B&&(x+=ct(w,B))}x<y&&(y=x,f=g)}a[h].orientation=f;break}case"joint_move_rotate":{const h=Math.floor(i()*a.length),p=Math.floor(i()*2)+1;switch(Math.floor(i()*4)){case 0:a[h].x+=p;break;case 1:a[h].x-=p;break;case 2:a[h].y+=p;break;case 3:a[h].y-=p;break}a[h].x=Math.max(0,Math.min(n-1,a[h].x)),a[h].y=Math.max(0,Math.min(e-1,a[h].y)),a[h].orientation=st[Math.floor(i()*4)];break}case"cluster_destroy_repair":Se(a,o,n,e,u,i,(h,p)=>_e(h,o,n,e,l,m,p));break;case"critical_net_focus":Se(a,o,n,e,u,i,(h,p)=>Dn(h,o,n,e,l,m,p));break}return a}function _e(t,o,n,e,i,s,r,a){if(t.length<2||o.length===0)return!1;const c=new Map(t.map(f=>[f.id,f])),d=Fn(o),l=a&&a.length>0?Array.from(new Set(a.filter(f=>c.has(f)))):$n(t,d,i,s,r);if(l.length<2)return!1;const m=new Set(l),u=new Map;for(const f of l){const y=c.get(f);y&&u.set(f,{...y})}const h=new Set(t.filter(f=>!m.has(f.id)).map(f=>f.id)),p=l.slice().sort((f,y)=>{const g=ve(f,o,m);return ve(y,o,m)-g});for(const f of p){const y=c.get(f);if(!y)continue;const g=We(y,t,o,h,n,e,r);if(!g){for(const[b,x]of u){const I=c.get(b);I&&(I.x=x.x,I.y=x.y,I.orientation=x.orientation)}return!1}y.x=g.x,y.y=g.y,y.orientation=g.orientation,h.add(f)}return!0}function Se(t,o,n,e,i,s,r){const a=t.map(u=>({...u})),c=Math.max(1,Math.floor(i));let d=null,l=1/0;for(let u=0;u<c;u++){const h=a.map(g=>({...g})),p=c===1?s:De((Math.floor(s()*4294967296)>>>0^(u+1)*2654435761)>>>0);if(!r(h,p))continue;const y=tt(h,o,n,e,!1);Number.isFinite(y)&&y<l&&(l=y,d=h)}const m=d??a;for(let u=0;u<t.length&&u<m.length;u++)t[u].x=m[u].x,t[u].y=m[u].y,t[u].orientation=m[u].orientation}function Dn(t,o,n,e,i,s,r){if(t.length<2||o.length===0)return!1;const a=new Map(t.map(y=>[y.id,y])),c=o.map(y=>({connection:y,pain:Ln(y,a)})).filter(y=>Number.isFinite(y.pain)&&y.pain>0).sort((y,g)=>g.pain-y.pain);if(c.length===0)return!1;const d=Math.max(1,Math.floor(c.length*.35)),l=c[Math.floor(r()*d)].connection,m=new Map;for(const y of c.slice(0,Math.max(d,4)))m.set(y.connection.sourceMachineId,(m.get(y.connection.sourceMachineId)??0)+y.pain),m.set(y.connection.targetMachineId,(m.get(y.connection.targetMachineId)??0)+y.pain);const u=new Set([l.sourceMachineId,l.targetMachineId]),h=Math.max(2,Math.min(Math.max(2,i),Math.min(s,4))),p=Array.from(m.entries()).sort((y,g)=>g[1]-y[1]).map(([y])=>y);for(const y of p){if(u.size>=h)break;u.add(y)}if(u.size>=2&&_e(t,o,n,e,u.size,u.size,r,Array.from(u)))return!0;const f=[l.sourceMachineId,l.targetMachineId].sort((y,g)=>(m.get(g)??0)-(m.get(y)??0));for(const y of f){const g=a.get(y);if(!g)continue;const b={x:g.x,y:g.y,orientation:g.orientation},x=new Set(t.filter(v=>v.id!==y).map(v=>v.id)),I=We(g,t,o,x,n,e,r);if(I&&(g.x=I.x,g.y=I.y,g.orientation=I.orientation,I.x!==b.x||I.y!==b.y||I.orientation!==b.orientation))return!0}return!1}function Ln(t,o){const n=o.get(t.sourceMachineId),e=o.get(t.targetMachineId);if(!n||!e)return 1/0;const i=F(n).outputs[t.sourcePortIndex],s=F(e).inputs[t.targetPortIndex];if(!i||!s)return 1/0;const r=Math.abs(i.x-s.x),a=Math.abs(i.y-s.y),c=r>0&&a>0?1:0;return ct(i,s)+c*2}function ve(t,o,n){let e=0;for(const i of o)i.sourceMachineId===t&&!n.has(i.targetMachineId)&&e++,i.targetMachineId===t&&!n.has(i.sourceMachineId)&&e++;return e}function Fn(t){const o=new Map,n=(e,i)=>{o.has(e)||o.set(e,new Map);const s=o.get(e);s.set(i,(s.get(i)??0)+1)};for(const e of t)n(e.sourceMachineId,e.targetMachineId),n(e.targetMachineId,e.sourceMachineId);return o}function $n(t,o,n,e,i){if(t.length===0)return[];const s=Math.max(2,Math.min(n,t.length)),r=Math.max(s,Math.min(e,t.length)),a=s+Math.floor(i()*(r-s+1)),c=t[Math.floor(i()*t.length)].id,d=new Set([c]);for(;d.size<a;){const l=new Map;for(const p of d){const f=o.get(p);if(f)for(const[y,g]of f)d.has(y)||l.set(y,(l.get(y)??0)+g)}if(l.size===0)break;const m=Array.from(l.values()).reduce((p,f)=>p+f,0);let u=i()*(m||1),h=null;for(const[p,f]of l)if(u-=f,u<=0){h=p;break}if(h||(h=l.keys().next().value??null),!h)break;d.add(h)}return Array.from(d)}function We(t,o,n,e,i,s,r){const a=new Map(o.map(g=>[g.id,g])),c=new Set;for(const g of n)g.sourceMachineId===t.id&&e.has(g.targetMachineId)&&c.add(g.targetMachineId),g.targetMachineId===t.id&&e.has(g.sourceMachineId)&&c.add(g.sourceMachineId);const d={x:t.x,y:t.y,orientation:t.orientation};let l=d.x,m=d.y,u=d.orientation,h=1/0,p=!1;const f=(g,b,x)=>{if(t.x=g,t.y=b,t.orientation=x,!lt(t,o,e,i,s))return;const I=_n(t.id,o,n);Number.isFinite(I)&&I<h&&(h=I,l=g,m=b,u=x,p=!0)};for(const g of c){const b=a.get(g);if(!b)continue;const x=U(b);for(const I of st){t.orientation=I;const v=U(t),M=[{x:b.x,y:b.y+x.height+1},{x:b.x+Math.floor((x.width-v.width)/2),y:b.y+x.height+1},{x:b.x,y:b.y-v.height-1},{x:b.x+Math.floor((x.width-v.width)/2),y:b.y-v.height-1},{x:b.x+x.width+1,y:b.y},{x:b.x+x.width+1,y:b.y+Math.floor((x.height-v.height)/2)},{x:b.x-v.width-1,y:b.y},{x:b.x-v.width-1,y:b.y+Math.floor((x.height-v.height)/2)}];for(const w of M)f(w.x,w.y,I)}}const y=zn(c,a,d);for(let g=0;g<24;g++){const b=st[Math.floor(r()*st.length)],x=Math.round(y.x+(r()*10-5)),I=Math.round(y.y+(r()*10-5));f(x,I,b)}return f(d.x,d.y,d.orientation),t.x=d.x,t.y=d.y,t.orientation=d.orientation,p?{x:l,y:m,orientation:u}:null}function zn(t,o,n){if(t.size===0)return n;let e=0,i=0,s=0;for(const r of t){const a=o.get(r);a&&(e+=a.x,i+=a.y,s++)}return s===0?n:{x:e/s,y:i/s}}function _n(t,o,n){const e=new Map(o.map(s=>[s.id,s]));let i=0;for(const s of n){if(s.sourceMachineId!==t&&s.targetMachineId!==t)continue;const r=e.get(s.sourceMachineId),a=e.get(s.targetMachineId);if(!r||!a)continue;const c=F(r).outputs[s.sourcePortIndex],d=F(a).inputs[s.targetPortIndex];if(!c||!d)return 1/0;i+=ct(c,d)}return i}function Wn(t,o,n){const e=Math.floor(n()*t.length),i=t[e],s=new Map;for(const u of o)u.sourceMachineId===i.id&&s.set(u.targetMachineId,(s.get(u.targetMachineId)||0)+1),u.targetMachineId===i.id&&s.set(u.sourceMachineId,(s.get(u.sourceMachineId)||0)+1);if(s.size===0)return;let r=null,a=0;for(const[u,h]of s)h>a&&(a=h,r=u);if(!r)return;const c=t.find(u=>u.id===r);if(!c)return;const d=Math.sign(c.x-i.x),l=Math.sign(c.y-i.y),m=Math.floor(n()*3)+1;i.x+=d*m,i.y+=l*m}function Gn(t,o,n,e,i){const s=Math.floor(i()*t.length),r=t[s],a=new Map;for(const b of o)b.sourceMachineId===r.id&&a.set(b.targetMachineId,(a.get(b.targetMachineId)||0)+1),b.targetMachineId===r.id&&a.set(b.sourceMachineId,(a.get(b.sourceMachineId)||0)+1);if(a.size===0)return;let c=null,d=0;for(const[b,x]of a)x>d&&(d=x,c=b);if(!c)return;const l=t.find(b=>b.id===c);if(!l)return;const m=U(l),u=new Map(t.map(b=>[b.id,b])),h=new Set(t.filter(b=>b.id!==r.id).map(b=>b.id));let p=1/0,f=r.x,y=r.y,g=r.orientation;for(const b of st){r.orientation=b;const x=U(r),I=[{x:l.x,y:l.y+m.height+1},{x:l.x+Math.floor((m.width-x.width)/2),y:l.y+m.height+1},{x:l.x,y:l.y-x.height-1},{x:l.x+Math.floor((m.width-x.width)/2),y:l.y-x.height-1},{x:l.x+m.width+1,y:l.y},{x:l.x+m.width+1,y:l.y+Math.floor((m.height-x.height)/2)},{x:l.x-x.width-1,y:l.y},{x:l.x-x.width-1,y:l.y+Math.floor((m.height-x.height)/2)}];for(const v of I){if(r.x=v.x,r.y=v.y,!lt(r,t,h,n,e))continue;let M=0;for(const w of o){if(w.sourceMachineId!==r.id&&w.targetMachineId!==r.id)continue;const B=u.get(w.sourceMachineId),R=u.get(w.targetMachineId);if(!B||!R)continue;const N=F(B).outputs[w.sourcePortIndex],k=F(R).inputs[w.targetPortIndex];N&&k&&(M+=ct(N,k))}M<p&&(p=M,f=v.x,y=v.y,g=b)}}r.x=f,r.y=y,r.orientation=g}function Lt(t,o,n,e){const i=t.map(u=>({...u})),s=new Map(i.map(u=>[u.id,u])),r=o.map(u=>({...u})),a=o.map(u=>({...u})),c=new Map,d=new Map,l=a.map(u=>{const h=s.get(u.sourceMachineId),p=s.get(u.targetMachineId);if(!h||!p)return{conn:u,est:1/0};const f=F(h),y=F(p),g=f.outputs[u.sourcePortIndex],b=y.inputs[u.targetPortIndex],x=g&&b?ct(g,b):1/0;return{conn:u,est:x}});l.sort((u,h)=>h.est-u.est);for(const{conn:u}of l){const h=s.get(u.sourceMachineId),p=s.get(u.targetMachineId);if(!h||!p)continue;const f=F(h),y=F(p),g=ee(h),b=ee(p),x=c.get(h.id)||new Set,I=d.get(p.id)||new Set;let v=u.sourcePortIndex,M=u.targetPortIndex,w=1/0;for(let B=0;B<g;B++)if(!x.has(B))for(let R=0;R<b;R++){if(I.has(R))continue;const N=f.outputs[B],k=y.inputs[R];if(!N||!k)continue;const G=ct(N,k);G<w&&(w=G,v=B,M=R)}u.sourcePortIndex=v,u.targetPortIndex=M,x.add(v),I.add(M),c.set(h.id,x),d.set(p.id,I)}const m=Hn(i,r,a,n,e);return o.length=0,o.push(...m.map(u=>({...u}))),i}function Hn(t,o,n,e,i){const s=gt(t,o,e,i),r=gt(t,n,e,i);if(s&&r)return r.score.totalScore<=s.score.totalScore?n:o;if(r)return n;if(s)return o;const a=new Map(t.map(l=>[l.id,l])),c=_t(t,o,a);return _t(t,n,a)<=c?n:o}function Un(t,o,n,e){const i=t.map(f=>({...f})),s=tt(i,o,n,e,!1),r=i.map(f=>({...f})),a=new Set(r.map(f=>f.id));let c=1/0,d=1/0;for(const f of r)c=Math.min(c,f.x),d=Math.min(d,f.y);const l=c-1,m=d-1;for(const f of r)f.x-=l,f.y-=m;let u=!0,h=0;for(;u&&h<30;){u=!1,h++,r.sort((f,y)=>f.x+f.y-(y.x+y.y));for(const f of r){for(;f.x>0;){if(f.x--,!lt(f,r,a,n,e)){f.x++;break}u=!0}for(;f.y>0;){if(f.y--,!lt(f,r,a,n,e)){f.y++;break}u=!0}}}return tt(r,o,n,e,!1)<=s?r:i}function Wt(t,o,n,e){const i=ce(n,e);for(const s of t)if(!mt(i,s))return null;for(const s of o)i.connections.set(s.id,s);for(const s of o){const r=i.machines.get(s.sourceMachineId),a=i.machines.get(s.targetMachineId);if(!r||!a)return null;const c=F(r),d=F(a),l=c.outputs[s.sourcePortIndex],m=d.inputs[s.targetPortIndex];if(!l||!m)return null;const u=Ht(i,l,m,s.id);if(!u)return null;Ut(i,u)}return i}function gt(t,o,n,e){const i=Wt(t,o,n,e);return i?{grid:i,score:ht(i)}:null}const q={place:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',select:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 9l2-2 3 3L18 2"/><rect x="3" y="3" width="18" height="18" rx="2"/></svg>',connect:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="5" cy="12" r="3"/><circle cx="19" cy="12" r="3"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',delete:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',rotate:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>',optimize:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',search:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',stop:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>',save:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',folder:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>'},At=50;let E=ce(At,At),ot=null,kt=Ct.M3x3,yt="place",Zt=!1,Gt=!1,It=!1;const Yn=2200,jn=12e4,we=1e-6;let Pt=[],it=null,he=!1,Ge=0,He=0,oe=0,ie=0,fe=!1,Ue=0,Ye=0,je=0,Xe=0,wt=Y.NORTH,re=0,se=0;const Xn=document.getElementById("app");Xn.innerHTML=`
  <div id="toolbar">
    <div class="toolbar-group">
      <span class="toolbar-label">Mode</span>
      <button id="btn-place" class="tool-btn active" data-mode="place" title="Place Machine">
        <span class="icon">${q.place}</span> Place <kbd>P</kbd>
      </button>
      <button id="btn-select" class="tool-btn" data-mode="select" title="Select/Move">
        <span class="icon">${q.select}</span> Select <kbd>S</kbd>
      </button>
      <button id="btn-connect" class="tool-btn" data-mode="connect" title="Connect Ports">
        <span class="icon">${q.connect}</span> Connect <kbd>C</kbd>
      </button>
      <button id="btn-delete" class="tool-btn" data-mode="delete" title="Delete">
        <span class="icon">${q.delete}</span> Delete <kbd>D</kbd>
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <span class="toolbar-label">Machine</span>
      <button id="btn-3x3" class="type-btn active" data-type="3x3">3Ã—3 <kbd>1</kbd></button>
      <button id="btn-5x3" class="type-btn" data-type="5x3">5Ã—3 <kbd>2</kbd></button>
      <button id="btn-5x5" class="type-btn" data-type="5x5">5Ã—5 <kbd>3</kbd></button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <button id="btn-rotate" class="tool-btn" title="Rotate">
        <span class="icon">${q.rotate}</span> Rotate <kbd>R</kbd>
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <button id="btn-optimize" class="tool-btn optimize-btn" title="Auto-Arrange">
        <span class="icon">${q.optimize}</span> Optimize <kbd>O</kbd>
      </button>
      <button id="btn-search-deeper" class="tool-btn deep-search-btn" title="Run longer optimizer search">
        <span class="icon">${q.search}</span> Search Deeper
      </button>
      <button id="btn-stop-search" class="tool-btn stop-search-btn" title="Stop continuous deep search" disabled>
        <span class="icon">${q.stop}</span> Stop
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <span class="toolbar-label">File</span>
      <button id="btn-export" class="tool-btn" title="Export Layout">
        <span class="icon">${q.save}</span> Export
      </button>
      <button id="btn-import" class="tool-btn" title="Import Layout">
        <span class="icon">${q.folder}</span> Import
      </button>
      <input type="file" id="import-file" accept=".json" style="display:none" />
    </div>
    <div class="toolbar-divider"></div>
    <div id="score-panel">
      <span id="score-belts">Belts: 0</span>
      <span id="score-area">Area: 0</span>
      <span id="score-corners">Corners: 0</span>
      <span id="score-total">Score: 0</span>
    </div>
  </div>
  <div id="status-bar">
    <span id="status-text">Place mode â€” Click grid to place a machine</span>
    <span id="coord-text">0, 0</span>
  </div>
  <div id="canvas-container">
    <canvas id="grid-canvas"></canvas>
  </div>
`;const dt=document.getElementById("grid-canvas"),W=document.getElementById("status-text"),qn=document.getElementById("coord-text"),z=new cn(dt);z.camera.x=40;z.camera.y=60;const qe=document.querySelectorAll(".tool-btn[data-mode]");qe.forEach(t=>{t.addEventListener("click",()=>{St(t.dataset.mode)})});function St(t){yt=t,it=null,z.setGhost(null),qe.forEach(o=>o.classList.toggle("active",o.dataset.mode===yt)),Yt(),Q()}const Je=document.querySelectorAll(".type-btn");Je.forEach(t=>{t.addEventListener("click",()=>{Ft(t.dataset.type)})});function Ft(t){kt=t,Je.forEach(o=>o.classList.toggle("active",o.dataset.type===t)),St("place")}document.getElementById("btn-rotate").addEventListener("click",()=>{Ke()});document.getElementById("btn-optimize").addEventListener("click",()=>{pe("normal")});document.getElementById("btn-search-deeper").addEventListener("click",()=>{pe("deep")});document.getElementById("btn-stop-search").addEventListener("click",()=>{Qe()});const $t=document.getElementById("import-file");document.getElementById("btn-export").addEventListener("click",()=>{Jn()});document.getElementById("btn-import").addEventListener("click",()=>{$t.click()});$t.addEventListener("change",()=>{const t=$t.files?.[0];if(!t)return;const o=new FileReader;o.onload=()=>{Vn(o.result),$t.value=""},o.readAsText(t)});function Jn(){const t={version:1,gridSize:At,machines:Array.from(E.machines.values()),connections:Array.from(E.connections.values())},o=JSON.stringify(t,null,2),n=new Blob([o],{type:"application/json"}),e=URL.createObjectURL(n),i=document.createElement("a");i.href=e,i.download=`factory-layout-${Date.now()}.json`,i.click(),URL.revokeObjectURL(e),W.textContent=`Exported ${E.machines.size} machines, ${E.connections.size} connections`}function Vn(t){try{const o=JSON.parse(t);if(!o.machines||!o.connections){W.textContent="Invalid layout file â€” missing machines or connections";return}E=ce(At,At),ot=null,z.setSelectedMachine(null);for(const n of o.machines)mt(E,{...n});for(const n of o.connections){E.connections.set(n.id,n);const e=E.machines.get(n.sourceMachineId),i=E.machines.get(n.targetMachineId);if(!e||!i)continue;const s=F(e),r=F(i),a=s.outputs[n.sourcePortIndex],c=r.inputs[n.targetPortIndex];if(!a||!c)continue;const d=Ht(E,a,c,n.id);d&&Ut(E,d)}Mt(),Q(),W.textContent=`Imported ${o.machines.length} machines, ${o.connections.length} connections`}catch{W.textContent="Failed to import â€” invalid JSON file"}}document.addEventListener("keydown",t=>{if(!(t.target instanceof HTMLInputElement))switch(t.key.toLowerCase()){case"p":St("place");break;case"s":St("select");break;case"c":St("connect");break;case"d":St("delete");break;case"r":yt==="place"?eo():Ke();break;case"o":pe(t.shiftKey?"deep":"normal");break;case"1":Ft(Ct.M3x3);break;case"2":Ft(Ct.M5x3);break;case"3":Ft(Ct.M5x5);break;case"escape":if(Gt){Qe();break}ot=null,it=null,z.setSelectedMachine(null),z.setGhost(null),Yt(),Q();break}});dt.addEventListener("mousedown",t=>{const o=dt.getBoundingClientRect(),n=t.clientX-o.left,e=t.clientY-o.top;if(t.button===1||t.button===2){fe=!0,Ue=t.clientX,Ye=t.clientY,je=z.camera.x,Xe=z.camera.y,t.preventDefault();return}const{gx:i,gy:s}=z.screenToGrid(n,e);switch(yt){case"place":Kn(i,s);break;case"select":Zn(i,s,t);break;case"connect":Qn(i,s);break;case"delete":to(i,s);break}});dt.addEventListener("mousemove",t=>{const o=dt.getBoundingClientRect(),n=t.clientX-o.left,e=t.clientY-o.top,{gx:i,gy:s}=z.screenToGrid(n,e);if(qn.textContent=`${i}, ${s}`,fe){z.camera.x=je+(t.clientX-Ue),z.camera.y=Xe+(t.clientY-Ye),Q();return}if(yt==="place"&&(re=i,se=s,Ve(),Q()),he&&ot){const r=E.machines.get(ot);if(!r)return;const a=32*z.camera.zoom,c=Math.round((t.clientX-Ge)/a),d=Math.round((t.clientY-He)/a),l=oe+c,m=ie+d;(l!==r.x||m!==r.y)&&(de(E,r.id),Ze(r.id),r.x=l,r.y=m,mt(E,r)||(r.x=oe,r.y=ie,mt(E,r)),ae(r.id),Q())}});dt.addEventListener("mouseup",()=>{he=!1,fe=!1});dt.addEventListener("wheel",t=>{t.preventDefault();const o=dt.getBoundingClientRect(),n=t.clientX-o.left,e=t.clientY-o.top,i=z.camera.zoom,s=t.deltaY>0?.9:1.1;z.camera.zoom=Math.max(.3,Math.min(3,z.camera.zoom*s)),z.camera.x=n-(n-z.camera.x)*(z.camera.zoom/i),z.camera.y=e-(e-z.camera.y)*(z.camera.zoom/i),Q()},{passive:!1});dt.addEventListener("contextmenu",t=>t.preventDefault());function Kn(t,o){const n={id:ke(),type:kt,x:t,y:o,orientation:wt};mt(E,n)&&(ot=n.id,z.setSelectedMachine(n.id),Mt(),Q())}function Zn(t,o,n){const e=E.cells[o]?.[t];if(e?.machineId){ot=e.machineId,z.setSelectedMachine(e.machineId),he=!0,Ge=n.clientX,He=n.clientY;const i=E.machines.get(e.machineId);oe=i.x,ie=i.y}else ot=null,z.setSelectedMachine(null);Yt(),Q()}function Qn(t,o){const n=no(t,o);if(!n){W.textContent="No port at this position";return}if(!it){if(n.portType!=="OUTPUT"){W.textContent="Click an OUTPUT port (orange) first";return}if(Pe(n.machineId,n.index,"output")){W.textContent="This output port already has a connection";return}it=n,W.textContent=`Selected output port ${n.index} â€” Now click an INPUT port`;return}if(n.portType!=="INPUT"){W.textContent="Click an INPUT port (blue) to complete the connection";return}if(n.machineId===it.machineId){W.textContent="Cannot connect a machine to itself";return}if(Pe(n.machineId,n.index,"input")){W.textContent="This input port already has a connection",it=null;return}const e={id:ke(),sourceMachineId:it.machineId,sourcePortIndex:it.index,targetMachineId:n.machineId,targetPortIndex:n.index};E.connections.set(e.id,e);const i=Ht(E,it,n,e.id);i?(Ut(E,i),W.textContent=`Connected! Belt length: ${i.segments.length}`):(W.textContent="No path found between these ports!",E.connections.delete(e.id)),it=null,Mt(),Q()}function to(t,o){const n=E.cells[o]?.[t];if(n&&n.machineId){const e=n.machineId,i=[];for(const[s,r]of E.connections)(r.sourceMachineId===e||r.targetMachineId===e)&&i.push(s);for(const s of i)Re(E,s),E.connections.delete(s);de(E,e),ot===e&&(ot=null,z.setSelectedMachine(null)),Mt(),Q()}}function Ve(){if(yt!=="place"){z.setGhost(null);return}const o=le(E,{type:kt,x:re,y:se,orientation:wt});z.setGhost({gx:re,gy:se,type:kt,orientation:wt,valid:o})}function eo(){const t=[Y.NORTH,Y.EAST,Y.SOUTH,Y.WEST],o=t.indexOf(wt);wt=t[(o+1)%4],Ve(),Yt(),Q()}function no(t,o){for(const n of E.machines.values()){const{inputs:e,outputs:i}=F(n);for(const s of[...e,...i])if(s.x===t&&s.y===o)return s}return null}function Pe(t,o,n){for(const e of E.connections.values())if(n==="input"&&e.targetMachineId===t&&e.targetPortIndex===o||n==="output"&&e.sourceMachineId===t&&e.sourcePortIndex===o)return!0;return!1}function Ke(){if(!ot)return;const t=E.machines.get(ot);if(!t)return;const o=[Y.NORTH,Y.EAST,Y.SOUTH,Y.WEST],n=o.indexOf(t.orientation),e=o[(n+1)%4];de(E,t.id),Ze(t.id),t.orientation=e,le(E,t)?(mt(E,t),ae(t.id)):(t.orientation=o[n],mt(E,t),ae(t.id)),Mt(),Q()}function Ze(t){for(const[o,n]of E.connections)(n.sourceMachineId===t||n.targetMachineId===t)&&Re(E,o)}function ae(t){for(const[o,n]of E.connections)if(n.sourceMachineId===t||n.targetMachineId===t){const e=E.machines.get(n.sourceMachineId),i=E.machines.get(n.targetMachineId);if(!e||!i)continue;const s=F(e),r=F(i),a=s.outputs[n.sourcePortIndex],c=r.inputs[n.targetPortIndex];if(!a||!c)continue;const d=Ht(E,a,c,o);d&&Ut(E,d)}}async function pe(t="normal"){if(Zt)return;if(E.machines.size===0){W.textContent="No machines to optimize!";return}const o=document.getElementById("btn-optimize"),n=document.getElementById("btn-search-deeper"),e=document.getElementById("btn-stop-search"),i=ht(E).totalScore,s=t==="deep";s&&(Pt=[]),Zt=!0,Gt=s,It=!1,o.disabled=!0,n.disabled=!0,e.disabled=!s,o.innerHTML=s?`${q.optimize} Optimize`:`${q.optimize} Optimizing...`,n.innerHTML=s?`${q.search} Searching...`:`${q.search} Search Deeper`,e.innerHTML=`${q.stop} Stop`,W.textContent=s?"Search Deeper started â€” running continuously from current layout...":"Running optimizer...";try{if(!s){const p=await ge(E,{mode:"normal"},(f,y,g)=>{W.textContent=`${g} â€” iter ${y} | belts: ${f.totalBelts} | area: ${f.boundingBoxArea} | score: ${f.totalScore.toFixed(1)}`});E=p.grid,Mt(),W.textContent=`Optimization complete! ${p.iterations} iterations, score: ${p.score.totalScore.toFixed(1)}`,Q();return}const r=performance.now();let a=r,c=i,d=0,l=0,m=!1;for(;!It;){l++;const p=l,f={mode:"deep",timeBudgetMs:Yn,useExplorationSeeds:!0,phase1Restarts:2,phase2Attempts:2,localPolishPasses:2,persistEliteArchive:!0,incomingEliteArchive:Pt,adaptiveWarmupIterations:100,adaptiveMaxOperatorProb:.45,adaptiveStagnationResetWindow:160,adaptiveFlattenFactor:.55,largeMoveRate:.02,largeMoveRateEarly:.03,largeMoveRateLate:.005,largeMoveCooldownAfterImprove:70,criticalNetRate:.005,repairBeamWidth:1},y=await ge(E,f,(x,I,v)=>{const M=performance.now()-r,w=performance.now()-a,B=Math.min(c,x.totalScore);W.textContent=`Search Deeper #${p} â€” ${v} iter ${I} | best ${B.toFixed(1)} | elapsed ${pt(M)} | idle ${pt(w)}`});d+=y.iterations,E=y.grid,Mt(),Q(),Pt=oo(f.outgoingEliteArchive)??Pt,y.score.totalScore+we<c&&(c=y.score.totalScore,a=performance.now());const g=performance.now()-r,b=performance.now()-a;if(b>=jn){m=!0;break}W.textContent=`Search Deeper cycle ${p} complete | best ${c.toFixed(1)} | elapsed ${pt(g)} | idle ${pt(b)} | continuing...`}const u=performance.now()-r,h=c+we<i;m?W.textContent=h?`Search Deeper auto-stopped (plateau) â€” improved ${i.toFixed(1)} â†’ ${c.toFixed(1)} in ${pt(u)}`:`Search Deeper auto-stopped (plateau) â€” no improvement after ${pt(u)} (best ${c.toFixed(1)})`:It?W.textContent=h?`Search Deeper stopped â€” improved ${i.toFixed(1)} â†’ ${c.toFixed(1)} in ${pt(u)}`:`Search Deeper stopped â€” no better layout found (best ${c.toFixed(1)})`:W.textContent=h?`Search Deeper complete â€” improved ${i.toFixed(1)} â†’ ${c.toFixed(1)} in ${d} iterations`:`Search Deeper complete â€” no better layout found (score ${c.toFixed(1)})`}catch(r){console.error(r),W.textContent=s?"Search Deeper failed":"Optimization failed"}finally{Zt=!1,Gt=!1,It=!1,Pt=[],o.disabled=!1,n.disabled=!1,e.disabled=!0,o.innerHTML=`${q.optimize} Optimize`,n.innerHTML=`${q.search} Search Deeper`,e.innerHTML=`${q.stop} Stop`}}function Qe(){if(!Gt||It)return;It=!0;const t=document.getElementById("btn-stop-search");t.disabled=!0,t.innerHTML=`${q.stop} Stopping...`,W.textContent="Stopping Search Deeper after current chunk..."}function pt(t){const o=Math.max(0,Math.floor(t/1e3)),n=Math.floor(o/60),e=o%60;return`${n}:${e.toString().padStart(2,"0")}`}function oo(t){if(!Array.isArray(t))return null;const o=[];for(const n of t){if(!n||typeof n!="object")continue;const e=n.machines,i=n.connections;!Array.isArray(e)||!Array.isArray(i)||o.push({machines:e,connections:i})}return o}function Mt(){const t=ht(E);document.getElementById("score-belts").textContent=`Belts: ${t.totalBelts}`,document.getElementById("score-area").textContent=`Area: ${t.boundingBoxArea}`,document.getElementById("score-corners").textContent=`Corners: ${t.cornerCount}`,document.getElementById("score-total").textContent=`Score: ${t.totalScore.toFixed(1)}`}function Yt(){switch(yt){case"place":W.textContent=`Place mode â€” ${kt} [${wt}] â€” R to rotate, click to place`;break;case"select":W.textContent=ot?"Selected machine â€” Drag to move, R to rotate":"Select mode â€” Click a machine to select it";break;case"connect":W.textContent=it?"Click an INPUT port (blue) to complete the connection":"Connect mode â€” Click an OUTPUT port (orange) to start";break;case"delete":W.textContent="Delete mode â€” Click a machine to delete it";break}}let Qt=!1;function Q(){Qt||(Qt=!0,requestAnimationFrame(()=>{z.render(E),Qt=!1}))}Q();</script>
  <style rel="stylesheet" crossorigin>@import"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap";*{margin:0;padding:0;box-sizing:border-box}:root{--bg-primary: #0f0f1a;--bg-secondary: #1a1a2e;--bg-tertiary: #252542;--accent-primary: #5b57d1;--accent-hover: #7b78e8;--accent-glow: rgba(91, 87, 209, .3);--text-primary: #e0e0ff;--text-secondary: #9090b0;--text-muted: #606080;--border-color: #303060;--success: #7bc950;--warning: #ffd166;--danger: #e05656;--info: #5bc0eb;--radius: 8px;--toolbar-height: 52px;--status-height: 32px}html,body{width:100%;height:100%;overflow:hidden;background:var(--bg-primary);color:var(--text-primary);font-family:Inter,system-ui,-apple-system,sans-serif}#app{width:100%;height:100%;display:flex;flex-direction:column}#toolbar{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);height:var(--toolbar-height);flex-shrink:0;z-index:10}.toolbar-group{display:flex;align-items:center;gap:4px}.toolbar-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-right:4px}.toolbar-divider{width:1px;height:28px;background:var(--border-color);margin:0 4px}.tool-btn{display:flex;align-items:center;gap:4px;padding:6px 12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius);color:var(--text-secondary);font-family:Inter,sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s ease;white-space:nowrap}.tool-btn:hover{background:var(--accent-primary);color:#fff;border-color:var(--accent-hover)}.tool-btn.active{background:var(--accent-primary);color:#fff;border-color:var(--accent-hover);box-shadow:0 0 12px var(--accent-glow)}.tool-btn:disabled{opacity:.5;cursor:not-allowed}.tool-btn .icon{display:inline-flex;align-items:center;vertical-align:middle}.tool-btn .icon svg,.tool-btn svg{display:inline-block;vertical-align:middle}.tool-btn kbd,.type-btn kbd{display:inline-block;padding:1px 5px;margin-left:4px;font-family:JetBrains Mono,monospace;font-size:10px;font-weight:600;line-height:1.4;color:var(--text-muted);background:#ffffff0f;border:1px solid rgba(255,255,255,.1);border-radius:3px;vertical-align:baseline}.tool-btn.active kbd,.type-btn.active kbd{color:#fff9;background:#ffffff1a;border-color:#ffffff26}.optimize-btn{background:linear-gradient(135deg,#2d6b3f,#1a4a2d);border-color:#3d8b4f}.optimize-btn:hover{background:linear-gradient(135deg,#3d8b4f,#2d6b3f);border-color:#4dab5f;box-shadow:0 0 16px #3d8b4f66}.deep-search-btn{background:linear-gradient(135deg,#2a5f85,#1a3d57);border-color:#3a7ca8}.deep-search-btn:hover{background:linear-gradient(135deg,#3a7ca8,#2a5f85);border-color:#4e95c8;box-shadow:0 0 16px #3a7ca866}.stop-search-btn{background:linear-gradient(135deg,#8c2e35,#641f24);border-color:#ad3c45}.stop-search-btn:hover{background:linear-gradient(135deg,#ad3c45,#8c2e35);border-color:#c94f58;box-shadow:0 0 16px #ad3c4566}.type-btn{padding:6px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius);color:var(--text-secondary);font-family:JetBrains Mono,monospace;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s ease}.type-btn:hover{border-color:var(--info);color:var(--info)}.type-btn.active{background:#5bc0eb26;border-color:var(--info);color:var(--info);box-shadow:0 0 10px #5bc0eb33}#score-panel{display:flex;align-items:center;gap:12px;margin-left:auto;font-family:JetBrains Mono,monospace;font-size:11px;color:var(--text-secondary)}#score-panel span{padding:4px 8px;background:var(--bg-tertiary);border-radius:4px;border:1px solid var(--border-color)}#score-total{color:var(--warning)!important;border-color:#ffd1664d!important;font-weight:600}#status-bar{display:flex;align-items:center;justify-content:space-between;padding:4px 12px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-color);height:var(--status-height);flex-shrink:0;font-size:12px}#status-text{color:var(--text-secondary)}#coord-text{font-family:JetBrains Mono,monospace;color:var(--text-muted);font-size:11px}#canvas-container{flex:1;overflow:hidden;position:relative;cursor:crosshair}#grid-canvas{display:block;width:100%;height:100%}</style>
</head>

<body>
  <div id="app"></div>
</body>

</html>