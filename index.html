<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Factory Grid Simulator - Place machines, connect with belts, and optimize layouts" />
  <title>Factory Grid Simulator</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš™</text></svg>" />
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();var Pt=(t=>(t.M3x3="3x3",t.M6x4="6x4",t.M5x5="5x5",t.M3x1="3x1",t))(Pt||{}),z=(t=>(t.NORTH="NORTH",t.EAST="EAST",t.SOUTH="SOUTH",t.WEST="WEST",t))(z||{}),Kt=(t=>(t.INPUT="INPUT",t.OUTPUT="OUTPUT",t))(Kt||{}),it=(t=>(t.EMPTY="EMPTY",t.MACHINE="MACHINE",t.BELT="BELT",t))(it||{}),nt=(t=>(t.UP="UP",t.DOWN="DOWN",t.LEFT="LEFT",t.RIGHT="RIGHT",t))(nt||{});const Tn={"3x3":{baseWidth:3,baseHeight:3},"6x4":{baseWidth:6,baseHeight:4},"5x5":{baseWidth:5,baseHeight:5},"3x1":{baseWidth:3,baseHeight:1}};function _(t){const e=Tn[t.type];return t.orientation==="EAST"||t.orientation==="WEST"?{width:e.baseHeight,height:e.baseWidth}:{width:e.baseWidth,height:e.baseHeight}}function Ve(t){if(typeof t!="string")return null;switch(t){case"3x3":return"3x3";case"6x4":case"5x3":return"6x4";case"5x5":return"5x5";case"3x1":return"3x1";default:return null}}function An(t){return t==="3x1"}function Me(t){switch(t.type){case"3x1":return 0;case"3x3":return 3;case"6x4":return 6;case"5x5":return 5}}function be(t){switch(t.type){case"3x1":return 1;case"3x3":return 3;case"6x4":return 6;case"5x5":return 5}}function Ke(t){switch(t){case"UP":return"DOWN";case"DOWN":return"UP";case"LEFT":return"RIGHT";case"RIGHT":return"LEFT"}}function Ze(t){switch(t){case"UP":return{dx:0,dy:-1};case"DOWN":return{dx:0,dy:1};case"LEFT":return{dx:-1,dy:0};case"RIGHT":return{dx:1,dy:0}}}function Ie(t){switch(t){case"NORTH":return"UP";case"EAST":return"RIGHT";case"SOUTH":return"DOWN";case"WEST":return"LEFT"}}function kn(t){return Ke(Ie(t))}let En=1;function Qe(){return`id_${En++}`}function ve(t,e){const n=[];for(let o=0;o<e;o++){n[o]=[];for(let i=0;i<t;i++)n[o][i]={type:it.EMPTY,beltConnectionIds:[]}}return{width:t,height:e,cells:n,machines:new Map,connections:new Map,beltPaths:new Map,beltTileUsage:new Map}}function Xt(t,e,n){return e>=0&&n>=0&&e<t.width&&n<t.height}function Se(t,e,n){const{width:o,height:i}=_(e);for(let r=0;r<i;r++)for(let a=0;a<o;a++){const c=e.x+a,s=e.y+r;if(!Xt(t,c,s))return!1;const l=t.cells[s][c];if(l.type===it.MACHINE&&l.machineId!==n)return!1}return!0}function Tt(t,e){if(!Se(t,e))return!1;const{width:n,height:o}=_(e);for(let i=0;i<o;i++)for(let r=0;r<n;r++){const a=e.x+r,c=e.y+i;t.cells[c][a]={type:it.MACHINE,machineId:e.id,beltConnectionIds:[]}}return t.machines.set(e.id,e),!0}function we(t,e){const n=t.machines.get(e);if(!n)return;const{width:o,height:i}=_(n);for(let r=0;r<i;r++)for(let a=0;a<o;a++){const c=n.x+a,s=n.y+r;t.cells[s][c]={type:it.EMPTY,beltConnectionIds:[]}}t.machines.delete(e)}function L(t){if(t.type===Pt.M3x1)return Rn(t);const{width:e,height:n}=_(t),o=Me(t),i=be(t),r=t.orientation===z.NORTH||t.orientation===z.SOUTH?e:n,a=De(o,r),c=De(i,r),s=Ie(t.orientation),l=kn(t.orientation),f=s,M=l,u=[],y=[];for(let g=0;g<a.length;g++){const p=a[g];let b,d;switch(t.orientation){case z.NORTH:b=t.x+p,d=t.y;break;case z.SOUTH:b=t.x+p,d=t.y+n-1;break;case z.EAST:b=t.x+e-1,d=t.y+p;break;case z.WEST:b=t.x,d=t.y+p;break}u.push({machineId:t.id,portType:Kt.INPUT,index:g,x:b,y:d,approachDirection:f})}for(let g=0;g<c.length;g++){const p=c[g];let b,d;switch(t.orientation){case z.NORTH:b=t.x+p,d=t.y+n-1;break;case z.SOUTH:b=t.x+p,d=t.y;break;case z.EAST:b=t.x,d=t.y+p;break;case z.WEST:b=t.x+e-1,d=t.y+p;break}y.push({machineId:t.id,portType:Kt.OUTPUT,index:g,x:b,y:d,approachDirection:M})}return{inputs:u,outputs:y}}function Rn(t){const{width:e,height:n}=_(t),o=Ie(t.orientation),i=t.x+Math.floor((e-1)/2),r=t.y+Math.floor((n-1)/2);let a=i,c=r;switch(o){case nt.UP:c=t.y;break;case nt.DOWN:c=t.y+n-1;break;case nt.LEFT:a=t.x;break;case nt.RIGHT:a=t.x+e-1;break}return{inputs:[],outputs:[{machineId:t.id,portType:Kt.OUTPUT,index:0,x:a,y:c,approachDirection:o}]}}function De(t,e){if(t<=0)return[];if(t===1)return[Math.floor((e-1)/2)];if(t>=e)return Array.from({length:t},(o,i)=>Math.min(e-1,i));const n=(e-1)/(t-1);return Array.from({length:t},(o,i)=>Math.round(i*n))}function Bt(t){const e=Ze(t.approachDirection);return{x:t.x+e.dx,y:t.y+e.dy}}function ae(t){const e=[];for(let n=0;n<t.height;n++){e[n]=[];for(let o=0;o<t.width;o++){const i=t.cells[n][o];e[n][o]={type:i.type,machineId:i.machineId,beltConnectionIds:[...i.beltConnectionIds]}}}return{width:t.width,height:t.height,cells:e,machines:new Map(Array.from(t.machines.entries()).map(([n,o])=>[n,{...o}])),connections:new Map(Array.from(t.connections.entries()).map(([n,o])=>[n,{...o}])),beltPaths:new Map(Array.from(t.beltPaths.entries()).map(([n,o])=>[n,{connectionId:o.connectionId,segments:o.segments.map(i=>({...i}))}])),beltTileUsage:new Map(Array.from(t.beltTileUsage.entries()).map(([n,o])=>[n,{horizontalCount:o.horizontalCount,verticalCount:o.verticalCount,cornerCount:o.cornerCount}]))}}class On{heap=[];comparator;constructor(e){this.comparator=e}get size(){return this.heap.length}push(e){this.heap.push(e),this.bubbleUp(this.heap.length-1)}pop(){if(this.heap.length===0)return;const e=this.heap[0],n=this.heap.pop();return this.heap.length>0&&(this.heap[0]=n,this.sinkDown(0)),e}peek(){return this.heap[0]}bubbleUp(e){for(;e>0;){const n=e-1>>1;if(this.comparator(this.heap[e],this.heap[n])<0)[this.heap[e],this.heap[n]]=[this.heap[n],this.heap[e]],e=n;else break}}sinkDown(e){const n=this.heap.length;for(;;){let o=e;const i=2*e+1,r=2*e+2;if(i<n&&this.comparator(this.heap[i],this.heap[o])<0&&(o=i),r<n&&this.comparator(this.heap[r],this.heap[o])<0&&(o=r),o!==e)[this.heap[e],this.heap[o]]=[this.heap[o],this.heap[e]],e=o;else break}}}function Gt(t,e,n,o){return Math.abs(t-n)+Math.abs(e-o)}function ce(t,e,n){return`${t},${e},${n??"NONE"}`}function Pe(t,e){return`${t},${e}`}const Bn=[nt.UP,nt.DOWN,nt.LEFT,nt.RIGHT];function Ct(t){return t===nt.LEFT||t===nt.RIGHT?"H":"V"}function tn(t){return t.fromDirection===null||t.toDirection===null?!1:Ct(t.fromDirection)!==Ct(t.toDirection)}function en(t){if(t.fromDirection!==null&&t.toDirection!==null){const e=Ct(t.fromDirection),n=Ct(t.toDirection);return e===n?e:null}return t.fromDirection!==null?Ct(t.fromDirection):t.toDirection!==null?Ct(t.toDirection):null}function nn(){return{cornerCount:0,horizontalCount:0,verticalCount:0}}function Nn(t,e){if(tn(e)){t.cornerCount++;return}const n=en(e);n==="H"&&t.horizontalCount++,n==="V"&&t.verticalCount++}function Dn(t){const e=new Map;if(!t)return e;for(const n of t.segments){const o=Pe(n.x,n.y);let i=e.get(o);i||(i=nn(),e.set(o,i)),Nn(i,n)}return e}function Yt(t,e,n,o){const i=Pe(n,o),r=t.beltTileUsage.get(i),a=e.get(i),c=(r?.cornerCount??0)-(a?.cornerCount??0),s=(r?.horizontalCount??0)-(a?.horizontalCount??0),l=(r?.verticalCount??0)-(a?.verticalCount??0);return c<=0&&s<=0&&l<=0?null:{cornerCount:c,horizontalCount:s,verticalCount:l}}function Fe(t,e){return e==="H"?t.horizontalCount>0:t.verticalCount>0}function oe(t,e,n,o){const i=Bt(e),r=Bt(n);if(!Xt(t,i.x,i.y)||!Xt(t,r.x,r.y)||t.cells[i.y][i.x].type===it.MACHINE||t.cells[r.y][r.x].type===it.MACHINE)return null;const a=Dn(t.beltPaths.get(o)),c=Yt(t,a,i.x,i.y),s=Yt(t,a,r.x,r.y);if((c?.cornerCount??0)>0||(s?.cornerCount??0)>0)return null;const l=e.approachDirection,f=new On((g,p)=>g.f-p.f),M=new Set,u=new Map,y={x:i.x,y:i.y,g:0,h:Gt(i.x,i.y,r.x,r.y),f:Gt(i.x,i.y,r.x,r.y),parent:null,direction:l};for(f.push(y),u.set(ce(i.x,i.y,l),0);f.size>0;){const g=f.pop(),p=ce(g.x,g.y,g.direction);if(g.x===r.x&&g.y===r.y)return Fn(g,o);if(!M.has(p)){M.add(p);for(const b of Bn){const d=Ze(b),h=g.x+d.dx,x=g.y+d.dy,v=ce(h,x,b);if(M.has(v)||!Xt(t,h,x))continue;const I=t.cells[x][h];if(I.type===it.MACHINE)continue;const m=g.direction!==null&&g.direction!==b,w=Yt(t,a,g.x,g.y),E=Yt(t,a,h,x),k=Ct(b);if(E&&(E.cornerCount>0||Fe(E,k))||w&&(m||Fe(w,k)))continue;const O=m?2:0,F=I.type===it.BELT?.5:0,X=g.g+1+O+F,S=u.get(v);S!==void 0&&X>=S||(u.set(v,X),f.push({x:h,y:x,g:X,h:Gt(h,x,r.x,r.y),f:X+Gt(h,x,r.x,r.y),parent:g,direction:b}))}}}return null}function mt(t,e){const n=Bt(t),o=Bt(e);return Math.abs(n.x-o.x)+Math.abs(n.y-o.y)}function Fn(t,e){const n=[];let o=t;for(;o!==null;)n.unshift({x:o.x,y:o.y,fromDirection:o.parent?Ke(o.direction):null,toDirection:null}),o=o.parent;for(let i=0;i<n.length-1;i++){const r=n[i+1],a=r.x-n[i].x,c=r.y-n[i].y;a===1?n[i].toDirection=nt.RIGHT:a===-1?n[i].toDirection=nt.LEFT:c===1?n[i].toDirection=nt.DOWN:c===-1&&(n[i].toDirection=nt.UP)}return{connectionId:e,segments:n}}function on(t,e,n){const o=Pe(e.x,e.y),i=t.beltTileUsage.get(o)??nn();if(tn(e))i.cornerCount+=n;else{const r=en(e);r==="H"&&(i.horizontalCount+=n),r==="V"&&(i.verticalCount+=n)}if(i.cornerCount<=0&&i.horizontalCount<=0&&i.verticalCount<=0){t.beltTileUsage.delete(o);return}i.cornerCount=Math.max(0,i.cornerCount),i.horizontalCount=Math.max(0,i.horizontalCount),i.verticalCount=Math.max(0,i.verticalCount),t.beltTileUsage.set(o,i)}function ie(t,e){for(const n of e.segments){const o=t.cells[n.y][n.x];o.type===it.EMPTY&&(o.type=it.BELT),o.beltConnectionIds.includes(e.connectionId)||o.beltConnectionIds.push(e.connectionId),on(t,n,1)}t.beltPaths.set(e.connectionId,e)}function rn(t,e){const n=t.beltPaths.get(e);if(n){for(const o of n.segments){on(t,o,-1);const i=t.cells[o.y][o.x];i.beltConnectionIds=i.beltConnectionIds.filter(r=>r!==e),i.beltConnectionIds.length===0&&i.type===it.BELT&&(i.type=it.EMPTY)}t.beltPaths.delete(e)}}const Ce=1,Te=.5,Ae=.3,sn=1e-6;function bt(t){let e=0,n=0,o=t.width,i=t.height,r=-1,a=-1;for(let l=0;l<t.height;l++)for(let f=0;f<t.width;f++)t.cells[l][f].type!==it.EMPTY&&(o=Math.min(o,f),i=Math.min(i,l),r=Math.max(r,f),a=Math.max(a,l));for(const l of t.beltPaths.values()){e+=l.segments.length;for(let f=1;f<l.segments.length;f++){const M=l.segments[f-1],u=l.segments[f];M.toDirection!==null&&u.toDirection!==null&&M.toDirection!==u.toDirection&&n++}}const c=r>=0?(r-o+1)*(a-i+1):0,s=e*Ce+c*Te+n*Ae;return{totalBelts:e,boundingBoxArea:c,cornerCount:n,totalScore:s}}function et(t,e,n=sn){return Math.abs(t.totalBelts-e.totalBelts)>n?t.totalBelts-e.totalBelts:Math.abs(t.boundingBoxArea-e.boundingBoxArea)>n?t.boundingBoxArea-e.boundingBoxArea:Math.abs(t.cornerCount-e.cornerCount)>n?t.cornerCount-e.cornerCount:0}function Le(t,e,n=sn){return et(t,e,n)<0}const Q={background:"#1a1a2e",gridLine:"#1f1f38",gridLineAccent:"#2a2a50",machineBody:"#2a2960",machineBorder:"#5b57d1",machineLabel:"#c0bfff",portInput:"#5bc0eb",portOutput:"#f4845f",selectedHighlight:"#ffd166",beltColors:["#e8c547","#f4845f","#5bc0eb","#7bc950","#e056a0","#56e0d0","#c05beb","#eb5b5b"]};class Ln{canvas;ctx;cellSize=32;camera={x:0,y:0,zoom:1};selectedMachineId=null;ghost=null;constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){this.canvas.width=this.canvas.parentElement?.clientWidth||window.innerWidth,this.canvas.height=this.canvas.parentElement?.clientHeight||window.innerHeight}setSelectedMachine(e){this.selectedMachineId=e}setGhost(e){this.ghost=e}screenToGrid(e,n){const o=this.cellSize*this.camera.zoom;return{gx:Math.floor((e-this.camera.x)/o),gy:Math.floor((n-this.camera.y)/o)}}gridToScreen(e,n){const o=this.cellSize*this.camera.zoom;return{sx:e*o+this.camera.x,sy:n*o+this.camera.y}}cellCenter(e,n,o){return{cx:e*o+this.camera.x+o/2,cy:n*o+this.camera.y+o/2}}render(e){const{ctx:n,canvas:o}=this,i=this.cellSize*this.camera.zoom;n.fillStyle=Q.background,n.fillRect(0,0,o.width,o.height),this.drawGridLines(e,i);for(const r of e.beltPaths.values())this.drawBeltPath(r,i,e);for(const r of e.machines.values())this.drawMachine(r,i);this.ghost&&this.drawGhost(this.ghost,i)}drawGridLines(e,n){const{ctx:o,canvas:i,camera:r}=this,a=Math.max(0,Math.floor(-r.x/n)),c=Math.max(0,Math.floor(-r.y/n)),s=Math.min(e.width,Math.ceil((i.width-r.x)/n)),l=Math.min(e.height,Math.ceil((i.height-r.y)/n));for(let f=a;f<=s;f++){const M=f*n+r.x;o.strokeStyle=f%5===0?Q.gridLineAccent:Q.gridLine,o.lineWidth=f%5===0?1:.5,o.beginPath(),o.moveTo(M,c*n+r.y),o.lineTo(M,l*n+r.y),o.stroke()}for(let f=c;f<=l;f++){const M=f*n+r.y;o.strokeStyle=f%5===0?Q.gridLineAccent:Q.gridLine,o.lineWidth=f%5===0?1:.5,o.beginPath(),o.moveTo(a*n+r.x,M),o.lineTo(s*n+r.x,M),o.stroke()}}drawMachine(e,n){const{ctx:o,camera:i}=this,{width:r,height:a}=_(e),c=this.selectedMachineId===e.id,s=e.x*n+i.x,l=e.y*n+i.y,f=r*n,M=a*n,u=3,y=6;o.fillStyle=Q.machineBody,this.roundRect(s+u,l+u,f-u*2,M-u*2,y),o.fill(),o.strokeStyle=c?Q.selectedHighlight:Q.machineBorder,o.lineWidth=c?2.5:1.5,this.roundRect(s+u,l+u,f-u*2,M-u*2,y),o.stroke();const g=Math.max(10,n*.38);o.fillStyle=Q.machineLabel,o.font=`bold ${g}px 'JetBrains Mono', monospace`,o.textAlign="center",o.textBaseline="middle",o.fillText(`${e.type} `,s+f/2,l+M/2-n*.12);const p=Math.max(8,n*.22);o.font=`${p}px 'JetBrains Mono', monospace`,o.fillStyle="#8080aa",o.fillText(e.orientation,s+f/2,l+M/2+n*.2),this.drawPorts(e,n)}drawPorts(e,n){const{ctx:o}=this,{inputs:i,outputs:r}=L(e),a=Math.max(3,n*.2);for(const c of i){const{cx:s,cy:l}=this.cellCenter(c.x,c.y,n);o.beginPath(),o.arc(s,l,a,0,Math.PI*2),o.fillStyle=Q.portInput,o.fill(),o.beginPath(),o.arc(s,l,a*.4,0,Math.PI*2),o.fillStyle="#fff",o.fill()}for(const c of r){const{cx:s,cy:l}=this.cellCenter(c.x,c.y,n);o.beginPath(),o.arc(s,l,a,0,Math.PI*2),o.fillStyle=Q.portOutput,o.fill(),o.beginPath(),o.arc(s,l,a*.45,0,Math.PI*2),o.fillStyle=Q.machineBody,o.fill()}}drawBeltPath(e,n,o){const{ctx:i}=this;if(e.segments.length===0)return;const r=Math.abs(zn(e.connectionId))%Q.beltColors.length,a=Q.beltColors[r],c=Math.max(3,n*.22),s=this.buildBeltPolyline(e,n,o);if(s.length<2)return;i.strokeStyle="rgba(0,0,0,0.4)",i.lineWidth=c+3,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(s[0].x,s[0].y);for(let f=1;f<s.length;f++)i.lineTo(s[f].x,s[f].y);i.stroke(),i.strokeStyle=a,i.lineWidth=c,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(s[0].x,s[0].y);for(let f=1;f<s.length;f++)i.lineTo(s[f].x,s[f].y);i.stroke(),this.drawCrossingDots(e,n,o,a,c);const l=Math.max(2.5,n*.12);if(i.beginPath(),i.arc(s[0].x,s[0].y,l,0,Math.PI*2),i.fillStyle=a,i.fill(),s.length>=2){const f=s[s.length-1],M=s[s.length-2],u=Math.atan2(f.y-M.y,f.x-M.x),y=n*.3;i.fillStyle=a,i.beginPath(),i.moveTo(f.x+Math.cos(u)*y,f.y+Math.sin(u)*y),i.lineTo(f.x+Math.cos(u+2.4)*y*.6,f.y+Math.sin(u+2.4)*y*.6),i.lineTo(f.x+Math.cos(u-2.4)*y*.6,f.y+Math.sin(u-2.4)*y*.6),i.closePath(),i.fill()}}buildBeltPolyline(e,n,o){const i=[],r=o.connections.get(e.connectionId);if(r){const a=o.machines.get(r.sourceMachineId);if(a){const s=L(a).outputs[r.sourcePortIndex];if(s){const{cx:l,cy:f}=this.cellCenter(s.x,s.y,n);i.push({x:l,y:f})}}}for(const a of e.segments){const{cx:c,cy:s}=this.cellCenter(a.x,a.y,n);i.push({x:c,y:s})}if(r){const a=o.machines.get(r.targetMachineId);if(a){const s=L(a).inputs[r.targetPortIndex];if(s){const{cx:l,cy:f}=this.cellCenter(s.x,s.y,n);i.push({x:l,y:f})}}}return i}drawCrossingDots(e,n,o,i,r){const{ctx:a}=this;for(const c of e.segments){const s=o.cells[c.y]?.[c.x];if(!s||s.beltConnectionIds.length<2)continue;const{cx:l,cy:f}=this.cellCenter(c.x,c.y,n),M=r*.9;a.beginPath(),a.arc(l,f,M,0,Math.PI*2),a.fillStyle=i,a.fill(),a.strokeStyle="#fff",a.lineWidth=1.5,a.stroke()}}drawGhost(e,n){const{ctx:o,camera:i}=this,r={id:"__ghost__",type:e.type,x:e.gx,y:e.gy,orientation:e.orientation},{width:a,height:c}=_(r),s=e.gx*n+i.x,l=e.gy*n+i.y,f=a*n,M=c*n,u=3,y=6;o.globalAlpha=.45,o.fillStyle=e.valid?"#2a6040":"#602a2a",this.roundRect(s+u,l+u,f-u*2,M-u*2,y),o.fill(),o.strokeStyle=e.valid?"#4ae080":"#e04a4a",o.lineWidth=2,o.setLineDash([6,4]),this.roundRect(s+u,l+u,f-u*2,M-u*2,y),o.stroke(),o.setLineDash([]);const g=L(r),p=Math.max(2,n*.14);for(const h of g.inputs){const{cx:x,cy:v}=this.cellCenter(h.x,h.y,n);o.beginPath(),o.arc(x,v,p,0,Math.PI*2),o.fillStyle=Q.portInput,o.fill()}for(const h of g.outputs){const{cx:x,cy:v}=this.cellCenter(h.x,h.y,n);o.beginPath(),o.arc(x,v,p,0,Math.PI*2),o.fillStyle=Q.portOutput,o.fill()}o.fillStyle="#fff";const b=Math.max(9,n*.32);o.font=`bold ${b}px 'JetBrains Mono', monospace`,o.textAlign="center",o.textBaseline="middle",o.fillText(e.type,s+f/2,l+M/2-n*.08);const d=Math.max(7,n*.2);o.font=`${d}px 'JetBrains Mono', monospace`,o.fillStyle="#aaa",o.fillText(e.orientation,s+f/2,l+M/2+n*.18),o.globalAlpha=1}roundRect(e,n,o,i,r){const{ctx:a}=this;r=Math.min(r,o/2,i/2),a.beginPath(),a.moveTo(e+r,n),a.arcTo(e+o,n,e+o,n+i,r),a.arcTo(e+o,n+i,e,n+i,r),a.arcTo(e,n+i,e,n,r),a.arcTo(e,n,e+o,n,r),a.closePath()}}function zn(t){let e=0;for(let n=0;n<t.length;n++){const o=t.charCodeAt(n);e=(e<<5)-e+o,e|=0}return e}const pt=[z.NORTH,z.EAST,z.SOUTH,z.WEST],$n={initialTemp:100,coolingRate:.965,minTemp:.3,iterPerTemp:12,batchSize:50,useFastScore:!0},_n={initialTemp:30,coolingRate:.98,minTemp:.1,iterPerTemp:6,batchSize:30,useFastScore:!1},Un={initialTemp:130,coolingRate:.975,minTemp:.08,iterPerTemp:16,batchSize:72,useFastScore:!0},Wn={initialTemp:45,coolingRate:.985,minTemp:.04,iterPerTemp:10,batchSize:44,useFastScore:!1},Hn=2e3,Gn=60,Yn=25;function an(t){const e=new Map;for(const n of t)An(n.type)&&e.set(n.id,{...n});return e}function ot(t,e){if(e.size!==0)for(const n of t){const o=e.get(n.id);o&&(n.x=o.x,n.y=o.y,n.orientation=o.orientation)}}function ze(t){return{totalBelts:t.totalBelts,boundingBoxArea:t.boundingBoxArea,cornerCount:t.cornerCount,totalScore:t.totalScore}}async function $e(t,e={},n){const o=jn(e),i=cn(o.seed),r=Array.from(t.machines.values()).map(P=>({...P})),a=Array.from(t.connections.values()).map(P=>({...P})),c=an(r);if(r.length===0){const P=bt(t);return{grid:ae(t),score:P,iterations:0,diagnostics:o.diagnostics?{phaseDiagnostics:[],firstStrictImprovementPhase:null}:void 0}}const s=t.width,l=t.height;let f=0;const M=ae(t),u=bt(t),y=[];let g=null,p=null;const b=performance.now(),d=Number.isFinite(o.timeBudgetMs)?b+o.timeBudgetMs:Number.POSITIVE_INFINITY,h=()=>o.mode==="deep"&&performance.now()>=d,x=P=>{o.diagnostics&&(p={phase:P,startTime:performance.now(),startIter:f,startScore:ze(E.score)})},v=P=>{o.diagnostics&&(!p||p.phase!==P||(y.push({phase:P,startScore:p.startScore,endScore:ze(E.score),durationMs:performance.now()-p.startTime,iterationDelta:Math.max(0,f-p.startIter)}),p=null))},I={largeMoveRate:o.largeMoveRate,clusterMoveMinSize:Math.min(o.clusterMoveMinSize,o.clusterMoveMaxSize),clusterMoveMaxSize:Math.max(o.clusterMoveMinSize,o.clusterMoveMaxSize),adaptiveOps:o.adaptiveOps,adaptiveWindow:o.adaptiveWindow,adaptiveWarmupIterations:o.adaptiveWarmupIterations,adaptiveMaxOperatorProb:o.adaptiveMaxOperatorProb,adaptiveStagnationResetWindow:o.adaptiveStagnationResetWindow,adaptiveFlattenFactor:o.adaptiveFlattenFactor,largeMoveRateEarly:o.largeMoveRateEarly,largeMoveRateLate:o.largeMoveRateLate,largeMoveCooldownAfterImprove:o.largeMoveCooldownAfterImprove,criticalNetRate:o.criticalNetRate,repairBeamWidth:o.repairBeamWidth},m=[],w=o.persistEliteArchive?Vn(e.incomingEliteArchive):[];let E={grid:M,score:u};const k=(P,U,D)=>{ot(P,c);const $=Qt(P,U,s,l);if(!$)return;const Y=bt($);et(Y,E.score)<0&&(E={grid:ae($),score:Y},!g&&D&&Le(Y,u)&&(g=D))},O=(P,U)=>{if(o.elitePoolSize<=0)return;ot(P,c);const D=io(P),$=gt(P,U,s,l),Y=$?$.score:Ee(ut(P,U,new Map(P.map(B=>[B.id,B]))),P.length,U.length);if(Number.isFinite(Y.totalScore)){if(o.eliteDiversityHash||o.eliteMinDistance>0){for(const B of m){const st=o.eliteDiversityHash&&B.fingerprint===D,St=o.eliteMinDistance>0&&Ge(P,B.machines)<o.eliteMinDistance;if((st||St)&&et(Y,B.score)>=0)return}for(let B=m.length-1;B>=0;B--){const st=m[B],St=o.eliteDiversityHash&&st.fingerprint===D,Cn=o.eliteMinDistance>0&&Ge(P,st.machines)<o.eliteMinDistance;(St||Cn)&&m.splice(B,1)}}m.push({machines:P.map(B=>({...B})),connections:U.map(B=>({...B})),score:Y,fingerprint:D}),m.sort((B,st)=>et(B.score,st.score)),m.length>o.elitePoolSize&&m.splice(o.elitePoolSize)}},F=(P,U)=>{let D=P.map(B=>({...B}));if(m.length>0){const B=Math.min(m.length-1,Math.floor(Math.pow(i(),1.6)*m.length)),st=m[B];D=st.machines.map(St=>({...St})),a.length=0,a.push(...st.connections.map(St=>({...St})))}let $=D.map(B=>({...B}));const Y=1+Math.floor(i()*2);for(let B=0;B<Y;B++)$=Re($,a,s,l,i,I,void 0,new Set(c.keys()));return at($,a,s,l,U)<1/0?$:D};if(o.persistEliteArchive&&w.length>0)for(const P of w)O(P.machines,P.connections);O(r,a),x("Phase 0");const X=o.useExplorationSeeds,S=X?[{name:"Greedy placement",machines:Zn(r,a,s,l)},{name:"Layered topology placement",machines:Qn(r,a,s,l)},{name:"Current layout",machines:r.map(P=>({...P}))}]:[{name:"Current layout",machines:r.map(P=>({...P}))}];if(X){const P=eo(r,a,s,l);P&&S.unshift({name:"Pattern-aware placement",machines:P});const U=to(r,a,s,l);U&&S.push({name:"Two-layer exhaustive placement",machines:U})}let C=S[0].machines.map(P=>({...P})),T=1/0,A=null,N=!1,G=null;for(const P of S){if(h())break;const U=P.machines.map(B=>({...B})),D=a.map(B=>({...B}));ot(U,c),Jt(U,D,s,l),k(U,D,"Phase 0"),O(U,D);const $=gt(U,D,s,l);$&&(!G||et($.score,G)<0)&&(G=$.score),$&&(!A||et($.score,A)<0)&&(A=$.score,N=!0,C=U.map(B=>({...B})),a.length=0,a.push(...D.map(B=>({...B}))));const Y=at(U,D,s,l,!0);!N&&Y<T&&(T=Y,C=U.map(B=>({...B})),a.length=0,a.push(...D.map(B=>({...B}))))}n&&G&&n(G,0,o.mode==="deep"?"Phase 0: Current-layout seed":"Phase 0: Seed placement"),v("Phase 0"),x("Phase 1");let q=C.map(P=>({...P})),K=at(q,a,s,l,!0);const J=Math.max(1,o.phase1Restarts);let j=q.map(P=>({...P}));for(let P=0;P<J&&!h();P++){let U=0;const D=await ue(j,a,s,l,{...o.phase1SA,random:i,shouldStop:h,operators:I,fixedMachineIds:new Set(c.keys())},(Y,B)=>{if(U=B,!n)return;const st=J>1?`Phase 1: Fast SA (${P+1}/${J})`:"Phase 1: Fast SA";n(Y,f+B,st)});f+=U,ot(D,c),k(D,a,"Phase 1"),O(D,a);const $=at(D,a,s,l,!0);$<K&&(K=$,q=D.map(Y=>({...Y}))),j=q.map(Y=>({...Y})),o.mode==="deep"&&P+1<J&&(j=F(q,!0))}const ct=Jt(q,a,s,l);ot(ct,c),k(ct,a,"Phase 1"),O(ct,a),v("Phase 1"),x("Phase 2");let tt=ct.map(P=>({...P})),vt=at(tt,a,s,l,!1);const dt=Math.max(1,o.phase2Attempts);let ht=tt.map(P=>({...P}));for(let P=0;P<dt&&!h();P++){let U=0;const D=await ue(ht,a,s,l,{...o.phase2SA,random:i,shouldStop:h,operators:I,fixedMachineIds:new Set(c.keys())},(Y,B)=>{if(U=B,!n)return;const st=dt>1?`Phase 2: Fine-tune SA (${P+1}/${dt})`:"Phase 2: Fine-tune SA";n(Y,f+B,st)});f+=U,ot(D,c),k(D,a,"Phase 2"),O(D,a);const $=at(D,a,s,l,!1);$<vt&&(vt=$,tt=D.map(Y=>({...Y}))),ht=tt.map(Y=>({...Y})),o.mode==="deep"&&P+1<dt&&(ht=F(tt,!1))}v("Phase 2"),x("Phase 3");const kt=Jt(tt,a,s,l);ot(kt,c),k(kt,a,"Phase 3"),O(kt,a),v("Phase 3"),x("Phase 4");let ft=kt.map(P=>({...P}));const Dt=Math.max(1,o.localPolishPasses);for(let P=0;P<Dt&&!h();P++){const U=wo(ft,a,s,l,c);if(k(U,a,"Phase 4"),O(U,a),ft=ro(U,a,s,l,c),k(ft,a,"Phase 4"),O(ft,a),o.mode==="deep"&&P+1<Dt){let D=0;const $=await ue(ft,a,s,l,{...o.phase2SA,initialTemp:Math.max(8,o.phase2SA.initialTemp*.55),iterPerTemp:Math.max(4,Math.floor(o.phase2SA.iterPerTemp*.65)),batchSize:Math.max(14,Math.floor(o.phase2SA.batchSize*.65)),random:i,shouldStop:h,operators:I,fixedMachineIds:new Set(c.keys())},(Y,B)=>{D=B,n&&n(Y,f+B,`Phase 4: Local polish SA (${P+1}/${Dt})`)});f+=D,ot($,c),k($,a,"Phase 4"),O($,a),ft=$}if(n){const D=gt(ft,a,s,l);if(D){const $=Dt>1?`Phase 4: Compaction/orient (${P+1}/${Dt})`:"Phase 4: Compaction/orient";n(D.score,f,$)}}}v("Phase 4"),ot(ft,c),O(ft,a);const se=Qt(ft,a,s,l);if(se){const P=bt(se);et(P,E.score)<0&&(E={grid:se,score:P},!g&&Le(P,u)&&(g="Phase 4"))}if(et(u,E.score)<0&&(E={grid:M,score:u}),o.persistEliteArchive&&(e.outgoingEliteArchive=Kn(m)),n){const P=h()?"Done (time budget reached)":"Done";n(E.score,f,P)}return{grid:E.grid,score:E.score,iterations:f,diagnostics:o.diagnostics?{phaseDiagnostics:y,firstStrictImprovementPhase:g}:void 0}}function jn(t){const e=t.mode==="deep"?"deep":"normal",n=e==="deep"?{timeBudgetMs:7e3,diagnostics:!1,phase1Restarts:3,phase2Attempts:3,localPolishPasses:3,useExplorationSeeds:!1,elitePoolSize:12,eliteDiversityHash:!0,eliteMinDistance:0,largeMoveRate:.2,clusterMoveMinSize:2,clusterMoveMaxSize:5,adaptiveOps:!0,adaptiveWindow:120,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,persistEliteArchive:!1,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1,phase1SA:Un,phase2SA:Wn}:{timeBudgetMs:Number.POSITIVE_INFINITY,diagnostics:!1,phase1Restarts:1,phase2Attempts:1,localPolishPasses:1,useExplorationSeeds:!0,elitePoolSize:8,eliteDiversityHash:!0,eliteMinDistance:0,largeMoveRate:.12,clusterMoveMinSize:2,clusterMoveMaxSize:4,adaptiveOps:!1,adaptiveWindow:100,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,persistEliteArchive:!1,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1,phase1SA:$n,phase2SA:_n},o=Et(t.largeMoveRate,n.largeMoveRate,0,.6),i=Et(t.largeMoveRateEarly,o,0,.7),r=Et(t.largeMoveRateLate,o,0,.7),a=Et(t.criticalNetRate,n.criticalNetRate,0,o);return{mode:e,timeBudgetMs:Xn(t.timeBudgetMs,n.timeBudgetMs),diagnostics:Ft(t.diagnostics,n.diagnostics),phase1Restarts:Mt(t.phase1Restarts,n.phase1Restarts),phase2Attempts:Mt(t.phase2Attempts,n.phase2Attempts),localPolishPasses:Mt(t.localPolishPasses,n.localPolishPasses),useExplorationSeeds:Ft(t.useExplorationSeeds,n.useExplorationSeeds),elitePoolSize:Mt(t.elitePoolSize,n.elitePoolSize),eliteDiversityHash:Ft(t.eliteDiversityHash,n.eliteDiversityHash),eliteMinDistance:qn(t.eliteMinDistance,n.eliteMinDistance),largeMoveRate:o,clusterMoveMinSize:Mt(t.clusterMoveMinSize,n.clusterMoveMinSize),clusterMoveMaxSize:Mt(t.clusterMoveMaxSize,n.clusterMoveMaxSize),adaptiveOps:Ft(t.adaptiveOps,n.adaptiveOps),adaptiveWindow:Mt(t.adaptiveWindow,n.adaptiveWindow),adaptiveWarmupIterations:le(t.adaptiveWarmupIterations,n.adaptiveWarmupIterations),adaptiveMaxOperatorProb:Et(t.adaptiveMaxOperatorProb,n.adaptiveMaxOperatorProb,.12,1),adaptiveStagnationResetWindow:le(t.adaptiveStagnationResetWindow,n.adaptiveStagnationResetWindow),adaptiveFlattenFactor:Et(t.adaptiveFlattenFactor,n.adaptiveFlattenFactor,0,1),persistEliteArchive:Ft(t.persistEliteArchive,n.persistEliteArchive),largeMoveRateEarly:i,largeMoveRateLate:r,largeMoveCooldownAfterImprove:le(t.largeMoveCooldownAfterImprove,n.largeMoveCooldownAfterImprove),criticalNetRate:a,repairBeamWidth:Mt(t.repairBeamWidth,n.repairBeamWidth),seed:Jn(t.seed),phase1SA:n.phase1SA,phase2SA:n.phase2SA}}function Mt(t,e){return typeof t!="number"||!Number.isFinite(t)?e:Math.max(1,Math.floor(t))}function le(t,e){return typeof t!="number"||!Number.isFinite(t)?e:Math.max(0,Math.floor(t))}function Xn(t,e){return typeof t!="number"||!Number.isFinite(t)||t<=0?e:t}function qn(t,e){return typeof t!="number"||!Number.isFinite(t)||t<0?e:t}function Et(t,e,n,o){return typeof t!="number"||!Number.isFinite(t)?e:Math.max(n,Math.min(o,t))}function Ft(t,e){return typeof t!="boolean"?e:t}function Jn(t){if(!(typeof t!="number"||!Number.isFinite(t)))return Math.floor(t)}function cn(t){if(t===void 0)return Math.random;let e=t>>>0||1831565813;return()=>(e=e*1664525+1013904223>>>0,e/4294967296)}function Vn(t){if(!Array.isArray(t))return[];const e=[];for(const n of t){if(!n||typeof n!="object")continue;const o=n.machines,i=n.connections;if(!Array.isArray(o)||!Array.isArray(i))continue;const r=[];for(const c of o){if(!c||typeof c!="object")continue;const s=c,l=Ve(s.type);typeof s.id!="string"||!l||typeof s.x!="number"||!Number.isFinite(s.x)||typeof s.y!="number"||!Number.isFinite(s.y)||typeof s.orientation!="string"||r.push({id:s.id,type:l,x:s.x,y:s.y,orientation:s.orientation})}const a=[];for(const c of i){if(!c||typeof c!="object")continue;const s=c;typeof s.id!="string"||typeof s.sourceMachineId!="string"||typeof s.targetMachineId!="string"||typeof s.sourcePortIndex!="number"||!Number.isFinite(s.sourcePortIndex)||typeof s.targetPortIndex!="number"||!Number.isFinite(s.targetPortIndex)||a.push({id:s.id,sourceMachineId:s.sourceMachineId,sourcePortIndex:Math.floor(s.sourcePortIndex),targetMachineId:s.targetMachineId,targetPortIndex:Math.floor(s.targetPortIndex)})}r.length===0||a.length===0||e.push({machines:r,connections:a})}return e}function Kn(t){return t.map(e=>({machines:e.machines.map(n=>({...n})),connections:e.connections.map(n=>({...n}))}))}function Zn(t,e,n,o){if(t.length===0)return[];const i=new Map;for(const p of t)i.set(p.id,new Map);for(const p of e){const b=i.get(p.sourceMachineId),d=i.get(p.targetMachineId);!b||!d||(b.set(p.targetMachineId,(b.get(p.targetMachineId)||0)+1),d.set(p.sourceMachineId,(d.get(p.sourceMachineId)||0)+1))}const r=new Map;for(const[p,b]of i){let d=0;for(const h of b.values())d+=h;r.set(p,d)}const a=t.map(p=>({...p})),c=new Set,s=new Map(a.map(p=>[p.id,p]));let l=null,f=0;for(const[p,b]of i)for(const[d,h]of b)h>f&&(f=h,l=[p,d]);const M=l?l[0]:t[0].id,u=s.get(M);let y=u.orientation,g=1/0;for(const p of pt){u.orientation=p;const b=_(u),d=b.width*b.height;d<g&&(g=d,y=p)}if(u.orientation=y,u.x=2,u.y=2,c.add(M),l){const p=l[1],b=s.get(p),d=_e(b,u,e,a,c,n,o,s);d&&(b.x=d.x,b.y=d.y,b.orientation=d.orientation),c.add(p)}for(;c.size<a.length;){let p=null,b=-1;for(const I of a){if(c.has(I.id))continue;const m=i.get(I.id);let w=0;for(const[E,k]of m)c.has(E)&&(w+=k);(w>b||w===b&&p===null)&&(b=w,p=I.id)}p||(p=a.find(I=>!c.has(I.id)).id);const d=s.get(p),h=i.get(p),x=[];for(const[I,m]of h)c.has(I)&&x.push({id:I,count:m});x.sort((I,m)=>m.count-I.count);const v=x.length>0?x[0].id:null;if(v){let I=null;for(const w of x){const E=s.get(w.id),k=_e(d,E,e,a,c,n,o,s);if(!k)continue;d.x=k.x,d.y=k.y,d.orientation=k.orientation;let O=0;for(const F of e){if(F.sourceMachineId!==d.id&&F.targetMachineId!==d.id)continue;const X=F.sourceMachineId===d.id?F.targetMachineId:F.sourceMachineId;if(!c.has(X))continue;const S=s.get(F.sourceMachineId),C=s.get(F.targetMachineId);if(!S||!C)continue;const T=L(S),A=L(C),N=T.outputs[F.sourcePortIndex],G=A.inputs[F.targetPortIndex];N&&G&&(O+=mt(N,G))}(!I||O<I.cost)&&(I={x:k.x,y:k.y,orientation:k.orientation,cost:O})}const m=I;if(m)d.x=m.x,d.y=m.y,d.orientation=m.orientation;else{const w=s.get(v);Ue(d,w,e,a,c,n,o,s)}}else{const I=a.find(m=>c.has(m.id));Ue(d,I,e,a,c,n,o,s)}c.add(p)}return a}function _e(t,e,n,o,i,r,a,c){const s=_(e);let l=null,f=1/0;for(const M of pt){t.orientation=M;const u=_(t),y=[];for(let g=-(u.width-1);g<=s.width-1;g++)y.push({x:e.x+g,y:e.y+s.height+1});for(let g=-(u.width-1);g<=s.width-1;g++)y.push({x:e.x+g,y:e.y-u.height-1});for(let g=-(u.height-1);g<=s.height-1;g++)y.push({x:e.x+s.width+1,y:e.y+g});for(let g=-(u.height-1);g<=s.height-1;g++)y.push({x:e.x-u.width-1,y:e.y+g});for(const g of y){if(t.x=g.x,t.y=g.y,!yt(t,o,i,r,a))continue;let p=0,b=!0;for(const d of n){if(d.sourceMachineId!==t.id&&d.targetMachineId!==t.id)continue;const h=c.get(d.sourceMachineId),x=c.get(d.targetMachineId);if(!h||!x)continue;const v=d.sourceMachineId===t.id?d.targetMachineId:d.sourceMachineId;if(!i.has(v)&&v!==e.id)continue;const I=L(h),m=L(x),w=I.outputs[d.sourcePortIndex],E=m.inputs[d.targetPortIndex];if(!w||!E){b=!1;break}p+=mt(w,E)}b&&p<f&&(f=p,l={x:g.x,y:g.y,orientation:M})}}return l}function Ue(t,e,n,o,i,r,a,c){let s=1/0,l=e.x,f=e.y+5,M=t.orientation;for(const u of pt){t.orientation=u;const y=un(e.x,e.y,t,o,i,r,a);if(!y)continue;t.x=y.x,t.y=y.y;let g=0;for(const p of n){if(p.sourceMachineId!==t.id&&p.targetMachineId!==t.id)continue;const b=c.get(p.sourceMachineId),d=c.get(p.targetMachineId);if(!b||!d)continue;const h=p.sourceMachineId===t.id?p.targetMachineId:p.sourceMachineId;if(!i.has(h))continue;const x=L(b),v=L(d),I=x.outputs[p.sourcePortIndex],m=v.inputs[p.targetPortIndex];I&&m&&(g+=mt(I,m))}g<s&&(s=g,l=y.x,f=y.y,M=u)}t.x=l,t.y=f,t.orientation=M}function Qn(t,e,n,o){if(t.length===0)return[];const i=t.map(S=>({...S,orientation:z.NORTH})),r=new Map,a=new Map,c=new Map;for(const S of i)r.set(S.id,[]),a.set(S.id,[]),c.set(S.id,0);for(const S of e)!r.has(S.targetMachineId)||!a.has(S.sourceMachineId)||(r.get(S.targetMachineId).push(S.sourceMachineId),a.get(S.sourceMachineId).push(S.targetMachineId),c.set(S.targetMachineId,(c.get(S.targetMachineId)||0)+1));const s=new Map;for(const S of i)s.set(S.id,(r.get(S.id)?.length||0)+(a.get(S.id)?.length||0));const l=i.map(S=>S.id).filter(S=>(c.get(S)||0)===0).sort((S,C)=>{const T=(s.get(C)||0)-(s.get(S)||0);return T!==0?T:S.localeCompare(C)}),f=[];for(;l.length>0;){const S=l.shift();f.push(S);for(const C of a.get(S)||[])c.set(C,(c.get(C)||0)-1),(c.get(C)||0)===0&&l.push(C);l.sort((C,T)=>{const A=(s.get(T)||0)-(s.get(C)||0);return A!==0?A:C.localeCompare(T)})}if(f.length<i.length){const S=i.map(C=>C.id).filter(C=>!f.includes(C)).sort((C,T)=>{const A=(s.get(T)||0)-(s.get(C)||0);return A!==0?A:C.localeCompare(T)});f.push(...S)}const M=new Map;for(let S=0;S<f.length;S++)M.set(f[S],S);const u=new Map;for(const S of f){let C=0;for(const T of r.get(S)||[])C=Math.max(C,(u.get(T)||0)+1);u.set(S,C)}let y=0;for(const S of u.values())S>y&&(y=S);const g=new Map(i.map(S=>[S.id,S])),p=Array.from({length:y+1},()=>[]);for(const[S,C]of u){const T=g.get(S);T&&p[C].push(T)}for(const S of p)S.sort((C,T)=>(M.get(C.id)||0)-(M.get(T.id)||0));const b=(S,C,T)=>{if(S.length===0)return T;let A=0,N=0;for(const G of S){const q=C.get(G);q!==void 0&&(A+=q,N++)}return N>0?A/N:T};for(let S=0;S<2;S++){for(let C=1;C<=y;C++){const T=new Map;p[C-1].forEach((A,N)=>T.set(A.id,N)),p[C].sort((A,N)=>{const G=b(r.get(A.id)||[],T,M.get(A.id)||0),q=b(r.get(N.id)||[],T,M.get(N.id)||0);return G-q})}for(let C=y-1;C>=0;C--){const T=new Map;p[C+1].forEach((A,N)=>T.set(A.id,N)),p[C].sort((A,N)=>{const G=b(a.get(A.id)||[],T,M.get(A.id)||0),q=b(a.get(N.id)||[],T,M.get(N.id)||0);return G-q})}}const d=1,h=1,x=2,v=3,I=p.map(S=>{let C=0;for(const T of S)C=Math.max(C,_(T).height);return C}),m=I.reduce((S,C)=>S+C,0),w=p.length,E=o-h*2-m,k=w>1&&E>=w-1?Math.min(v,Math.floor(E/(w-1))):0;let O=h;for(let S=0;S<p.length;S++){const C=p[S];if(C.length===0)continue;const T=C.reduce((J,j)=>J+_(j).width,0),A=C.length-1,N=A>0?Math.floor((n-d*2-T)/A):0,G=A>0&&N>=1?Math.min(x,N):0,q=T+G*A;let K=Math.max(0,Math.floor((n-q)/2));for(const J of C){const j=_(J);J.x=K,J.y=Math.max(0,Math.min(o-j.height,O)),K+=j.width+G}O+=I[S]+k}const F=new Set,X=i.slice().sort((S,C)=>S.y-C.y||S.x-C.x);for(const S of X){if(!yt(S,i,F,n,o)){const C=Math.max(0,Math.min(n-1,S.x)),T=Math.max(0,Math.min(o-1,S.y)),A=un(C,T,S,i,F,n,o);A&&(S.x=A.x,S.y=A.y)}F.add(S.id)}return i}function to(t,e,n,o){if(t.length<2)return null;const i=t.map(x=>({...x,orientation:z.NORTH})),r=new Map,a=new Map,c=new Map;for(const x of i)r.set(x.id,[]),a.set(x.id,[]),c.set(x.id,0);for(const x of e)!r.has(x.targetMachineId)||!a.has(x.sourceMachineId)||(r.get(x.targetMachineId).push(x.sourceMachineId),a.get(x.sourceMachineId).push(x.targetMachineId),c.set(x.targetMachineId,(c.get(x.targetMachineId)||0)+1));const s=i.map(x=>x.id).filter(x=>(c.get(x)||0)===0),l=[];for(;s.length>0;){const x=s.shift();l.push(x);for(const v of a.get(x)||[])c.set(v,(c.get(v)||0)-1),(c.get(v)||0)===0&&s.push(v)}if(l.length!==i.length)return null;const f=new Map;for(const x of l){let v=0;for(const I of r.get(x)||[])v=Math.max(v,(f.get(I)||0)+1);f.set(x,v)}let M=0;for(const x of f.values())x>M&&(M=x);if(M!==1)return null;const u=new Map(i.map(x=>[x.id,x])),y=[],g=[];for(const[x,v]of f){const I=u.get(x);I&&(v===0?y.push(I):v===1&&g.push(I))}if(y.length===0||g.length===0||We(y.length)*We(g.length)>4e3)return null;const b=He(y),d=He(g);let h=null;for(const x of b)for(const v of d){const I=i.map(A=>({...A})),m=new Map(I.map(A=>[A.id,A])),w=x.map(A=>m.get(A.id)),E=v.map(A=>m.get(A.id)),k=w.reduce((A,N)=>Math.max(A,_(N).height),0),O=1,F=O+k+2;if(!Zt(w,O,n)||!Zt(E,F,n))continue;const X=new Set(I.map(A=>A.id));let S=!0;for(const A of I)if(!yt(A,I,X,n,o)){S=!1;break}if(!S)continue;const C=e.map(A=>({...A}));Jt(I,C,n,o);const T=gt(I,C,n,o);T&&(!h||et(T.score,h.score)<0)&&(h={machines:I.map(A=>({...A})),score:T.score})}return h?h.machines:null}function Zt(t,e,n){return qt(t,e,n,2)}function qt(t,e,n,o){if(t.length===0)return!0;const i=t.map(l=>_(l).width),r=i.reduce((l,f)=>l+f,0);let a=t.length>1?o:0;for(;a>0&&r+a*(t.length-1)>n;)a--;const c=r+a*(t.length-1);if(c>n)return!1;let s=Math.floor((n-c)/2);for(let l=0;l<t.length;l++)t[l].x=s,t[l].y=e,s+=i[l]+a;return!0}function We(t){let e=1;for(let n=2;n<=t;n++)e*=n;return e}function He(t){const e=[],n=new Array(t.length).fill(!1),o=[];function i(){if(o.length===t.length){e.push([...o]);return}for(let r=0;r<t.length;r++)n[r]||(n[r]=!0,o.push(t[r]),i(),o.pop(),n[r]=!1)}return i(),e}function eo(t,e,n,o){const i=no(t,e,n,o);if(i)return i;const r=oo(t,e,n,o);return r||null}function no(t,e,n,o){if(t.length<6)return null;const i=t.map(m=>({...m,orientation:z.NORTH})),r=new Map(t.map((m,w)=>[m.id,w])),a=new Map,c=new Map;for(const m of i)a.set(m.id,[]),c.set(m.id,[]);for(const m of e)!a.has(m.targetMachineId)||!c.has(m.sourceMachineId)||(a.get(m.targetMachineId).push(m.sourceMachineId),c.get(m.sourceMachineId).push(m.targetMachineId));const s=i.filter(m=>(a.get(m.id)?.length||0)===0&&(c.get(m.id)?.length||0)>0),l=i.filter(m=>(a.get(m.id)?.length||0)>0&&(c.get(m.id)?.length||0)>0),f=i.filter(m=>(a.get(m.id)?.length||0)>0&&(c.get(m.id)?.length||0)===0);if(s.length===0||l.length===0||f.length===0||s.length+l.length+f.length!==i.length)return null;const M=new Set(s.map(m=>m.id)),u=new Set(l.map(m=>m.id)),y=new Set(f.map(m=>m.id));for(const m of e)if(!(M.has(m.sourceMachineId)&&u.has(m.targetMachineId))&&!(u.has(m.sourceMachineId)&&y.has(m.targetMachineId)))return null;s.sort((m,w)=>(r.get(m.id)||0)-(r.get(w.id)||0));const g=new Map(s.map((m,w)=>[m.id,w]));if(s.length===l.length&&l.length===f.length)l.sort((m,w)=>(r.get(m.id)||0)-(r.get(w.id)||0)),f.sort((m,w)=>(r.get(m.id)||0)-(r.get(w.id)||0));else{l.sort((w,E)=>{const k=jt(a.get(w.id)||[],g,g.size),O=jt(a.get(E.id)||[],g,g.size);return k!==O?k-O:(r.get(w.id)||0)-(r.get(E.id)||0)});const m=new Map(l.map((w,E)=>[w.id,E]));f.sort((w,E)=>{const k=jt(a.get(w.id)||[],m,m.size),O=jt(a.get(E.id)||[],m,m.size);return k!==O?k-O:(r.get(w.id)||0)-(r.get(E.id)||0)})}const b=$t(s),d=$t(l),h=$t(f),x=1,v=x+b+2,I=v+d+2;return I+h>o||!qt(s,x,n,1)||!qt(l,v,n,1)||!qt(f,I,n,1)?null:ln(i,n,o)?i:null}function oo(t,e,n,o){if(t.length<8||e.length<t.length+Math.floor(t.length/3))return null;const i=t[0].type;if(t.some(m=>m.type!==i))return null;const r=t.map(m=>({...m,orientation:z.NORTH})),a=new Map(r.map(m=>[m.id,m])),c=new Map,s=new Map,l=new Map;for(const m of r)c.set(m.id,0),s.set(m.id,0),l.set(m.id,new Map);for(const m of e){if(!a.has(m.sourceMachineId)||!a.has(m.targetMachineId))continue;s.set(m.sourceMachineId,(s.get(m.sourceMachineId)||0)+1),c.set(m.targetMachineId,(c.get(m.targetMachineId)||0)+1);const w=l.get(m.sourceMachineId);w.set(m.targetMachineId,(w.get(m.targetMachineId)||0)+1)}for(const m of r)if((c.get(m.id)||0)===0||(s.get(m.id)||0)===0)return null;const f=m=>(c.get(m)||0)+(s.get(m)||0),M=r.map(m=>m.id),u=new Set(M),y=[];let g=M[0];for(const m of M)f(m)>f(g)&&(g=m);for(;u.size>0&&(u.has(g)||(g=Array.from(u).sort((k,O)=>f(O)-f(k)||k.localeCompare(O))[0]),y.push(g),u.delete(g),u.size!==0);){const m=l.get(g);let w=null,E=-1;if(m)for(const[k,O]of m){if(!u.has(k))continue;const F=O*10+f(k);F>E&&(E=F,w=k)}w||(w=Array.from(u).sort((k,O)=>f(O)-f(k)||k.localeCompare(O))[0]),g=w}if(y.length!==r.length)return null;const p=Math.ceil(y.length/2),b=y.slice(0,p).map(m=>a.get(m)),d=y.slice(p).reverse().map(m=>a.get(m)),h=$t(b),x=$t(d),v=1;let I=v+h+Math.max(4,Math.floor(Math.max(h,x)*1.4));return I+x>o&&(I=o-x-1),I<=v+h||!Zt(b,v,n)||!Zt(d,I,n)?null:ln(r,n,o)?r:null}function $t(t){let e=0;for(const n of t)e=Math.max(e,_(n).height);return e}function jt(t,e,n){let o=0,i=0;for(const r of t){const a=e.get(r);a!==void 0&&(o+=a,i++)}return i>0?o/i:n}function ln(t,e,n){const o=new Set(t.map(i=>i.id));for(const i of t)if(!yt(i,t,o,e,n))return!1;return!0}function yt(t,e,n,o,i){const r=_(t);if(t.x<0||t.y<0||t.x+r.width>o||t.y+r.height>i)return!1;for(const a of e)if(!(a.id===t.id||!n.has(a.id))&&ke(t,a))return!1;return!0}function ke(t,e){const n=_(t),o=_(e);return!(t.x+n.width<=e.x||e.x+o.width<=t.x||t.y+n.height<=e.y||e.y+o.height<=t.y)}function un(t,e,n,o,i,r,a){for(let c=1;c<Math.max(r,a);c++)for(let s=-c;s<=c;s++)for(let l=-c;l<=c;l++)if(!(Math.abs(s)!==c&&Math.abs(l)!==c)&&(n.x=t+s,n.y=e+l,yt(n,o,i,r,a)))return{x:n.x,y:n.y};return null}function io(t){return t.slice().sort((e,n)=>e.id.localeCompare(n.id)).map(e=>`${e.id}:${e.x},${e.y},${e.orientation}`).join("|")}function Ge(t,e){if(t.length===0||e.length===0)return 1/0;const n=new Map(e.map(r=>[r.id,r]));let o=0,i=0;for(const r of t){const a=n.get(r.id);a&&(o+=Math.abs(r.x-a.x),o+=Math.abs(r.y-a.y),o+=r.orientation===a.orientation?0:1,i++)}return i===0?1/0:o/i}function ro(t,e,n,o,i=new Map){const r=t.map(c=>({...c}));ot(r,i);let a=at(r,e,n,o,!1);a===1/0&&(a=at(r,e,n,o,!0));for(const c of r){if(i.has(c.id))continue;const s=c.orientation;let l=s,f=a;for(const M of pt){if(M===s)continue;c.orientation=M;const u=_(c);if(c.x+u.width>n||c.y+u.height>o)continue;let y=!0;for(const p of r)if(p.id!==c.id&&ke(c,p)){y=!1;break}if(!y)continue;const g=at(r,e,n,o,!1);g<f&&(f=g,l=M)}c.orientation=l,a=f}return r}function ue(t,e,n,o,i,r){return new Promise(a=>{let c=t.map(T=>({...T}));const s=i.fixedMachineIds??new Set;if(s.size>0){const T=an(c);ot(c,T)}let l=at(c,e,n,o,i.useFastScore),f=c.map(T=>({...T})),M=l,u=f.map(T=>({...T})),y=ut(u,e,new Map(u.map(T=>[T.id,T]))),g=i.initialTemp,p=0,b=0,d=0,h=0,x=0;const v=i.random??Math.random,I=i.operators??{largeMoveRate:.15,clusterMoveMinSize:2,clusterMoveMaxSize:4,adaptiveOps:!1,adaptiveWindow:80,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,largeMoveRateEarly:.15,largeMoveRateLate:.15,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1},m=fe(I),w=new Map;for(const T of m)w.set(T.id,{attempts:0,accepted:0,improved:0,recentGain:[]});const E=Math.max(20,I.adaptiveWindow),k=.9,O=T=>Math.max(6,T*.0125);let F=I;const X=()=>{F=ao(I,g,i.initialTemp,i.minTemp,h,x);const T=fe(F),A=I.adaptiveOps&&p>=I.adaptiveWarmupIterations,N=T.map(j=>j.baseWeight),G=T.map(j=>j.minProbability);let q=N.slice();A&&(q=T.map((j,ct)=>{const tt=w.get(j.id),vt=tt?co(tt.recentGain,k):0,dt=1+Math.log1p(Math.max(0,vt));return N[ct]*dt}));let K=Ye(q,G,A?I.adaptiveMaxOperatorProb:1);if(A&&I.adaptiveStagnationResetWindow>0&&h>=I.adaptiveStagnationResetWindow&&I.adaptiveFlattenFactor>0){const j=Ye(N,G,1);K=K.map((ct,tt)=>ct*(1-I.adaptiveFlattenFactor)+j[tt]*I.adaptiveFlattenFactor),K=_t(K)}const J=lo(K,v);return T[J]??T[T.length-1]},S=()=>!!(i.shouldStop&&i.shouldStop()||i.maxIterations!==void 0&&p>=i.maxIterations);function C(){if(S()){a(u);return}const T=M;t:for(let A=0;A<i.batchSize&&g>i.minTemp;A++){for(let N=0;N<i.iterPerTemp;N++){if(S())break t;p++;const G=X(),q=l,K=Re(c,e,n,o,v,F,G.id,s),J=at(K,e,n,o,i.useFastScore),j=w.get(G.id);j.attempts++;let ct=0,tt=!1;if(J<1/0){const vt=J-l;if(vt<0||v()<Math.exp(-vt/g)){c=K,l=J,ct=Math.max(0,q-J),j.accepted++;const dt=ut(K,e,new Map(K.map(ht=>[ht.id,ht])));if(Number.isFinite(dt.totalScore)&&et(dt,y)<0&&(y=dt,u=K.map(ht=>({...ht})),tt=!0),J<M){const ht=M-J;M=J,f=K.map(kt=>({...kt})),j.improved++,tt=!0,I.largeMoveCooldownAfterImprove>0&&ht>=O(M)&&(x=I.largeMoveCooldownAfterImprove)}}}j.recentGain.push(ct),j.recentGain.length>E&&j.recentGain.shift(),h=tt?0:h+1,x>0&&x--}g*=i.coolingRate}if(M>=T?b++:b=0,r){const A=gt(u,e,n,o);if(A)r(A.score,p);else{const N=ut(u,e,new Map(u.map(G=>[G.id,G])));N.totalScore<1/0&&r(N,p)}}if(b>5&&g>i.minTemp){g=Math.min(i.initialTemp*.5,g*3),c=u.map(N=>({...N})),l=at(c,e,n,o,i.useFastScore);const A=so(u,M,e,n,o,i.useFastScore,v,F,s,d);A&&(c=A.machines,l=A.score),d++,b=0}g>i.minTemp&&!S()?setTimeout(C,0):a(u)}setTimeout(C,0)})}function so(t,e,n,o,i,r,a,c,s,l){const f=["critical_net_focus","cluster_destroy_repair","port_facing_jump","joint_move_rotate"],M=2+Math.min(2,l%2);let u=null;for(let y=0;y<M;y++){let g=t.map(d=>({...d}));const p=3+(l+y)%4;for(let d=0;d<p;d++){const h=f[(d+l+y)%f.length];g=Re(g,n,o,i,a,c,h,s)}const b=at(g,n,o,i,r);Number.isFinite(b)&&(!u||b<u.score)&&(u={machines:g,score:b})}return u}function ao(t,e,n,o,i,r){const a=Math.max(1e-6,n-o);let l=Math.max(0,Math.min(1,(e-o)/a))>=.45?t.largeMoveRateEarly:t.largeMoveRateLate;i>Math.max(30,Math.floor(t.adaptiveStagnationResetWindow*.6))&&(l=Math.max(l,t.largeMoveRateEarly)),r>0&&(l=0);const f=Math.max(1e-6,Math.max(t.largeMoveRate,t.criticalNetRate)),M=Math.max(0,Math.min(1,t.criticalNetRate/f)),u=l*M;return{...t,largeMoveRate:l,criticalNetRate:u}}function co(t,e){if(t.length===0)return 0;let n=0,o=0,i=1;for(let r=t.length-1;r>=0;r--){const a=Math.max(0,t[r]);n+=a*i,o+=i,i*=e}return o>0?n/o:0}function _t(t){if(t.length===0)return[];const e=t.map(o=>Number.isFinite(o)&&o>0?o:0),n=e.reduce((o,i)=>o+i,0);return n<=1e-12?e.map(()=>1/e.length):e.map(o=>o/n)}function Ye(t,e,n){const o=t.length;if(o===0)return[];const i=Math.max(1/o,Math.min(1,n)),r=e.map(u=>Math.max(0,Math.min(i,u))),a=r.reduce((u,y)=>u+y,0);if(a>=1-1e-9)return _t(r);const c=_t(t),s=r.slice();let l=Math.max(0,1-a),f=Array.from({length:o},(u,y)=>y).filter(u=>s[u]<i-1e-9),M=0;for(;l>1e-9&&f.length>0&&M<o*6;){M++;const u=f.reduce((d,h)=>d+c[h],0),y=u<=1e-12,g=y?f.length:u;let p=0,b=!1;for(const d of f){const h=y?1:c[d],x=l*(h/g),v=i-s[d],I=Math.min(v,x);s[d]+=I,p+=I,v-I<=1e-9&&(b=!0)}if(p<=1e-12||(l=Math.max(0,1-s.reduce((d,h)=>d+h,0)),!b))break;f=f.filter(d=>s[d]<i-1e-9)}if(l>1e-9){const u=Array.from({length:o},(y,g)=>g).filter(y=>s[y]<i-1e-9);if(u.length>0){const y=l/u.length;for(const g of u)s[g]+=Math.min(i-s[g],y)}}return _t(s)}function lo(t,e){const n=_t(t),o=e();let i=0;for(let r=0;r<n.length;r++)if(i+=n[r],o<=i)return r;return Math.max(0,n.length-1)}function at(t,e,n,o,i){for(let a=0;a<t.length;a++){const c=_(t[a]);if(t[a].x<0||t[a].y<0||t[a].x+c.width>n||t[a].y+c.height>o)return 1/0;for(let s=a+1;s<t.length;s++)if(ke(t[a],t[s]))return 1/0}const r=new Map(t.map(a=>[a.id,a]));if(i)return uo(t,e,r);{const a=Qt(t,e,n,o);if(a)return bt(a).totalScore;const c=ut(t,e,r);return Number.isFinite(c.totalScore)?Ee(c,t.length,e.length).totalScore:1/0}}function uo(t,e,n){return ut(t,e,n).totalScore}function Ee(t,e,n){const o=Hn+n*Gn+e*Yn,i=t.totalBelts+o,r=i*Ce+t.boundingBoxArea*Te+t.cornerCount*Ae;return{totalBelts:i,boundingBoxArea:t.boundingBoxArea,cornerCount:t.cornerCount,totalScore:r}}function ut(t,e,n){let o=0,i=0,r=1/0,a=1/0,c=-1/0,s=-1/0;const l=(y,g)=>{r=Math.min(r,y),a=Math.min(a,g),c=Math.max(c,y),s=Math.max(s,g)},f=y=>{const g=_(y);l(y.x,y.y),l(y.x+g.width-1,y.y+g.height-1)};for(const y of t)f(y);for(const y of e){const g=n.get(y.sourceMachineId),p=n.get(y.targetMachineId);if(!g||!p)return{totalBelts:1/0,boundingBoxArea:1/0,cornerCount:1/0,totalScore:1/0};const b=L(g),d=L(p),h=b.outputs[y.sourcePortIndex],x=d.inputs[y.targetPortIndex];if(!h||!x)return{totalBelts:1/0,boundingBoxArea:1/0,cornerCount:1/0,totalScore:1/0};const v=Bt(h),I=Bt(x);l(v.x,v.y),l(I.x,I.y);const m=Math.abs(v.x-I.x),w=Math.abs(v.y-I.y);o+=m+w,m>0&&w>0&&i++}const M=r<=c&&a<=s?(c-r+1)*(s-a+1):0,u=o*Ce+M*Te+i*Ae;return{totalBelts:o,boundingBoxArea:M,cornerCount:i,totalScore:u}}function fe(t){const e=Math.max(0,Math.min(.6,t?.largeMoveRate??.15)),n=Math.max(0,Math.min(e,t?.criticalNetRate??0)),o=Math.max(0,e-n),i=o>1e-9?Math.min(.03,o*.35):0,r=n>1e-9?Math.min(.02,n*.35):0,a=Math.max(.05,1-e);return[{id:"move_toward_neighbor",baseWeight:.2*a,minProbability:.02},{id:"move_to_source",baseWeight:.12*a,minProbability:.02},{id:"port_facing_jump",baseWeight:.14*a,minProbability:.02},{id:"try_different_port",baseWeight:.12*a,minProbability:.02},{id:"random_shift",baseWeight:.13*a,minProbability:.02},{id:"swap_positions",baseWeight:.11*a,minProbability:.02},{id:"rotate_best",baseWeight:.09*a,minProbability:.02},{id:"joint_move_rotate",baseWeight:.09*a,minProbability:.02},{id:"cluster_destroy_repair",baseWeight:o,minProbability:i},{id:"critical_net_focus",baseWeight:n,minProbability:r}]}function ho(t,e){const n=t.reduce((r,a)=>r+a.baseWeight,0),o=e()*(n||1);let i=0;for(const r of t)if(i+=r.baseWeight,o<=i)return r;return t[t.length-1]}function Re(t,e,n,o,i=Math.random,r,a,c=new Set){const s=t.map(p=>({...p})),l=Oe(s,c);if(l.length===0)return s;const f=fe(r),M=a?f.find(p=>p.id===a)??f[0]:ho(f,i),u=Math.min(r?.clusterMoveMinSize??2,r?.clusterMoveMaxSize??5),y=Math.max(r?.clusterMoveMinSize??2,r?.clusterMoveMaxSize??5),g=Math.max(1,Math.floor(r?.repairBeamWidth??1));switch(M.id){case"move_toward_neighbor":Mo(s,e,n,o,i,c);break;case"move_to_source":bo(s,e,n,o,i,c);break;case"port_facing_jump":vo(s,e,n,o,i,c);break;case"try_different_port":Io(s,e,i,c);break;case"random_shift":{const p=l[Math.floor(i()*l.length)],b=Math.floor(i()*3)+1;switch(Math.floor(i()*4)){case 0:s[p].x+=b;break;case 1:s[p].x-=b;break;case 2:s[p].y+=b;break;case 3:s[p].y-=b;break}const h=_(s[p]);s[p].x=Math.max(0,Math.min(n-h.width,s[p].x)),s[p].y=Math.max(0,Math.min(o-h.height,s[p].y));break}case"swap_positions":if(l.length>1){const p=l[Math.floor(i()*l.length)],b=l.filter(v=>v!==p),d=b[Math.floor(i()*b.length)],h=s[p].x,x=s[p].y;s[p].x=s[d].x,s[p].y=s[d].y,s[d].x=h,s[d].y=x}break;case"rotate_best":{const p=l[Math.floor(i()*l.length)],b=new Map(s.map(x=>[x.id,x]));let d=s[p].orientation,h=1/0;for(const x of pt){s[p].orientation=x;const v=_(s[p]);if(s[p].x+v.width>n||s[p].y+v.height>o)continue;let I=0;for(const m of e){if(m.sourceMachineId!==s[p].id&&m.targetMachineId!==s[p].id)continue;const w=b.get(m.sourceMachineId),E=b.get(m.targetMachineId);if(!w||!E)continue;const k=L(w).outputs[m.sourcePortIndex],O=L(E).inputs[m.targetPortIndex];k&&O&&(I+=mt(k,O))}I<h&&(h=I,d=x)}s[p].orientation=d;break}case"joint_move_rotate":{const p=l[Math.floor(i()*l.length)],b=Math.floor(i()*2)+1;switch(Math.floor(i()*4)){case 0:s[p].x+=b;break;case 1:s[p].x-=b;break;case 2:s[p].y+=b;break;case 3:s[p].y-=b;break}const h=_(s[p]);s[p].x=Math.max(0,Math.min(n-h.width,s[p].x)),s[p].y=Math.max(0,Math.min(o-h.height,s[p].y)),s[p].orientation=pt[Math.floor(i()*4)];break}case"cluster_destroy_repair":je(s,e,n,o,g,i,(p,b)=>dn(p,e,n,o,u,y,b,c));break;case"critical_net_focus":je(s,e,n,o,g,i,(p,b)=>fo(p,e,n,o,u,y,b,c));break}return s}function Oe(t,e){const n=[];for(let o=0;o<t.length;o++)e.has(t[o].id)||n.push(o);return n}function dn(t,e,n,o,i,r,a,c,s){if(t.map(d=>d.id).filter(d=>!c.has(d)).length<2||e.length===0)return!1;const f=new Map(t.map(d=>[d.id,d])),M=go(e),u=s&&s.length>0?Array.from(new Set(s.filter(d=>f.has(d)&&!c.has(d)))):mo(t,M,i,r,a,c);if(u.length<2)return!1;const y=new Set(u),g=new Map;for(const d of u){const h=f.get(d);h&&g.set(d,{...h})}const p=new Set(t.filter(d=>!y.has(d.id)).map(d=>d.id)),b=u.slice().sort((d,h)=>{const x=Xe(d,e,y);return Xe(h,e,y)-x});for(const d of b){const h=f.get(d);if(!h)continue;const x=hn(h,t,e,p,n,o,a);if(!x){for(const[v,I]of g){const m=f.get(v);m&&(m.x=I.x,m.y=I.y,m.orientation=I.orientation)}return!1}h.x=x.x,h.y=x.y,h.orientation=x.orientation,p.add(d)}return!0}function je(t,e,n,o,i,r,a){const c=t.map(u=>({...u})),s=Math.max(1,Math.floor(i));let l=null,f=null;for(let u=0;u<s;u++){const y=c.map(h=>({...h})),g=s===1?r:cn((Math.floor(r()*4294967296)>>>0^(u+1)*2654435761)>>>0);if(!a(y,g))continue;const b=gt(y,e,n,o),d=b?b.score:Ee(ut(y,e,new Map(y.map(h=>[h.id,h]))),y.length,e.length);Number.isFinite(d.totalScore)&&(!f||et(d,f)<0)&&(f=d,l=y)}const M=l??c;for(let u=0;u<t.length&&u<M.length;u++)t[u].x=M[u].x,t[u].y=M[u].y,t[u].orientation=M[u].orientation}function fo(t,e,n,o,i,r,a,c){if(t.length<2||e.length===0)return!1;const s=new Map(t.map(d=>[d.id,d])),l=e.map(d=>({connection:d,pain:po(d,s)})).filter(d=>Number.isFinite(d.pain)&&d.pain>0).sort((d,h)=>h.pain-d.pain);if(l.length===0)return!1;const f=Math.max(1,Math.floor(l.length*.35)),M=l[Math.floor(a()*f)].connection,u=new Map;for(const d of l.slice(0,Math.max(f,4)))u.set(d.connection.sourceMachineId,(u.get(d.connection.sourceMachineId)??0)+d.pain),u.set(d.connection.targetMachineId,(u.get(d.connection.targetMachineId)??0)+d.pain);const y=new Set([M.sourceMachineId,M.targetMachineId]);for(const d of Array.from(y))c.has(d)&&y.delete(d);const g=Math.max(2,Math.min(Math.max(2,i),Math.min(r,4))),p=Array.from(u.entries()).sort((d,h)=>h[1]-d[1]).map(([d])=>d);for(const d of p){if(y.size>=g)break;c.has(d)||y.add(d)}if(y.size>=2&&dn(t,e,n,o,y.size,y.size,a,c,Array.from(y)))return!0;const b=[M.sourceMachineId,M.targetMachineId].filter(d=>!c.has(d)).sort((d,h)=>(u.get(h)??0)-(u.get(d)??0));for(const d of b){const h=s.get(d);if(!h)continue;const x={x:h.x,y:h.y,orientation:h.orientation},v=new Set(t.filter(m=>m.id!==d).map(m=>m.id)),I=hn(h,t,e,v,n,o,a);if(I&&(h.x=I.x,h.y=I.y,h.orientation=I.orientation,I.x!==x.x||I.y!==x.y||I.orientation!==x.orientation))return!0}return!1}function po(t,e){const n=e.get(t.sourceMachineId),o=e.get(t.targetMachineId);if(!n||!o)return 1/0;const i=L(n).outputs[t.sourcePortIndex],r=L(o).inputs[t.targetPortIndex];if(!i||!r)return 1/0;const a=Math.abs(i.x-r.x),c=Math.abs(i.y-r.y),s=a>0&&c>0?1:0;return mt(i,r)+s*2}function Xe(t,e,n){let o=0;for(const i of e)i.sourceMachineId===t&&!n.has(i.targetMachineId)&&o++,i.targetMachineId===t&&!n.has(i.sourceMachineId)&&o++;return o}function go(t){const e=new Map,n=(o,i)=>{e.has(o)||e.set(o,new Map);const r=e.get(o);r.set(i,(r.get(i)??0)+1)};for(const o of t)n(o.sourceMachineId,o.targetMachineId),n(o.targetMachineId,o.sourceMachineId);return e}function mo(t,e,n,o,i,r){const a=t.filter(u=>!r.has(u.id));if(a.length===0)return[];const c=Math.max(2,Math.min(n,a.length)),s=Math.max(c,Math.min(o,a.length)),l=c+Math.floor(i()*(s-c+1)),f=a[Math.floor(i()*a.length)].id,M=new Set([f]);for(;M.size<l;){const u=new Map;for(const b of M){const d=e.get(b);if(d)for(const[h,x]of d)M.has(h)||r.has(h)||u.set(h,(u.get(h)??0)+x)}if(u.size===0)break;const y=Array.from(u.values()).reduce((b,d)=>b+d,0);let g=i()*(y||1),p=null;for(const[b,d]of u)if(g-=d,g<=0){p=b;break}if(p||(p=u.keys().next().value??null),!p)break;M.add(p)}return Array.from(M)}function hn(t,e,n,o,i,r,a){const c=new Map(e.map(d=>[d.id,d])),s=new Set;for(const d of n)d.sourceMachineId===t.id&&o.has(d.targetMachineId)&&s.add(d.targetMachineId),d.targetMachineId===t.id&&o.has(d.sourceMachineId)&&s.add(d.sourceMachineId);const l={x:t.x,y:t.y,orientation:t.orientation};let f=l.x,M=l.y,u=l.orientation,y=1/0,g=!1;const p=(d,h,x)=>{if(t.x=d,t.y=h,t.orientation=x,!yt(t,e,o,i,r))return;const v=xo(t.id,e,n);Number.isFinite(v)&&v<y&&(y=v,f=d,M=h,u=x,g=!0)};for(const d of s){const h=c.get(d);if(!h)continue;const x=_(h);for(const v of pt){t.orientation=v;const I=_(t),m=[{x:h.x,y:h.y+x.height+1},{x:h.x+Math.floor((x.width-I.width)/2),y:h.y+x.height+1},{x:h.x,y:h.y-I.height-1},{x:h.x+Math.floor((x.width-I.width)/2),y:h.y-I.height-1},{x:h.x+x.width+1,y:h.y},{x:h.x+x.width+1,y:h.y+Math.floor((x.height-I.height)/2)},{x:h.x-I.width-1,y:h.y},{x:h.x-I.width-1,y:h.y+Math.floor((x.height-I.height)/2)}];for(const w of m)p(w.x,w.y,v)}}const b=yo(s,c,l);for(let d=0;d<24;d++){const h=pt[Math.floor(a()*pt.length)],x=Math.round(b.x+(a()*10-5)),v=Math.round(b.y+(a()*10-5));p(x,v,h)}return p(l.x,l.y,l.orientation),t.x=l.x,t.y=l.y,t.orientation=l.orientation,g?{x:f,y:M,orientation:u}:null}function yo(t,e,n){if(t.size===0)return n;let o=0,i=0,r=0;for(const a of t){const c=e.get(a);c&&(o+=c.x,i+=c.y,r++)}return r===0?n:{x:o/r,y:i/r}}function xo(t,e,n){const o=new Map(e.map(r=>[r.id,r]));let i=0;for(const r of n){if(r.sourceMachineId!==t&&r.targetMachineId!==t)continue;const a=o.get(r.sourceMachineId),c=o.get(r.targetMachineId);if(!a||!c)continue;const s=L(a).outputs[r.sourcePortIndex],l=L(c).inputs[r.targetPortIndex];if(!s||!l)return 1/0;i+=mt(s,l)}return i}function Mo(t,e,n,o,i,r){const a=Oe(t,r);if(a.length===0)return;const c=a[Math.floor(i()*a.length)],s=t[c],l=new Map;for(const d of e)d.sourceMachineId===s.id&&l.set(d.targetMachineId,(l.get(d.targetMachineId)||0)+1),d.targetMachineId===s.id&&l.set(d.sourceMachineId,(l.get(d.sourceMachineId)||0)+1);if(l.size===0)return;let f=null,M=0;for(const[d,h]of l)h>M&&(M=h,f=d);if(!f)return;const u=t.find(d=>d.id===f);if(!u)return;const y=Math.sign(u.x-s.x),g=Math.sign(u.y-s.y),p=Math.floor(i()*3)+1;s.x+=y*p,s.y+=g*p;const b=_(s);s.x=Math.max(0,Math.min(n-b.width,s.x)),s.y=Math.max(0,Math.min(o-b.height,s.y))}function bo(t,e,n,o,i,r){const a=new Map(t.map(h=>[h.id,h])),c=t.filter(h=>r.has(h.id)?!1:e.some(x=>x.targetMachineId===h.id));if(c.length===0)return;const s=c[Math.floor(i()*c.length)];let l=0,f=0,M=0;for(const h of e){if(h.targetMachineId!==s.id)continue;const x=a.get(h.sourceMachineId);x&&(l+=x.x,f+=x.y,M++)}if(M===0)return;const u=l/M,y=f/M,g=Math.sign(u-s.x),p=Math.sign(y-s.y),b=1+Math.floor(i()*2);Math.abs(u-s.x)>=Math.abs(y-s.y)?(s.x+=g*b,i()<.6&&(s.y+=p)):(s.y+=p*b,i()<.6&&(s.x+=g));const d=_(s);s.x=Math.max(0,Math.min(n-d.width,s.x)),s.y=Math.max(0,Math.min(o-d.height,s.y))}function Io(t,e,n,o){const i=new Map(t.map(h=>[h.id,h])),r=e.filter(h=>!o.has(h.sourceMachineId)||!o.has(h.targetMachineId));if(r.length===0)return;const a=r[Math.floor(n()*r.length)],c=i.get(a.sourceMachineId),s=i.get(a.targetMachineId);if(!c||!s)return;const l=be(c),f=Me(s);if(l<=0||f<=0)return;const M=new Set,u=new Set;for(const h of e)h.id!==a.id&&(h.sourceMachineId===c.id&&M.add(h.sourcePortIndex),h.targetMachineId===s.id&&u.add(h.targetPortIndex));const y=L(c).outputs,g=L(s).inputs;let p=a.sourcePortIndex,b=a.targetPortIndex,d=1/0;for(let h=0;h<l;h++){if(M.has(h))continue;const x=y[h];if(x)for(let v=0;v<f;v++){if(u.has(v))continue;const I=g[v];if(!I)continue;const m=mt(x,I);m<d&&(d=m,p=h,b=v)}}d<1/0&&(a.sourcePortIndex=p,a.targetPortIndex=b)}function vo(t,e,n,o,i,r){const a=Oe(t,r);if(a.length===0)return;const c=a[Math.floor(i()*a.length)],s=t[c],l=new Map;for(const v of e)v.sourceMachineId===s.id&&l.set(v.targetMachineId,(l.get(v.targetMachineId)||0)+1),v.targetMachineId===s.id&&l.set(v.sourceMachineId,(l.get(v.sourceMachineId)||0)+1);if(l.size===0)return;let f=null,M=0;for(const[v,I]of l)I>M&&(M=I,f=v);if(!f)return;const u=t.find(v=>v.id===f);if(!u)return;const y=_(u),g=new Map(t.map(v=>[v.id,v])),p=new Set(t.filter(v=>v.id!==s.id).map(v=>v.id));let b=1/0,d=s.x,h=s.y,x=s.orientation;for(const v of pt){s.orientation=v;const I=_(s),m=[{x:u.x,y:u.y+y.height+1},{x:u.x+Math.floor((y.width-I.width)/2),y:u.y+y.height+1},{x:u.x,y:u.y-I.height-1},{x:u.x+Math.floor((y.width-I.width)/2),y:u.y-I.height-1},{x:u.x+y.width+1,y:u.y},{x:u.x+y.width+1,y:u.y+Math.floor((y.height-I.height)/2)},{x:u.x-I.width-1,y:u.y},{x:u.x-I.width-1,y:u.y+Math.floor((y.height-I.height)/2)}];for(const w of m){if(s.x=w.x,s.y=w.y,!yt(s,t,p,n,o))continue;let E=0;for(const k of e){if(k.sourceMachineId!==s.id&&k.targetMachineId!==s.id)continue;const O=g.get(k.sourceMachineId),F=g.get(k.targetMachineId);if(!O||!F)continue;const X=L(O).outputs[k.sourcePortIndex],S=L(F).inputs[k.targetPortIndex];X&&S&&(E+=mt(X,S))}E<b&&(b=E,d=w.x,h=w.y,x=v)}}s.x=d,s.y=h,s.orientation=x}function Jt(t,e,n,o){const i=t.map(u=>({...u})),r=new Map(i.map(u=>[u.id,u])),a=e.map(u=>({...u})),c=e.map(u=>({...u})),s=new Map,l=new Map,f=c.map(u=>{const y=r.get(u.sourceMachineId),g=r.get(u.targetMachineId);if(!y||!g)return{conn:u,est:1/0};const p=L(y),b=L(g),d=p.outputs[u.sourcePortIndex],h=b.inputs[u.targetPortIndex],x=d&&h?mt(d,h):1/0;return{conn:u,est:x}});f.sort((u,y)=>y.est-u.est);for(const{conn:u}of f){const y=r.get(u.sourceMachineId),g=r.get(u.targetMachineId);if(!y||!g)continue;const p=L(y),b=L(g),d=be(y),h=Me(g);if(d<=0||h<=0)continue;const x=s.get(y.id)||new Set,v=l.get(g.id)||new Set;let I=u.sourcePortIndex,m=u.targetPortIndex,w=1/0;for(let E=0;E<d;E++)if(!x.has(E))for(let k=0;k<h;k++){if(v.has(k))continue;const O=p.outputs[E],F=b.inputs[k];if(!O||!F)continue;const X=mt(O,F);X<w&&(w=X,I=E,m=k)}u.sourcePortIndex=I,u.targetPortIndex=m,x.add(I),v.add(m),s.set(y.id,x),l.set(g.id,v)}const M=So(i,a,c,n,o);return e.length=0,e.push(...M.map(u=>({...u}))),i}function So(t,e,n,o,i){const r=gt(t,e,o,i),a=gt(t,n,o,i);if(r&&a)return et(a.score,r.score)<=0?n:e;if(a)return n;if(r)return e;const c=new Map(t.map(f=>[f.id,f])),s=ut(t,e,c),l=ut(t,n,c);return et(l,s)<=0?n:e}function wo(t,e,n,o,i=new Map){const r=t.map(h=>({...h}));ot(r,i);const a=gt(r,e,n,o),c=r.map(h=>({...h}));ot(c,i);const s=new Set(c.map(h=>h.id));let l=1/0,f=1/0;for(const h of c)i.has(h.id)||(l=Math.min(l,h.x),f=Math.min(f,h.y));if(Number.isFinite(l)&&Number.isFinite(f)){const h=l-1,x=f-1;for(const v of c)i.has(v.id)||(v.x-=h,v.y-=x)}let M=!0,u=0;for(;M&&u<30;){M=!1,u++,c.sort((h,x)=>h.x+h.y-(x.x+x.y));for(const h of c)if(!i.has(h.id)){for(;h.x>0;){if(h.x--,!yt(h,c,s,n,o)){h.x++;break}M=!0}for(;h.y>0;){if(h.y--,!yt(h,c,s,n,o)){h.y++;break}M=!0}}ot(c,i)}const y=gt(c,e,n,o);if(a&&y)return et(y.score,a.score)<=0?c:r;if(y)return c;if(a)return r;const g=new Map(r.map(h=>[h.id,h])),p=new Map(c.map(h=>[h.id,h])),b=ut(r,e,g),d=ut(c,e,p);return et(d,b)<=0?c:r}function Qt(t,e,n,o){const i=ve(n,o);for(const r of t)if(!Tt(i,r))return null;for(const r of e)i.connections.set(r.id,r);for(const r of e){const a=i.machines.get(r.sourceMachineId),c=i.machines.get(r.targetMachineId);if(!a||!c)return null;const s=L(a),l=L(c),f=s.outputs[r.sourcePortIndex],M=l.inputs[r.targetPortIndex];if(!f||!M)return null;const u=oe(i,f,M,r.id);if(!u)return null;ie(i,u)}return i}function gt(t,e,n,o){const i=Qt(t,e,n,o);return i?{grid:i,score:bt(i)}:null}const V={place:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',select:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 9l2-2 3 3L18 2"/><rect x="3" y="3" width="18" height="18" rx="2"/></svg>',connect:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="5" cy="12" r="3"/><circle cx="19" cy="12" r="3"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',delete:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',rotate:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>',optimize:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',search:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',stop:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>',save:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',folder:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>'},Ut=50;let R=ve(Ut,Ut),rt=null,Wt=Pt.M3x3,At="place",de=!1,te=!1,Rt=!1;const Po=2200,Co=12e4,qe=1e-6;let Lt=[],lt=null,ee=!1,fn=0,pn=0,pe=0,ge=0,ne=!1,Ht=!1,Be=!1,gn=0,mn=0,yn=0,xn=0,Nt=z.NORTH,me=0,ye=0;const To=document.getElementById("app");To.innerHTML=`
  <div id="toolbar">
    <div class="toolbar-group">
      <span class="toolbar-label">Mode</span>
      <button id="btn-place" class="tool-btn active" data-mode="place" title="Place Machine">
        <span class="icon">${V.place}</span> Place <kbd>P</kbd>
      </button>
      <button id="btn-select" class="tool-btn" data-mode="select" title="Select/Move">
        <span class="icon">${V.select}</span> Select <kbd>S</kbd>
      </button>
      <button id="btn-connect" class="tool-btn" data-mode="connect" title="Connect Ports">
        <span class="icon">${V.connect}</span> Connect <kbd>C</kbd>
      </button>
      <button id="btn-delete" class="tool-btn" data-mode="delete" title="Delete">
        <span class="icon">${V.delete}</span> Delete <kbd>D</kbd>
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <span class="toolbar-label">Machine</span>
      <button id="btn-3x3" class="type-btn active" data-type="3x3">3Ã—3 <kbd>1</kbd></button>
      <button id="btn-6x4" class="type-btn" data-type="6x4">6Ã—4 <kbd>2</kbd></button>
      <button id="btn-5x5" class="type-btn" data-type="5x5">5Ã—5 <kbd>3</kbd></button>
      <button id="btn-3x1" class="type-btn" data-type="3x1">3Ã—1 Anchor <kbd>4</kbd></button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <button id="btn-rotate" class="tool-btn" title="Rotate">
        <span class="icon">${V.rotate}</span> Rotate <kbd>R</kbd>
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <button id="btn-optimize" class="tool-btn optimize-btn" title="Auto-Arrange">
        <span class="icon">${V.optimize}</span> Optimize <kbd>O</kbd>
      </button>
      <button id="btn-search-deeper" class="tool-btn deep-search-btn" title="Run longer optimizer search">
        <span class="icon">${V.search}</span> Search Deeper
      </button>
      <button id="btn-stop-search" class="tool-btn stop-search-btn" title="Stop continuous deep search" disabled>
        <span class="icon">${V.stop}</span> Stop
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <span class="toolbar-label">File</span>
      <button id="btn-export" class="tool-btn" title="Export Layout">
        <span class="icon">${V.save}</span> Export
      </button>
      <button id="btn-import" class="tool-btn" title="Import Layout">
        <span class="icon">${V.folder}</span> Import
      </button>
      <input type="file" id="import-file" accept=".json" style="display:none" />
    </div>
    <div class="toolbar-divider"></div>
    <div id="score-panel">
      <span id="score-belts">Belts: 0</span>
      <span id="score-area">Area: 0</span>
      <span id="score-corners">Corners: 0</span>
      <span id="score-total">Score: 0</span>
    </div>
  </div>
  <div id="status-bar">
    <span id="status-text">Place mode â€” Click grid to place a machine</span>
    <span id="coord-text">0, 0</span>
  </div>
  <div id="canvas-container">
    <canvas id="grid-canvas"></canvas>
  </div>
`;const xt=document.getElementById("grid-canvas"),H=document.getElementById("status-text"),Ao=document.getElementById("coord-text"),W=new Ln(xt);W.camera.x=40;W.camera.y=60;const Mn=document.querySelectorAll(".tool-btn[data-mode]");Mn.forEach(t=>{t.addEventListener("click",()=>{Ot(t.dataset.mode)})});function Ot(t){At=t,lt=null,W.setGhost(null),Mn.forEach(e=>e.classList.toggle("active",e.dataset.mode===At)),re(),Z()}const bn=document.querySelectorAll(".type-btn");bn.forEach(t=>{t.addEventListener("click",()=>{zt(t.dataset.type)})});function zt(t){Wt=t,bn.forEach(e=>e.classList.toggle("active",e.dataset.type===t)),Ot("place")}document.getElementById("btn-rotate").addEventListener("click",()=>{Sn()});document.getElementById("btn-optimize").addEventListener("click",()=>{Ne("normal")});document.getElementById("btn-search-deeper").addEventListener("click",()=>{Ne("deep")});document.getElementById("btn-stop-search").addEventListener("click",()=>{Pn()});const Vt=document.getElementById("import-file");document.getElementById("btn-export").addEventListener("click",()=>{ko()});document.getElementById("btn-import").addEventListener("click",()=>{Vt.click()});Vt.addEventListener("change",()=>{const t=Vt.files?.[0];if(!t)return;const e=new FileReader;e.onload=()=>{Eo(e.result),Vt.value=""},e.readAsText(t)});function ko(){const t={version:1,gridSize:Ut,machines:Array.from(R.machines.values()),connections:Array.from(R.connections.values())},e=JSON.stringify(t,null,2),n=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=`factory-layout-${Date.now()}.json`,i.click(),URL.revokeObjectURL(o),H.textContent=`Exported ${R.machines.size} machines, ${R.connections.size} connections`}function Eo(t){try{const e=JSON.parse(t);if(!e.machines||!e.connections){H.textContent="Invalid layout file â€” missing machines or connections";return}R=ve(Ut,Ut),rt=null,W.setSelectedMachine(null);for(const n of e.machines){const o=Ro(n);o&&Tt(R,o)}for(const n of e.connections){R.connections.set(n.id,n);const o=R.machines.get(n.sourceMachineId),i=R.machines.get(n.targetMachineId);if(!o||!i)continue;const r=L(o),a=L(i),c=r.outputs[n.sourcePortIndex],s=a.inputs[n.targetPortIndex];if(!c||!s)continue;const l=oe(R,c,s,n.id);l&&ie(R,l)}It(),Z(),H.textContent=`Imported ${R.machines.size} machines, ${e.connections.length} connections`}catch{H.textContent="Failed to import â€” invalid JSON file"}}function Ro(t){if(!t||typeof t!="object")return null;const e=t,n=Ve(e.type);return!n||typeof e.id!="string"||typeof e.x!="number"||!Number.isFinite(e.x)||typeof e.y!="number"||!Number.isFinite(e.y)||!Oo(e.orientation)?null:{id:e.id,type:n,x:Math.floor(e.x),y:Math.floor(e.y),orientation:e.orientation}}function Oo(t){return t===z.NORTH||t===z.EAST||t===z.SOUTH||t===z.WEST}document.addEventListener("keydown",t=>{if(!(t.target instanceof HTMLInputElement))switch(t.key.toLowerCase()){case"p":Ot("place");break;case"s":Ot("select");break;case"c":Ot("connect");break;case"d":Ot("delete");break;case"r":At==="place"?Lo():Sn();break;case"o":Ne(t.shiftKey?"deep":"normal");break;case"1":zt(Pt.M3x3);break;case"2":zt(Pt.M6x4);break;case"3":zt(Pt.M5x5);break;case"4":zt(Pt.M3x1);break;case"escape":if(te){Pn();break}rt=null,lt=null,W.setSelectedMachine(null),W.setGhost(null),re(),Z();break}});xt.addEventListener("mousedown",t=>{const e=xt.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top;if(t.button===1||t.button===2){Be=!0,gn=t.clientX,mn=t.clientY,yn=W.camera.x,xn=W.camera.y,t.preventDefault();return}const{gx:i,gy:r}=W.screenToGrid(n,o);switch(At){case"place":Bo(i,r);break;case"select":No(i,r,t);break;case"connect":Do(i,r);break;case"delete":Fo(i,r);break}});xt.addEventListener("mousemove",t=>{const e=xt.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top,{gx:i,gy:r}=W.screenToGrid(n,o);if(Ao.textContent=`${i}, ${r}`,Be){W.camera.x=yn+(t.clientX-gn),W.camera.y=xn+(t.clientY-mn),Z();return}if(At==="place"&&(me=i,ye=r,vn(),Z()),ee&&rt){const a=R.machines.get(rt);if(!a)return;const c=32*W.camera.zoom,s=Math.round((t.clientX-fn)/c),l=Math.round((t.clientY-pn)/c),f=pe+s,M=ge+l;(f!==a.x||M!==a.y)&&(we(R,a.id),Ht||(wn(a.id),Ht=!0),a.x=f,a.y=M,Tt(R,a)||(a.x=pe,a.y=ge,Tt(R,a)),ne=!0,Z())}});function In(){ee&&rt&&Ht&&ne&&(xe(rt),It(),Z()),ee=!1,ne=!1,Ht=!1,Be=!1}xt.addEventListener("mouseup",In);window.addEventListener("mouseup",In);xt.addEventListener("wheel",t=>{t.preventDefault();const e=xt.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top,i=W.camera.zoom,r=t.deltaY>0?.9:1.1;W.camera.zoom=Math.max(.3,Math.min(3,W.camera.zoom*r)),W.camera.x=n-(n-W.camera.x)*(W.camera.zoom/i),W.camera.y=o-(o-W.camera.y)*(W.camera.zoom/i),Z()},{passive:!1});xt.addEventListener("contextmenu",t=>t.preventDefault());function Bo(t,e){const n={id:Qe(),type:Wt,x:t,y:e,orientation:Nt};Tt(R,n)&&(rt=n.id,W.setSelectedMachine(n.id),It(),Z())}function No(t,e,n){const o=R.cells[e]?.[t];if(o?.machineId){rt=o.machineId,W.setSelectedMachine(o.machineId),ee=!0,ne=!1,Ht=!1,fn=n.clientX,pn=n.clientY;const i=R.machines.get(o.machineId);pe=i.x,ge=i.y}else rt=null,W.setSelectedMachine(null);re(),Z()}function Do(t,e){const n=zo(t,e);if(!n){H.textContent="No port at this position";return}if(!lt){if(n.portType!=="OUTPUT"){H.textContent="Click an OUTPUT port (orange) first";return}if(Je(n.machineId,n.index,"output")){H.textContent="This output port already has a connection";return}lt=n,H.textContent=`Selected output port ${n.index} â€” Now click an INPUT port`;return}if(n.portType!=="INPUT"){H.textContent="Click an INPUT port (blue) to complete the connection";return}if(n.machineId===lt.machineId){H.textContent="Cannot connect a machine to itself";return}if(Je(n.machineId,n.index,"input")){H.textContent="This input port already has a connection",lt=null;return}const o={id:Qe(),sourceMachineId:lt.machineId,sourcePortIndex:lt.index,targetMachineId:n.machineId,targetPortIndex:n.index};R.connections.set(o.id,o);const i=oe(R,lt,n,o.id);i?(ie(R,i),H.textContent=`Connected! Belt length: ${i.segments.length}`):(H.textContent="No path found between these ports!",R.connections.delete(o.id)),lt=null,It(),Z()}function Fo(t,e){const n=R.cells[e]?.[t];if(n&&n.machineId){const o=n.machineId,i=[];for(const[r,a]of R.connections)(a.sourceMachineId===o||a.targetMachineId===o)&&i.push(r);for(const r of i)rn(R,r),R.connections.delete(r);we(R,o),rt===o&&(rt=null,W.setSelectedMachine(null)),It(),Z()}}function vn(){if(At!=="place"){W.setGhost(null);return}const e=Se(R,{type:Wt,x:me,y:ye,orientation:Nt});W.setGhost({gx:me,gy:ye,type:Wt,orientation:Nt,valid:e})}function Lo(){const t=[z.NORTH,z.EAST,z.SOUTH,z.WEST],e=t.indexOf(Nt);Nt=t[(e+1)%4],vn(),re(),Z()}function zo(t,e){for(const n of R.machines.values()){const{inputs:o,outputs:i}=L(n);for(const r of[...o,...i])if(r.x===t&&r.y===e)return r}return null}function Je(t,e,n){for(const o of R.connections.values())if(n==="input"&&o.targetMachineId===t&&o.targetPortIndex===e||n==="output"&&o.sourceMachineId===t&&o.sourcePortIndex===e)return!0;return!1}function Sn(){if(!rt)return;const t=R.machines.get(rt);if(!t)return;const e=[z.NORTH,z.EAST,z.SOUTH,z.WEST],n=e.indexOf(t.orientation),o=e[(n+1)%4];we(R,t.id),wn(t.id),t.orientation=o,Se(R,t)?(Tt(R,t),xe(t.id)):(t.orientation=e[n],Tt(R,t),xe(t.id)),It(),Z()}function wn(t){for(const[e,n]of R.connections)(n.sourceMachineId===t||n.targetMachineId===t)&&rn(R,e)}function xe(t){for(const[e,n]of R.connections)if(n.sourceMachineId===t||n.targetMachineId===t){const o=R.machines.get(n.sourceMachineId),i=R.machines.get(n.targetMachineId);if(!o||!i)continue;const r=L(o),a=L(i),c=r.outputs[n.sourcePortIndex],s=a.inputs[n.targetPortIndex];if(!c||!s)continue;const l=oe(R,c,s,e);l&&ie(R,l)}}async function Ne(t="normal"){if(de)return;if(R.machines.size===0){H.textContent="No machines to optimize!";return}const e=document.getElementById("btn-optimize"),n=document.getElementById("btn-search-deeper"),o=document.getElementById("btn-stop-search"),i=bt(R).totalScore,r=t==="deep";r&&(Lt=[]),de=!0,te=r,Rt=!1,e.disabled=!0,n.disabled=!0,o.disabled=!r,e.innerHTML=r?`${V.optimize} Optimize`:`${V.optimize} Optimizing...`,n.innerHTML=r?`${V.search} Searching...`:`${V.search} Search Deeper`,o.innerHTML=`${V.stop} Stop`,H.textContent=r?"Search Deeper started â€” running continuously from current layout...":"Running optimizer...";try{if(!r){const g=await $e(R,{mode:"normal"},(p,b,d)=>{H.textContent=`${d} â€” iter ${b} | belts: ${p.totalBelts} | area: ${p.boundingBoxArea} | score: ${p.totalScore.toFixed(1)}`});R=g.grid,It(),H.textContent=`Optimization complete! ${g.iterations} iterations, score: ${g.score.totalScore.toFixed(1)}`,Z();return}const a=performance.now();let c=a,s=i,l=0,f=0,M=!1;for(;!Rt;){f++;const g=f,p={mode:"deep",timeBudgetMs:Po,useExplorationSeeds:!0,phase1Restarts:2,phase2Attempts:2,localPolishPasses:2,persistEliteArchive:!0,incomingEliteArchive:Lt,adaptiveWarmupIterations:100,adaptiveMaxOperatorProb:.45,adaptiveStagnationResetWindow:160,adaptiveFlattenFactor:.55,largeMoveRate:.02,largeMoveRateEarly:.03,largeMoveRateLate:.005,largeMoveCooldownAfterImprove:70,criticalNetRate:.005,repairBeamWidth:1},b=await $e(R,p,(x,v,I)=>{const m=performance.now()-a,w=performance.now()-c,E=Math.min(s,x.totalScore);H.textContent=`Search Deeper #${g} â€” ${I} iter ${v} | best ${E.toFixed(1)} | elapsed ${wt(m)} | idle ${wt(w)}`});l+=b.iterations,R=b.grid,It(),Z(),Lt=$o(p.outgoingEliteArchive)??Lt,b.score.totalScore+qe<s&&(s=b.score.totalScore,c=performance.now());const d=performance.now()-a,h=performance.now()-c;if(h>=Co){M=!0;break}H.textContent=`Search Deeper cycle ${g} complete | best ${s.toFixed(1)} | elapsed ${wt(d)} | idle ${wt(h)} | continuing...`}const u=performance.now()-a,y=s+qe<i;M?H.textContent=y?`Search Deeper auto-stopped (plateau) â€” improved ${i.toFixed(1)} â†’ ${s.toFixed(1)} in ${wt(u)}`:`Search Deeper auto-stopped (plateau) â€” no improvement after ${wt(u)} (best ${s.toFixed(1)})`:Rt?H.textContent=y?`Search Deeper stopped â€” improved ${i.toFixed(1)} â†’ ${s.toFixed(1)} in ${wt(u)}`:`Search Deeper stopped â€” no better layout found (best ${s.toFixed(1)})`:H.textContent=y?`Search Deeper complete â€” improved ${i.toFixed(1)} â†’ ${s.toFixed(1)} in ${l} iterations`:`Search Deeper complete â€” no better layout found (score ${s.toFixed(1)})`}catch(a){console.error(a),H.textContent=r?"Search Deeper failed":"Optimization failed"}finally{de=!1,te=!1,Rt=!1,Lt=[],e.disabled=!1,n.disabled=!1,o.disabled=!0,e.innerHTML=`${V.optimize} Optimize`,n.innerHTML=`${V.search} Search Deeper`,o.innerHTML=`${V.stop} Stop`}}function Pn(){if(!te||Rt)return;Rt=!0;const t=document.getElementById("btn-stop-search");t.disabled=!0,t.innerHTML=`${V.stop} Stopping...`,H.textContent="Stopping Search Deeper after current chunk..."}function wt(t){const e=Math.max(0,Math.floor(t/1e3)),n=Math.floor(e/60),o=e%60;return`${n}:${o.toString().padStart(2,"0")}`}function $o(t){if(!Array.isArray(t))return null;const e=[];for(const n of t){if(!n||typeof n!="object")continue;const o=n.machines,i=n.connections;!Array.isArray(o)||!Array.isArray(i)||e.push({machines:o,connections:i})}return e}function It(){const t=bt(R);document.getElementById("score-belts").textContent=`Belts: ${t.totalBelts}`,document.getElementById("score-area").textContent=`Area: ${t.boundingBoxArea}`,document.getElementById("score-corners").textContent=`Corners: ${t.cornerCount}`,document.getElementById("score-total").textContent=`Score: ${t.totalScore.toFixed(1)}`}function re(){switch(At){case"place":H.textContent=`Place mode â€” ${Wt} [${Nt}] â€” R to rotate, click to place`;break;case"select":H.textContent=rt?"Selected machine â€” Drag to move, R to rotate":"Select mode â€” Click a machine to select it";break;case"connect":H.textContent=lt?"Click an INPUT port (blue) to complete the connection":"Connect mode â€” Click an OUTPUT port (orange) to start";break;case"delete":H.textContent="Delete mode â€” Click a machine to delete it";break}}let he=!1;function Z(){he||(he=!0,requestAnimationFrame(()=>{W.render(R),he=!1}))}Z();</script>
  <style rel="stylesheet" crossorigin>@import"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap";*{margin:0;padding:0;box-sizing:border-box}:root{--bg-primary: #0f0f1a;--bg-secondary: #1a1a2e;--bg-tertiary: #252542;--accent-primary: #5b57d1;--accent-hover: #7b78e8;--accent-glow: rgba(91, 87, 209, .3);--text-primary: #e0e0ff;--text-secondary: #9090b0;--text-muted: #606080;--border-color: #303060;--success: #7bc950;--warning: #ffd166;--danger: #e05656;--info: #5bc0eb;--radius: 8px;--toolbar-height: 52px;--status-height: 32px}html,body{width:100%;height:100%;overflow:hidden;background:var(--bg-primary);color:var(--text-primary);font-family:Inter,system-ui,-apple-system,sans-serif}#app{width:100%;height:100%;display:flex;flex-direction:column}#toolbar{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);height:var(--toolbar-height);flex-shrink:0;z-index:10}.toolbar-group{display:flex;align-items:center;gap:4px}.toolbar-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-right:4px}.toolbar-divider{width:1px;height:28px;background:var(--border-color);margin:0 4px}.tool-btn{display:flex;align-items:center;gap:4px;padding:6px 12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius);color:var(--text-secondary);font-family:Inter,sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s ease;white-space:nowrap}.tool-btn:hover{background:var(--accent-primary);color:#fff;border-color:var(--accent-hover)}.tool-btn.active{background:var(--accent-primary);color:#fff;border-color:var(--accent-hover);box-shadow:0 0 12px var(--accent-glow)}.tool-btn:disabled{opacity:.5;cursor:not-allowed}.tool-btn .icon{display:inline-flex;align-items:center;vertical-align:middle}.tool-btn .icon svg,.tool-btn svg{display:inline-block;vertical-align:middle}.tool-btn kbd,.type-btn kbd{display:inline-block;padding:1px 5px;margin-left:4px;font-family:JetBrains Mono,monospace;font-size:10px;font-weight:600;line-height:1.4;color:var(--text-muted);background:#ffffff0f;border:1px solid rgba(255,255,255,.1);border-radius:3px;vertical-align:baseline}.tool-btn.active kbd,.type-btn.active kbd{color:#fff9;background:#ffffff1a;border-color:#ffffff26}.optimize-btn{background:linear-gradient(135deg,#2d6b3f,#1a4a2d);border-color:#3d8b4f}.optimize-btn:hover{background:linear-gradient(135deg,#3d8b4f,#2d6b3f);border-color:#4dab5f;box-shadow:0 0 16px #3d8b4f66}.deep-search-btn{background:linear-gradient(135deg,#2a5f85,#1a3d57);border-color:#3a7ca8}.deep-search-btn:hover{background:linear-gradient(135deg,#3a7ca8,#2a5f85);border-color:#4e95c8;box-shadow:0 0 16px #3a7ca866}.stop-search-btn{background:linear-gradient(135deg,#8c2e35,#641f24);border-color:#ad3c45}.stop-search-btn:hover{background:linear-gradient(135deg,#ad3c45,#8c2e35);border-color:#c94f58;box-shadow:0 0 16px #ad3c4566}.type-btn{display:flex;align-items:center;gap:4px;padding:6px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius);color:var(--text-secondary);font-family:JetBrains Mono,monospace;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s ease;white-space:nowrap}.type-btn:hover{border-color:var(--info);color:var(--info)}.type-btn.active{background:#5bc0eb26;border-color:var(--info);color:var(--info);box-shadow:0 0 10px #5bc0eb33}#score-panel{display:flex;align-items:center;gap:12px;margin-left:auto;font-family:JetBrains Mono,monospace;font-size:11px;color:var(--text-secondary)}#score-panel span{padding:4px 8px;background:var(--bg-tertiary);border-radius:4px;border:1px solid var(--border-color)}#score-total{color:var(--warning)!important;border-color:#ffd1664d!important;font-weight:600}#status-bar{display:flex;align-items:center;justify-content:space-between;padding:4px 12px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-color);height:var(--status-height);flex-shrink:0;font-size:12px}#status-text{color:var(--text-secondary)}#coord-text{font-family:JetBrains Mono,monospace;color:var(--text-muted);font-size:11px}#canvas-container{flex:1;overflow:hidden;position:relative;cursor:crosshair}#grid-canvas{display:block;width:100%;height:100%}</style>
</head>

<body>
  <div id="app"></div>
</body>

</html>