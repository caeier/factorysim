<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Factory Grid Simulator - Place machines, connect with belts, and optimize layouts" />
  <title>Factory Grid Simulator</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš™</text></svg>" />
  <script type="module" crossorigin>(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();var wt=(t=>(t.M3x3="3x3",t.M5x3="5x3",t.M5x5="5x5",t))(wt||{}),Y=(t=>(t.NORTH="NORTH",t.EAST="EAST",t.SOUTH="SOUTH",t.WEST="WEST",t))(Y||{}),Qt=(t=>(t.INPUT="INPUT",t.OUTPUT="OUTPUT",t))(Qt||{}),V=(t=>(t.EMPTY="EMPTY",t.MACHINE="MACHINE",t.BELT="BELT",t))(V||{}),at=(t=>(t.UP="UP",t.DOWN="DOWN",t.LEFT="LEFT",t.RIGHT="RIGHT",t))(at||{});const we={"3x3":{baseWidth:3,baseHeight:3},"5x3":{baseWidth:5,baseHeight:3},"5x5":{baseWidth:5,baseHeight:5}};function H(t){const o=we[t.type];return t.orientation==="EAST"||t.orientation==="WEST"?{width:o.baseHeight,height:o.baseWidth}:{width:o.baseWidth,height:o.baseHeight}}function te(t){return we[t.type].baseWidth}function Ce(t){switch(t){case"UP":return"DOWN";case"DOWN":return"UP";case"LEFT":return"RIGHT";case"RIGHT":return"LEFT"}}function Ee(t){switch(t){case"UP":return{dx:0,dy:-1};case"DOWN":return{dx:0,dy:1};case"LEFT":return{dx:-1,dy:0};case"RIGHT":return{dx:1,dy:0}}}function Te(t){switch(t){case"NORTH":return"UP";case"EAST":return"RIGHT";case"SOUTH":return"DOWN";case"WEST":return"LEFT"}}function tn(t){return Ce(Te(t))}let en=1;function Ae(){return`id_${en++}`}function se(t,o){const n=[];for(let e=0;e<o;e++){n[e]=[];for(let i=0;i<t;i++)n[e][i]={type:V.EMPTY,beltConnectionIds:[]}}return{width:t,height:o,cells:n,machines:new Map,connections:new Map,beltPaths:new Map}}function Bt(t,o,n){return o>=0&&n>=0&&o<t.width&&n<t.height}function ce(t,o,n){const{width:e,height:i}=H(o);for(let a=0;a<i;a++)for(let r=0;r<e;r++){const s=o.x+r,c=o.y+a;if(!Bt(t,s,c))return!1;const d=t.cells[c][s];if(d.type===V.MACHINE&&d.machineId!==n)return!1}return!0}function mt(t,o){if(!ce(t,o))return!1;const{width:n,height:e}=H(o);for(let i=0;i<e;i++)for(let a=0;a<n;a++){const r=o.x+a,s=o.y+i;t.cells[s][r]={type:V.MACHINE,machineId:o.id,beltConnectionIds:[]}}return t.machines.set(o.id,o),!0}function le(t,o){const n=t.machines.get(o);if(!n)return;const{width:e,height:i}=H(n);for(let a=0;a<i;a++)for(let r=0;r<e;r++){const s=n.x+r,c=n.y+a;t.cells[c][s]={type:V.EMPTY,beltConnectionIds:[]}}t.machines.delete(o)}function L(t){const{width:o,height:n}=H(t),e=te(t),i=Te(t.orientation),a=tn(t.orientation),r=i,s=a,c=[],d=[];for(let l=0;l<e;l++){let g,u,h,p;switch(t.orientation){case Y.NORTH:g=t.x+l,u=t.y,h=t.x+l,p=t.y+n-1;break;case Y.SOUTH:g=t.x+l,u=t.y+n-1,h=t.x+l,p=t.y;break;case Y.EAST:g=t.x+o-1,u=t.y+l,h=t.x,p=t.y+l;break;case Y.WEST:g=t.x,u=t.y+l,h=t.x+o-1,p=t.y+l;break}c.push({machineId:t.id,portType:Qt.INPUT,index:l,x:g,y:u,approachDirection:r}),d.push({machineId:t.id,portType:Qt.OUTPUT,index:l,x:h,y:p,approachDirection:s})}return{inputs:c,outputs:d}}function St(t){const o=Ee(t.approachDirection);return{x:t.x+o.dx,y:t.y+o.dy}}function jt(t){const o=[];for(let n=0;n<t.height;n++){o[n]=[];for(let e=0;e<t.width;e++){const i=t.cells[n][e];o[n][e]={type:i.type,machineId:i.machineId,beltConnectionIds:[...i.beltConnectionIds]}}}return{width:t.width,height:t.height,cells:o,machines:new Map(Array.from(t.machines.entries()).map(([n,e])=>[n,{...e}])),connections:new Map(Array.from(t.connections.entries()).map(([n,e])=>[n,{...e}])),beltPaths:new Map(Array.from(t.beltPaths.entries()).map(([n,e])=>[n,{connectionId:e.connectionId,segments:e.segments.map(i=>({...i}))}]))}}class nn{heap=[];comparator;constructor(o){this.comparator=o}get size(){return this.heap.length}push(o){this.heap.push(o),this.bubbleUp(this.heap.length-1)}pop(){if(this.heap.length===0)return;const o=this.heap[0],n=this.heap.pop();return this.heap.length>0&&(this.heap[0]=n,this.sinkDown(0)),o}peek(){return this.heap[0]}bubbleUp(o){for(;o>0;){const n=o-1>>1;if(this.comparator(this.heap[o],this.heap[n])<0)[this.heap[o],this.heap[n]]=[this.heap[n],this.heap[o]],o=n;else break}}sinkDown(o){const n=this.heap.length;for(;;){let e=o;const i=2*o+1,a=2*o+2;if(i<n&&this.comparator(this.heap[i],this.heap[e])<0&&(e=i),a<n&&this.comparator(this.heap[a],this.heap[e])<0&&(e=a),e!==o)[this.heap[o],this.heap[e]]=[this.heap[e],this.heap[o]],o=e;else break}}}function Rt(t,o,n,e){return Math.abs(t-n)+Math.abs(o-e)}function qt(t,o){return`${t},${o}`}const on=[at.UP,at.DOWN,at.LEFT,at.RIGHT];function rn(t,o,n,e,i){const a=t.cells[e][n];if(a.type!==V.BELT||a.beltConnectionIds.length===0)return!1;const r=t.cells[o.y][o.x];if(r.type!==V.BELT||r.beltConnectionIds.length===0)return!1;for(const s of a.beltConnectionIds)if(s!==i&&r.beltConnectionIds.includes(s))return!0;return!1}function Gt(t,o,n,e){const i=St(o),a=St(n);if(!Bt(t,i.x,i.y)||!Bt(t,a.x,a.y)||t.cells[i.y][i.x].type===V.MACHINE||t.cells[a.y][a.x].type===V.MACHINE)return null;const r=o.approachDirection,s=new nn((g,u)=>g.f-u.f),c=new Set,d=new Map,l={x:i.x,y:i.y,g:0,h:Rt(i.x,i.y,a.x,a.y),f:Rt(i.x,i.y,a.x,a.y),parent:null,direction:r};for(s.push(l),d.set(qt(i.x,i.y),0);s.size>0;){const g=s.pop(),u=qt(g.x,g.y);if(g.x===a.x&&g.y===a.y)return an(g,e);if(!c.has(u)){c.add(u);for(const h of on){const p=Ee(h),f=g.x+p.dx,y=g.y+p.dy,m=qt(f,y);if(c.has(m)||!Bt(t,f,y))continue;const b=t.cells[y][f];if(b.type===V.MACHINE||rn(t,g,f,y,e))continue;const I=g.direction!==null&&g.direction!==h?2:0,v=b.type===V.BELT?.5:0,M=g.g+1+I+v,P=d.get(m);P!==void 0&&M>=P||(d.set(m,M),s.push({x:f,y,g:M,h:Rt(f,y,a.x,a.y),f:M+Rt(f,y,a.x,a.y),parent:g,direction:h}))}}}return null}function st(t,o){const n=St(t),e=St(o);return Math.abs(n.x-e.x)+Math.abs(n.y-e.y)}function an(t,o){const n=[];let e=t;for(;e!==null;)n.unshift({x:e.x,y:e.y,fromDirection:e.parent?Ce(e.direction):null,toDirection:null}),e=e.parent;for(let i=0;i<n.length-1;i++){const a=n[i+1],r=a.x-n[i].x,s=a.y-n[i].y;r===1?n[i].toDirection=at.RIGHT:r===-1?n[i].toDirection=at.LEFT:s===1?n[i].toDirection=at.DOWN:s===-1&&(n[i].toDirection=at.UP)}return{connectionId:o,segments:n}}function Ut(t,o){for(const n of o.segments){const e=t.cells[n.y][n.x];e.type===V.EMPTY&&(e.type=V.BELT),e.beltConnectionIds.includes(o.connectionId)||e.beltConnectionIds.push(o.connectionId)}t.beltPaths.set(o.connectionId,o)}function Re(t,o){const n=t.beltPaths.get(o);if(n){for(const e of n.segments){const i=t.cells[e.y][e.x];i.beltConnectionIds=i.beltConnectionIds.filter(a=>a!==o),i.beltConnectionIds.length===0&&i.type===V.BELT&&(i.type=V.EMPTY)}t.beltPaths.delete(o)}}const ke=1,Oe=.5,Be=.3;function ut(t){let o=0,n=0,e=t.width,i=t.height,a=-1,r=-1;for(let d=0;d<t.height;d++)for(let l=0;l<t.width;l++)t.cells[d][l].type!==V.EMPTY&&(e=Math.min(e,l),i=Math.min(i,d),a=Math.max(a,l),r=Math.max(r,d));for(const d of t.beltPaths.values()){o+=d.segments.length;for(let l=1;l<d.segments.length;l++){const g=d.segments[l-1],u=d.segments[l];g.toDirection!==null&&u.toDirection!==null&&g.toDirection!==u.toDirection&&n++}}const s=a>=0?(a-e+1)*(r-i+1):0,c=o*ke+s*Oe+n*Be;return{totalBelts:o,boundingBoxArea:s,cornerCount:n,totalScore:c}}const K={background:"#1a1a2e",gridLine:"#1f1f38",gridLineAccent:"#2a2a50",machineBody:"#2a2960",machineBorder:"#5b57d1",machineLabel:"#c0bfff",portInput:"#5bc0eb",portOutput:"#f4845f",selectedHighlight:"#ffd166",beltColors:["#e8c547","#f4845f","#5bc0eb","#7bc950","#e056a0","#56e0d0","#c05beb","#eb5b5b"]};class sn{canvas;ctx;cellSize=32;camera={x:0,y:0,zoom:1};selectedMachineId=null;ghost=null;constructor(o){this.canvas=o,this.ctx=o.getContext("2d"),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){this.canvas.width=this.canvas.parentElement?.clientWidth||window.innerWidth,this.canvas.height=this.canvas.parentElement?.clientHeight||window.innerHeight}setSelectedMachine(o){this.selectedMachineId=o}setGhost(o){this.ghost=o}screenToGrid(o,n){const e=this.cellSize*this.camera.zoom;return{gx:Math.floor((o-this.camera.x)/e),gy:Math.floor((n-this.camera.y)/e)}}gridToScreen(o,n){const e=this.cellSize*this.camera.zoom;return{sx:o*e+this.camera.x,sy:n*e+this.camera.y}}cellCenter(o,n,e){return{cx:o*e+this.camera.x+e/2,cy:n*e+this.camera.y+e/2}}render(o){const{ctx:n,canvas:e}=this,i=this.cellSize*this.camera.zoom;n.fillStyle=K.background,n.fillRect(0,0,e.width,e.height),this.drawGridLines(o,i);for(const a of o.beltPaths.values())this.drawBeltPath(a,i,o);for(const a of o.machines.values())this.drawMachine(a,i);this.ghost&&this.drawGhost(this.ghost,i)}drawGridLines(o,n){const{ctx:e,canvas:i,camera:a}=this,r=Math.max(0,Math.floor(-a.x/n)),s=Math.max(0,Math.floor(-a.y/n)),c=Math.min(o.width,Math.ceil((i.width-a.x)/n)),d=Math.min(o.height,Math.ceil((i.height-a.y)/n));for(let l=r;l<=c;l++){const g=l*n+a.x;e.strokeStyle=l%5===0?K.gridLineAccent:K.gridLine,e.lineWidth=l%5===0?1:.5,e.beginPath(),e.moveTo(g,s*n+a.y),e.lineTo(g,d*n+a.y),e.stroke()}for(let l=s;l<=d;l++){const g=l*n+a.y;e.strokeStyle=l%5===0?K.gridLineAccent:K.gridLine,e.lineWidth=l%5===0?1:.5,e.beginPath(),e.moveTo(r*n+a.x,g),e.lineTo(c*n+a.x,g),e.stroke()}}drawMachine(o,n){const{ctx:e,camera:i}=this,{width:a,height:r}=H(o),s=this.selectedMachineId===o.id,c=o.x*n+i.x,d=o.y*n+i.y,l=a*n,g=r*n,u=3,h=6;e.fillStyle=K.machineBody,this.roundRect(c+u,d+u,l-u*2,g-u*2,h),e.fill(),e.strokeStyle=s?K.selectedHighlight:K.machineBorder,e.lineWidth=s?2.5:1.5,this.roundRect(c+u,d+u,l-u*2,g-u*2,h),e.stroke();const p=Math.max(10,n*.38);e.fillStyle=K.machineLabel,e.font=`bold ${p}px 'JetBrains Mono', monospace`,e.textAlign="center",e.textBaseline="middle",e.fillText(`${o.type} `,c+l/2,d+g/2-n*.12);const f=Math.max(8,n*.22);e.font=`${f}px 'JetBrains Mono', monospace`,e.fillStyle="#8080aa",e.fillText(o.orientation,c+l/2,d+g/2+n*.2),this.drawPorts(o,n)}drawPorts(o,n){const{ctx:e}=this,{inputs:i,outputs:a}=L(o),r=Math.max(3,n*.2);for(const s of i){const{cx:c,cy:d}=this.cellCenter(s.x,s.y,n);e.beginPath(),e.arc(c,d,r,0,Math.PI*2),e.fillStyle=K.portInput,e.fill(),e.beginPath(),e.arc(c,d,r*.4,0,Math.PI*2),e.fillStyle="#fff",e.fill()}for(const s of a){const{cx:c,cy:d}=this.cellCenter(s.x,s.y,n);e.beginPath(),e.arc(c,d,r,0,Math.PI*2),e.fillStyle=K.portOutput,e.fill(),e.beginPath(),e.arc(c,d,r*.45,0,Math.PI*2),e.fillStyle=K.machineBody,e.fill()}}drawBeltPath(o,n,e){const{ctx:i}=this;if(o.segments.length===0)return;const a=Math.abs(cn(o.connectionId))%K.beltColors.length,r=K.beltColors[a],s=Math.max(3,n*.22),c=this.buildBeltPolyline(o,n,e);if(c.length<2)return;i.strokeStyle="rgba(0,0,0,0.4)",i.lineWidth=s+3,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(c[0].x,c[0].y);for(let l=1;l<c.length;l++)i.lineTo(c[l].x,c[l].y);i.stroke(),i.strokeStyle=r,i.lineWidth=s,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(c[0].x,c[0].y);for(let l=1;l<c.length;l++)i.lineTo(c[l].x,c[l].y);i.stroke(),this.drawCrossingDots(o,n,e,r,s);const d=Math.max(2.5,n*.12);if(i.beginPath(),i.arc(c[0].x,c[0].y,d,0,Math.PI*2),i.fillStyle=r,i.fill(),c.length>=2){const l=c[c.length-1],g=c[c.length-2],u=Math.atan2(l.y-g.y,l.x-g.x),h=n*.3;i.fillStyle=r,i.beginPath(),i.moveTo(l.x+Math.cos(u)*h,l.y+Math.sin(u)*h),i.lineTo(l.x+Math.cos(u+2.4)*h*.6,l.y+Math.sin(u+2.4)*h*.6),i.lineTo(l.x+Math.cos(u-2.4)*h*.6,l.y+Math.sin(u-2.4)*h*.6),i.closePath(),i.fill()}}buildBeltPolyline(o,n,e){const i=[],a=e.connections.get(o.connectionId);if(a){const r=e.machines.get(a.sourceMachineId);if(r){const c=L(r).outputs[a.sourcePortIndex];if(c){const{cx:d,cy:l}=this.cellCenter(c.x,c.y,n);i.push({x:d,y:l})}}}for(const r of o.segments){const{cx:s,cy:c}=this.cellCenter(r.x,r.y,n);i.push({x:s,y:c})}if(a){const r=e.machines.get(a.targetMachineId);if(r){const c=L(r).inputs[a.targetPortIndex];if(c){const{cx:d,cy:l}=this.cellCenter(c.x,c.y,n);i.push({x:d,y:l})}}}return i}drawCrossingDots(o,n,e,i,a){const{ctx:r}=this;for(const s of o.segments){const c=e.cells[s.y]?.[s.x];if(!c||c.beltConnectionIds.length<2)continue;const{cx:d,cy:l}=this.cellCenter(s.x,s.y,n),g=a*.9;r.beginPath(),r.arc(d,l,g,0,Math.PI*2),r.fillStyle=i,r.fill(),r.strokeStyle="#fff",r.lineWidth=1.5,r.stroke()}}drawGhost(o,n){const{ctx:e,camera:i}=this,a={id:"__ghost__",type:o.type,x:o.gx,y:o.gy,orientation:o.orientation},{width:r,height:s}=H(a),c=o.gx*n+i.x,d=o.gy*n+i.y,l=r*n,g=s*n,u=3,h=6;e.globalAlpha=.45,e.fillStyle=o.valid?"#2a6040":"#602a2a",this.roundRect(c+u,d+u,l-u*2,g-u*2,h),e.fill(),e.strokeStyle=o.valid?"#4ae080":"#e04a4a",e.lineWidth=2,e.setLineDash([6,4]),this.roundRect(c+u,d+u,l-u*2,g-u*2,h),e.stroke(),e.setLineDash([]);const p=L(a),f=Math.max(2,n*.14);for(const b of p.inputs){const{cx:x,cy:I}=this.cellCenter(b.x,b.y,n);e.beginPath(),e.arc(x,I,f,0,Math.PI*2),e.fillStyle=K.portInput,e.fill()}for(const b of p.outputs){const{cx:x,cy:I}=this.cellCenter(b.x,b.y,n);e.beginPath(),e.arc(x,I,f,0,Math.PI*2),e.fillStyle=K.portOutput,e.fill()}e.fillStyle="#fff";const y=Math.max(9,n*.32);e.font=`bold ${y}px 'JetBrains Mono', monospace`,e.textAlign="center",e.textBaseline="middle",e.fillText(o.type,c+l/2,d+g/2-n*.08);const m=Math.max(7,n*.2);e.font=`${m}px 'JetBrains Mono', monospace`,e.fillStyle="#aaa",e.fillText(o.orientation,c+l/2,d+g/2+n*.18),e.globalAlpha=1}roundRect(o,n,e,i,a){const{ctx:r}=this;a=Math.min(a,e/2,i/2),r.beginPath(),r.moveTo(o+a,n),r.arcTo(o+e,n,o+e,n+i,a),r.arcTo(o+e,n+i,o,n+i,a),r.arcTo(o,n+i,o,n,a),r.arcTo(o,n,o+e,n,a),r.closePath()}}function cn(t){let o=0;for(let n=0;n<t.length;n++){const e=t.charCodeAt(n);o=(o<<5)-o+e,o|=0}return o}const rt=[Y.NORTH,Y.EAST,Y.SOUTH,Y.WEST],ln={initialTemp:100,coolingRate:.965,minTemp:.3,iterPerTemp:12,batchSize:50,useFastScore:!0},dn={initialTemp:30,coolingRate:.98,minTemp:.1,iterPerTemp:6,batchSize:30,useFastScore:!1},un={initialTemp:130,coolingRate:.975,minTemp:.08,iterPerTemp:16,batchSize:72,useFastScore:!0},hn={initialTemp:45,coolingRate:.985,minTemp:.04,iterPerTemp:10,batchSize:44,useFastScore:!1},fn=2e3,pn=60,mn=25;async function pe(t,o={},n){const e=gn(o),i=Ne(e.seed),a=Array.from(t.machines.values()).map(E=>({...E})),r=Array.from(t.connections.values()).map(E=>({...E}));if(a.length===0)return{grid:jt(t),score:ut(t),iterations:0};const s=t.width,c=t.height;let d=0;const l=jt(t),g=ut(t),u=performance.now(),h=Number.isFinite(e.timeBudgetMs)?u+e.timeBudgetMs:Number.POSITIVE_INFINITY,p=()=>e.mode==="deep"&&performance.now()>=h,f={largeMoveRate:e.largeMoveRate,clusterMoveMinSize:Math.min(e.clusterMoveMinSize,e.clusterMoveMaxSize),clusterMoveMaxSize:Math.max(e.clusterMoveMinSize,e.clusterMoveMaxSize),adaptiveOps:e.adaptiveOps,adaptiveWindow:e.adaptiveWindow,adaptiveWarmupIterations:e.adaptiveWarmupIterations,adaptiveMaxOperatorProb:e.adaptiveMaxOperatorProb,adaptiveStagnationResetWindow:e.adaptiveStagnationResetWindow,adaptiveFlattenFactor:e.adaptiveFlattenFactor,largeMoveRateEarly:e.largeMoveRateEarly,largeMoveRateLate:e.largeMoveRateLate,largeMoveCooldownAfterImprove:e.largeMoveCooldownAfterImprove,criticalNetRate:e.criticalNetRate,repairBeamWidth:e.repairBeamWidth},y=[],m=e.persistEliteArchive?bn(o.incomingEliteArchive):[];let b={grid:l,score:g};const x=(E,$)=>{const D=$t(E,$,s,c);if(!D)return;const U=ut(D);U.totalScore<b.score.totalScore&&(b={grid:jt(D),score:U})},I=(E,$)=>{if(e.elitePoolSize<=0)return;const D=Tn(E),X=pt(E,$,s,c)?.score.totalScore,F=Q(E,$,s,c,!0),it=Number.isFinite(X)?X:Number.isFinite(F)?F+1e3:1/0;if(Number.isFinite(it)){if(e.eliteDiversityHash||e.eliteMinDistance>0){for(const J of y){const Mt=e.eliteDiversityHash&&J.fingerprint===D,Xt=e.eliteMinDistance>0&&xe(E,J.machines)<e.eliteMinDistance;if((Mt||Xt)&&it>=J.score)return}for(let J=y.length-1;J>=0;J--){const Mt=y[J],Xt=e.eliteDiversityHash&&Mt.fingerprint===D,Qe=e.eliteMinDistance>0&&xe(E,Mt.machines)<e.eliteMinDistance;(Xt||Qe)&&y.splice(J,1)}}y.push({machines:E.map(J=>({...J})),connections:$.map(J=>({...J})),score:it,fingerprint:D}),y.sort((J,Mt)=>J.score-Mt.score),y.length>e.elitePoolSize&&y.splice(e.elitePoolSize)}},v=(E,$)=>{let D=E.map(F=>({...F}));if(y.length>0){const F=Math.min(y.length-1,Math.floor(Math.pow(i(),1.6)*y.length)),it=y[F];D=it.machines.map(J=>({...J})),r.length=0,r.push(...it.connections.map(J=>({...J})))}let U=D.map(F=>({...F}));const X=1+Math.floor(i()*2);for(let F=0;F<X;F++)U=ze(U,r,s,c,i,f);return Q(U,r,s,c,$)<1/0?U:D};if(e.persistEliteArchive&&m.length>0)for(const E of m)I(E.machines,E.connections);I(a,r);const M=e.useExplorationSeeds?[{name:"Greedy placement",machines:Sn(a,r,s,c)},{name:"Layered topology placement",machines:vn(a,r,s,c)},{name:"Current layout",machines:a.map(E=>({...E}))}]:[{name:"Current layout",machines:a.map(E=>({...E}))}];if(e.useExplorationSeeds){const E=wn(a,r,s,c);E&&M.unshift({name:"Pattern-aware placement",machines:E});const $=Pn(a,r,s,c);$&&M.push({name:"Two-layer exhaustive placement",machines:$})}let P=M[0].machines.map(E=>({...E})),O=1/0,k=1/0,N=!1,R=null;for(const E of M){if(p())break;const $=E.machines.map(F=>({...F})),D=r.map(F=>({...F}));Dt($,D,s,c),x($,D),I($,D);const U=pt($,D,s,c);U&&(!R||U.score.totalScore<R.totalScore)&&(R=U.score),U&&U.score.totalScore<k&&(k=U.score.totalScore,N=!0,P=$.map(F=>({...F})),r.length=0,r.push(...D.map(F=>({...F}))));const X=Q($,D,s,c,!0);!N&&X<O&&(O=X,P=$.map(F=>({...F})),r.length=0,r.push(...D.map(F=>({...F}))))}n&&R&&n(R,0,e.mode==="deep"?"Phase 0: Current-layout seed":"Phase 0: Seed placement");let G=P.map(E=>({...E})),S=Q(G,r,s,c,!0);const w=Math.max(1,e.phase1Restarts);let A=G.map(E=>({...E}));for(let E=0;E<w&&!p();E++){let $=0;const D=await Kt(A,r,s,c,{...e.phase1SA,random:i,shouldStop:p,operators:f},(X,F)=>{if($=F,!n)return;const it=w>1?`Phase 1: Fast SA (${E+1}/${w})`:"Phase 1: Fast SA";n(X,d+F,it)});d+=$,x(D,r),I(D,r);const U=Q(D,r,s,c,!0);U<S&&(S=U,G=D.map(X=>({...X}))),A=G.map(X=>({...X})),e.mode==="deep"&&E+1<w&&(A=v(G,!0))}const C=Dt(G,r,s,c);x(C,r),I(C,r);let B=C.map(E=>({...E})),z=Q(B,r,s,c,!1);const j=Math.max(1,e.phase2Attempts);let tt=B.map(E=>({...E}));for(let E=0;E<j&&!p();E++){let $=0;const D=await Kt(tt,r,s,c,{...e.phase2SA,random:i,shouldStop:p,operators:f},(X,F)=>{if($=F,!n)return;const it=j>1?`Phase 2: Fine-tune SA (${E+1}/${j})`:"Phase 2: Fine-tune SA";n(X,d+F,it)});d+=$,x(D,r),I(D,r);const U=Q(D,r,s,c,!1);U<z&&(z=U,B=D.map(X=>({...X}))),tt=B.map(X=>({...X})),e.mode==="deep"&&E+1<j&&(tt=v(B,!1))}const et=Dt(B,r,s,c);x(et,r),I(et,r);let q=et.map(E=>({...E}));const ht=Math.max(1,e.localPolishPasses);for(let E=0;E<ht&&!p();E++){const $=Un(q,r,s,c);if(x($,r),I($,r),q=An($,r,s,c),x(q,r),I(q,r),e.mode==="deep"&&E+1<ht){let D=0;const U=await Kt(q,r,s,c,{...e.phase2SA,initialTemp:Math.max(8,e.phase2SA.initialTemp*.55),iterPerTemp:Math.max(4,Math.floor(e.phase2SA.iterPerTemp*.65)),batchSize:Math.max(14,Math.floor(e.phase2SA.batchSize*.65)),random:i,shouldStop:p,operators:f},(X,F)=>{D=F,n&&n(X,d+F,`Phase 4: Local polish SA (${E+1}/${ht})`)});d+=D,x(U,r),I(U,r),q=U}if(n){const D=pt(q,r,s,c);if(D){const U=ht>1?`Phase 4: Compaction/orient (${E+1}/${ht})`:"Phase 4: Compaction/orient";n(D.score,d,U)}}}I(q,r);const Yt=$t(q,r,s,c);if(Yt){const E=ut(Yt);E.totalScore<b.score.totalScore&&(b={grid:Yt,score:E})}if(g.totalScore<b.score.totalScore&&(b={grid:l,score:g}),e.persistEliteArchive&&(o.outgoingEliteArchive=In(y)),n){const E=p()?"Done (time budget reached)":"Done";n(b.score,d,E)}return{grid:b.grid,score:b.score,iterations:d}}function gn(t){const o=t.mode==="deep"?"deep":"normal",n=o==="deep"?{timeBudgetMs:7e3,phase1Restarts:3,phase2Attempts:3,localPolishPasses:3,useExplorationSeeds:!1,elitePoolSize:12,eliteDiversityHash:!0,eliteMinDistance:0,largeMoveRate:.2,clusterMoveMinSize:2,clusterMoveMaxSize:5,adaptiveOps:!0,adaptiveWindow:120,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,persistEliteArchive:!1,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1,phase1SA:un,phase2SA:hn}:{timeBudgetMs:Number.POSITIVE_INFINITY,phase1Restarts:1,phase2Attempts:1,localPolishPasses:1,useExplorationSeeds:!0,elitePoolSize:8,eliteDiversityHash:!0,eliteMinDistance:0,largeMoveRate:.12,clusterMoveMinSize:2,clusterMoveMaxSize:4,adaptiveOps:!1,adaptiveWindow:100,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,persistEliteArchive:!1,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1,phase1SA:ln,phase2SA:dn},e=xt(t.largeMoveRate,n.largeMoveRate,0,.6),i=xt(t.largeMoveRateEarly,e,0,.7),a=xt(t.largeMoveRateLate,e,0,.7),r=xt(t.criticalNetRate,n.criticalNetRate,0,e);return{mode:o,timeBudgetMs:yn(t.timeBudgetMs,n.timeBudgetMs),phase1Restarts:dt(t.phase1Restarts,n.phase1Restarts),phase2Attempts:dt(t.phase2Attempts,n.phase2Attempts),localPolishPasses:dt(t.localPolishPasses,n.localPolishPasses),useExplorationSeeds:kt(t.useExplorationSeeds,n.useExplorationSeeds),elitePoolSize:dt(t.elitePoolSize,n.elitePoolSize),eliteDiversityHash:kt(t.eliteDiversityHash,n.eliteDiversityHash),eliteMinDistance:Mn(t.eliteMinDistance,n.eliteMinDistance),largeMoveRate:e,clusterMoveMinSize:dt(t.clusterMoveMinSize,n.clusterMoveMinSize),clusterMoveMaxSize:dt(t.clusterMoveMaxSize,n.clusterMoveMaxSize),adaptiveOps:kt(t.adaptiveOps,n.adaptiveOps),adaptiveWindow:dt(t.adaptiveWindow,n.adaptiveWindow),adaptiveWarmupIterations:Jt(t.adaptiveWarmupIterations,n.adaptiveWarmupIterations),adaptiveMaxOperatorProb:xt(t.adaptiveMaxOperatorProb,n.adaptiveMaxOperatorProb,.12,1),adaptiveStagnationResetWindow:Jt(t.adaptiveStagnationResetWindow,n.adaptiveStagnationResetWindow),adaptiveFlattenFactor:xt(t.adaptiveFlattenFactor,n.adaptiveFlattenFactor,0,1),persistEliteArchive:kt(t.persistEliteArchive,n.persistEliteArchive),largeMoveRateEarly:i,largeMoveRateLate:a,largeMoveCooldownAfterImprove:Jt(t.largeMoveCooldownAfterImprove,n.largeMoveCooldownAfterImprove),criticalNetRate:r,repairBeamWidth:dt(t.repairBeamWidth,n.repairBeamWidth),seed:xn(t.seed),phase1SA:n.phase1SA,phase2SA:n.phase2SA}}function dt(t,o){return typeof t!="number"||!Number.isFinite(t)?o:Math.max(1,Math.floor(t))}function Jt(t,o){return typeof t!="number"||!Number.isFinite(t)?o:Math.max(0,Math.floor(t))}function yn(t,o){return typeof t!="number"||!Number.isFinite(t)||t<=0?o:t}function Mn(t,o){return typeof t!="number"||!Number.isFinite(t)||t<0?o:t}function xt(t,o,n,e){return typeof t!="number"||!Number.isFinite(t)?o:Math.max(n,Math.min(e,t))}function kt(t,o){return typeof t!="boolean"?o:t}function xn(t){if(!(typeof t!="number"||!Number.isFinite(t)))return Math.floor(t)}function Ne(t){if(t===void 0)return Math.random;let o=t>>>0||1831565813;return()=>(o=o*1664525+1013904223>>>0,o/4294967296)}function bn(t){if(!Array.isArray(t))return[];const o=[];for(const n of t){if(!n||typeof n!="object")continue;const e=n.machines,i=n.connections;if(!Array.isArray(e)||!Array.isArray(i))continue;const a=[];for(const s of e){if(!s||typeof s!="object")continue;const c=s;typeof c.id!="string"||typeof c.type!="string"||typeof c.x!="number"||!Number.isFinite(c.x)||typeof c.y!="number"||!Number.isFinite(c.y)||typeof c.orientation!="string"||a.push({id:c.id,type:c.type,x:c.x,y:c.y,orientation:c.orientation})}const r=[];for(const s of i){if(!s||typeof s!="object")continue;const c=s;typeof c.id!="string"||typeof c.sourceMachineId!="string"||typeof c.targetMachineId!="string"||typeof c.sourcePortIndex!="number"||!Number.isFinite(c.sourcePortIndex)||typeof c.targetPortIndex!="number"||!Number.isFinite(c.targetPortIndex)||r.push({id:c.id,sourceMachineId:c.sourceMachineId,sourcePortIndex:Math.floor(c.sourcePortIndex),targetMachineId:c.targetMachineId,targetPortIndex:Math.floor(c.targetPortIndex)})}a.length===0||r.length===0||o.push({machines:a,connections:r})}return o}function In(t){return t.map(o=>({machines:o.machines.map(n=>({...n})),connections:o.connections.map(n=>({...n}))}))}function Sn(t,o,n,e){if(t.length===0)return[];const i=new Map;for(const f of t)i.set(f.id,new Map);for(const f of o){const y=i.get(f.sourceMachineId),m=i.get(f.targetMachineId);!y||!m||(y.set(f.targetMachineId,(y.get(f.targetMachineId)||0)+1),m.set(f.sourceMachineId,(m.get(f.sourceMachineId)||0)+1))}const a=new Map;for(const[f,y]of i){let m=0;for(const b of y.values())m+=b;a.set(f,m)}const r=t.map(f=>({...f})),s=new Set,c=new Map(r.map(f=>[f.id,f]));let d=null,l=0;for(const[f,y]of i)for(const[m,b]of y)b>l&&(l=b,d=[f,m]);const g=d?d[0]:t[0].id,u=c.get(g);let h=u.orientation,p=1/0;for(const f of rt){u.orientation=f;const y=H(u),m=y.width*y.height;m<p&&(p=m,h=f)}if(u.orientation=h,u.x=2,u.y=2,s.add(g),d){const f=d[1],y=c.get(f),m=me(y,u,o,r,s,n,e,c);m&&(y.x=m.x,y.y=m.y,y.orientation=m.orientation),s.add(f)}for(;s.size<r.length;){let f=null,y=-1;for(const v of r){if(s.has(v.id))continue;const M=i.get(v.id);let P=0;for(const[O,k]of M)s.has(O)&&(P+=k);(P>y||P===y&&f===null)&&(y=P,f=v.id)}f||(f=r.find(v=>!s.has(v.id)).id);const m=c.get(f),b=i.get(f),x=[];for(const[v,M]of b)s.has(v)&&x.push({id:v,count:M});x.sort((v,M)=>M.count-v.count);const I=x.length>0?x[0].id:null;if(I){let v=null;for(const P of x){const O=c.get(P.id),k=me(m,O,o,r,s,n,e,c);if(!k)continue;m.x=k.x,m.y=k.y,m.orientation=k.orientation;let N=0;for(const R of o){if(R.sourceMachineId!==m.id&&R.targetMachineId!==m.id)continue;const G=R.sourceMachineId===m.id?R.targetMachineId:R.sourceMachineId;if(!s.has(G))continue;const S=c.get(R.sourceMachineId),w=c.get(R.targetMachineId);if(!S||!w)continue;const A=L(S),C=L(w),B=A.outputs[R.sourcePortIndex],z=C.inputs[R.targetPortIndex];B&&z&&(N+=st(B,z))}(!v||N<v.cost)&&(v={x:k.x,y:k.y,orientation:k.orientation,cost:N})}const M=v;if(M)m.x=M.x,m.y=M.y,m.orientation=M.orientation;else{const P=c.get(I);ge(m,P,o,r,s,n,e,c)}}else{const v=r.find(M=>s.has(M.id));ge(m,v,o,r,s,n,e,c)}s.add(f)}return r}function me(t,o,n,e,i,a,r,s){const c=H(o);let d=null,l=1/0;for(const g of rt){t.orientation=g;const u=H(t),h=[];for(let p=-(u.width-1);p<=c.width-1;p++)h.push({x:o.x+p,y:o.y+c.height+1});for(let p=-(u.width-1);p<=c.width-1;p++)h.push({x:o.x+p,y:o.y-u.height-1});for(let p=-(u.height-1);p<=c.height-1;p++)h.push({x:o.x+c.width+1,y:o.y+p});for(let p=-(u.height-1);p<=c.height-1;p++)h.push({x:o.x-u.width-1,y:o.y+p});for(const p of h){if(t.x=p.x,t.y=p.y,!ct(t,e,i,a,r))continue;let f=0,y=!0;for(const m of n){if(m.sourceMachineId!==t.id&&m.targetMachineId!==t.id)continue;const b=s.get(m.sourceMachineId),x=s.get(m.targetMachineId);if(!b||!x)continue;const I=m.sourceMachineId===t.id?m.targetMachineId:m.sourceMachineId;if(!i.has(I)&&I!==o.id)continue;const v=L(b),M=L(x),P=v.outputs[m.sourcePortIndex],O=M.inputs[m.targetPortIndex];if(!P||!O){y=!1;break}f+=st(P,O)}y&&f<l&&(l=f,d={x:p.x,y:p.y,orientation:g})}}return d}function ge(t,o,n,e,i,a,r,s){let c=1/0,d=o.x,l=o.y+5,g=t.orientation;for(const u of rt){t.orientation=u;const h=Fe(o.x,o.y,t,e,i,a,r);if(!h)continue;t.x=h.x,t.y=h.y;let p=0;for(const f of n){if(f.sourceMachineId!==t.id&&f.targetMachineId!==t.id)continue;const y=s.get(f.sourceMachineId),m=s.get(f.targetMachineId);if(!y||!m)continue;const b=f.sourceMachineId===t.id?f.targetMachineId:f.sourceMachineId;if(!i.has(b))continue;const x=L(y),I=L(m),v=x.outputs[f.sourcePortIndex],M=I.inputs[f.targetPortIndex];v&&M&&(p+=st(v,M))}p<c&&(c=p,d=h.x,l=h.y,g=u)}t.x=d,t.y=l,t.orientation=g}function vn(t,o,n,e){if(t.length===0)return[];const i=t.map(S=>({...S,orientation:Y.NORTH})),a=new Map,r=new Map,s=new Map;for(const S of i)a.set(S.id,[]),r.set(S.id,[]),s.set(S.id,0);for(const S of o)!a.has(S.targetMachineId)||!r.has(S.sourceMachineId)||(a.get(S.targetMachineId).push(S.sourceMachineId),r.get(S.sourceMachineId).push(S.targetMachineId),s.set(S.targetMachineId,(s.get(S.targetMachineId)||0)+1));const c=new Map;for(const S of i)c.set(S.id,(a.get(S.id)?.length||0)+(r.get(S.id)?.length||0));const d=i.map(S=>S.id).filter(S=>(s.get(S)||0)===0).sort((S,w)=>{const A=(c.get(w)||0)-(c.get(S)||0);return A!==0?A:S.localeCompare(w)}),l=[];for(;d.length>0;){const S=d.shift();l.push(S);for(const w of r.get(S)||[])s.set(w,(s.get(w)||0)-1),(s.get(w)||0)===0&&d.push(w);d.sort((w,A)=>{const C=(c.get(A)||0)-(c.get(w)||0);return C!==0?C:w.localeCompare(A)})}if(l.length<i.length){const S=i.map(w=>w.id).filter(w=>!l.includes(w)).sort((w,A)=>{const C=(c.get(A)||0)-(c.get(w)||0);return C!==0?C:w.localeCompare(A)});l.push(...S)}const g=new Map;for(let S=0;S<l.length;S++)g.set(l[S],S);const u=new Map;for(const S of l){let w=0;for(const A of a.get(S)||[])w=Math.max(w,(u.get(A)||0)+1);u.set(S,w)}let h=0;for(const S of u.values())S>h&&(h=S);const p=new Map(i.map(S=>[S.id,S])),f=Array.from({length:h+1},()=>[]);for(const[S,w]of u){const A=p.get(S);A&&f[w].push(A)}for(const S of f)S.sort((w,A)=>(g.get(w.id)||0)-(g.get(A.id)||0));const y=(S,w,A)=>{if(S.length===0)return A;let C=0,B=0;for(const z of S){const j=w.get(z);j!==void 0&&(C+=j,B++)}return B>0?C/B:A};for(let S=0;S<2;S++){for(let w=1;w<=h;w++){const A=new Map;f[w-1].forEach((C,B)=>A.set(C.id,B)),f[w].sort((C,B)=>{const z=y(a.get(C.id)||[],A,g.get(C.id)||0),j=y(a.get(B.id)||[],A,g.get(B.id)||0);return z-j})}for(let w=h-1;w>=0;w--){const A=new Map;f[w+1].forEach((C,B)=>A.set(C.id,B)),f[w].sort((C,B)=>{const z=y(r.get(C.id)||[],A,g.get(C.id)||0),j=y(r.get(B.id)||[],A,g.get(B.id)||0);return z-j})}}const m=1,b=1,x=2,I=3,v=f.map(S=>{let w=0;for(const A of S)w=Math.max(w,H(A).height);return w}),M=v.reduce((S,w)=>S+w,0),P=f.length,O=e-b*2-M,k=P>1&&O>=P-1?Math.min(I,Math.floor(O/(P-1))):0;let N=b;for(let S=0;S<f.length;S++){const w=f[S];if(w.length===0)continue;const A=w.reduce((et,q)=>et+H(q).width,0),C=w.length-1,B=C>0?Math.floor((n-m*2-A)/C):0,z=C>0&&B>=1?Math.min(x,B):0,j=A+z*C;let tt=Math.max(0,Math.floor((n-j)/2));for(const et of w){const q=H(et);et.x=tt,et.y=Math.max(0,Math.min(e-q.height,N)),tt+=q.width+z}N+=v[S]+k}const R=new Set,G=i.slice().sort((S,w)=>S.y-w.y||S.x-w.x);for(const S of G){if(!ct(S,i,R,n,e)){const w=Math.max(0,Math.min(n-1,S.x)),A=Math.max(0,Math.min(e-1,S.y)),C=Fe(w,A,S,i,R,n,e);C&&(S.x=C.x,S.y=C.y)}R.add(S.id)}return i}function Pn(t,o,n,e){if(t.length<2)return null;const i=t.map(x=>({...x,orientation:Y.NORTH})),a=new Map,r=new Map,s=new Map;for(const x of i)a.set(x.id,[]),r.set(x.id,[]),s.set(x.id,0);for(const x of o)!a.has(x.targetMachineId)||!r.has(x.sourceMachineId)||(a.get(x.targetMachineId).push(x.sourceMachineId),r.get(x.sourceMachineId).push(x.targetMachineId),s.set(x.targetMachineId,(s.get(x.targetMachineId)||0)+1));const c=i.map(x=>x.id).filter(x=>(s.get(x)||0)===0),d=[];for(;c.length>0;){const x=c.shift();d.push(x);for(const I of r.get(x)||[])s.set(I,(s.get(I)||0)-1),(s.get(I)||0)===0&&c.push(I)}if(d.length!==i.length)return null;const l=new Map;for(const x of d){let I=0;for(const v of a.get(x)||[])I=Math.max(I,(l.get(v)||0)+1);l.set(x,I)}let g=0;for(const x of l.values())x>g&&(g=x);if(g!==1)return null;const u=new Map(i.map(x=>[x.id,x])),h=[],p=[];for(const[x,I]of l){const v=u.get(x);v&&(I===0?h.push(v):I===1&&p.push(v))}if(h.length===0||p.length===0||ye(h.length)*ye(p.length)>4e3)return null;const y=Me(h),m=Me(p);let b=null;for(const x of y)for(const I of m){const v=i.map(C=>({...C})),M=new Map(v.map(C=>[C.id,C])),P=x.map(C=>M.get(C.id)),O=I.map(C=>M.get(C.id)),k=P.reduce((C,B)=>Math.max(C,H(B).height),0),N=1,R=N+k+2;if(!zt(P,N,n)||!zt(O,R,n))continue;const G=new Set(v.map(C=>C.id));let S=!0;for(const C of v)if(!ct(C,v,G,n,e)){S=!1;break}if(!S)continue;const w=o.map(C=>({...C}));Dt(v,w,n,e);const A=pt(v,w,n,e);A&&(!b||A.score.totalScore<b.score)&&(b={machines:v.map(C=>({...C})),score:A.score.totalScore})}return b?b.machines:null}function zt(t,o,n){return Nt(t,o,n,2)}function Nt(t,o,n,e){if(t.length===0)return!0;const i=t.map(d=>H(d).width),a=i.reduce((d,l)=>d+l,0);let r=t.length>1?e:0;for(;r>0&&a+r*(t.length-1)>n;)r--;const s=a+r*(t.length-1);if(s>n)return!1;let c=Math.floor((n-s)/2);for(let d=0;d<t.length;d++)t[d].x=c,t[d].y=o,c+=i[d]+r;return!0}function ye(t){let o=1;for(let n=2;n<=t;n++)o*=n;return o}function Me(t){const o=[],n=new Array(t.length).fill(!1),e=[];function i(){if(e.length===t.length){o.push([...e]);return}for(let a=0;a<t.length;a++)n[a]||(n[a]=!0,e.push(t[a]),i(),e.pop(),n[a]=!1)}return i(),o}function wn(t,o,n,e){const i=Cn(t,o,n,e);if(i)return i;const a=En(t,o,n,e);return a||null}function Cn(t,o,n,e){if(t.length<6)return null;const i=t.map(M=>({...M,orientation:Y.NORTH})),a=new Map(t.map((M,P)=>[M.id,P])),r=new Map,s=new Map;for(const M of i)r.set(M.id,[]),s.set(M.id,[]);for(const M of o)!r.has(M.targetMachineId)||!s.has(M.sourceMachineId)||(r.get(M.targetMachineId).push(M.sourceMachineId),s.get(M.sourceMachineId).push(M.targetMachineId));const c=i.filter(M=>(r.get(M.id)?.length||0)===0&&(s.get(M.id)?.length||0)>0),d=i.filter(M=>(r.get(M.id)?.length||0)>0&&(s.get(M.id)?.length||0)>0),l=i.filter(M=>(r.get(M.id)?.length||0)>0&&(s.get(M.id)?.length||0)===0);if(c.length===0||d.length===0||l.length===0||c.length+d.length+l.length!==i.length)return null;const g=new Set(c.map(M=>M.id)),u=new Set(d.map(M=>M.id)),h=new Set(l.map(M=>M.id));for(const M of o)if(!(g.has(M.sourceMachineId)&&u.has(M.targetMachineId))&&!(u.has(M.sourceMachineId)&&h.has(M.targetMachineId)))return null;c.sort((M,P)=>(a.get(M.id)||0)-(a.get(P.id)||0));const p=new Map(c.map((M,P)=>[M.id,P]));if(c.length===d.length&&d.length===l.length)d.sort((M,P)=>(a.get(M.id)||0)-(a.get(P.id)||0)),l.sort((M,P)=>(a.get(M.id)||0)-(a.get(P.id)||0));else{d.sort((P,O)=>{const k=Ot(r.get(P.id)||[],p,p.size),N=Ot(r.get(O.id)||[],p,p.size);return k!==N?k-N:(a.get(P.id)||0)-(a.get(O.id)||0)});const M=new Map(d.map((P,O)=>[P.id,O]));l.sort((P,O)=>{const k=Ot(r.get(P.id)||[],M,M.size),N=Ot(r.get(O.id)||[],M,M.size);return k!==N?k-N:(a.get(P.id)||0)-(a.get(O.id)||0)})}const y=Ct(c),m=Ct(d),b=Ct(l),x=1,I=x+y+2,v=I+m+2;return v+b>e||!Nt(c,x,n,1)||!Nt(d,I,n,1)||!Nt(l,v,n,1)?null:De(i,n,e)?i:null}function En(t,o,n,e){if(t.length<8||o.length<t.length+Math.floor(t.length/3))return null;const i=t[0].type;if(t.some(M=>M.type!==i))return null;const a=t.map(M=>({...M,orientation:Y.NORTH})),r=new Map(a.map(M=>[M.id,M])),s=new Map,c=new Map,d=new Map;for(const M of a)s.set(M.id,0),c.set(M.id,0),d.set(M.id,new Map);for(const M of o){if(!r.has(M.sourceMachineId)||!r.has(M.targetMachineId))continue;c.set(M.sourceMachineId,(c.get(M.sourceMachineId)||0)+1),s.set(M.targetMachineId,(s.get(M.targetMachineId)||0)+1);const P=d.get(M.sourceMachineId);P.set(M.targetMachineId,(P.get(M.targetMachineId)||0)+1)}for(const M of a)if((s.get(M.id)||0)===0||(c.get(M.id)||0)===0)return null;const l=M=>(s.get(M)||0)+(c.get(M)||0),g=a.map(M=>M.id),u=new Set(g),h=[];let p=g[0];for(const M of g)l(M)>l(p)&&(p=M);for(;u.size>0&&(u.has(p)||(p=Array.from(u).sort((k,N)=>l(N)-l(k)||k.localeCompare(N))[0]),h.push(p),u.delete(p),u.size!==0);){const M=d.get(p);let P=null,O=-1;if(M)for(const[k,N]of M){if(!u.has(k))continue;const R=N*10+l(k);R>O&&(O=R,P=k)}P||(P=Array.from(u).sort((k,N)=>l(N)-l(k)||k.localeCompare(N))[0]),p=P}if(h.length!==a.length)return null;const f=Math.ceil(h.length/2),y=h.slice(0,f).map(M=>r.get(M)),m=h.slice(f).reverse().map(M=>r.get(M)),b=Ct(y),x=Ct(m),I=1;let v=I+b+Math.max(4,Math.floor(Math.max(b,x)*1.4));return v+x>e&&(v=e-x-1),v<=I+b||!zt(y,I,n)||!zt(m,v,n)?null:De(a,n,e)?a:null}function Ct(t){let o=0;for(const n of t)o=Math.max(o,H(n).height);return o}function Ot(t,o,n){let e=0,i=0;for(const a of t){const r=o.get(a);r!==void 0&&(e+=r,i++)}return i>0?e/i:n}function De(t,o,n){const e=new Set(t.map(i=>i.id));for(const i of t)if(!ct(i,t,e,o,n))return!1;return!0}function ct(t,o,n,e,i){const a=H(t);if(t.x<0||t.y<0||t.x+a.width>e||t.y+a.height>i)return!1;for(const r of o)if(!(r.id===t.id||!n.has(r.id))&&de(t,r))return!1;return!0}function de(t,o){const n=H(t),e=H(o);return!(t.x+n.width<=o.x||o.x+e.width<=t.x||t.y+n.height<=o.y||o.y+e.height<=t.y)}function Fe(t,o,n,e,i,a,r){for(let s=1;s<Math.max(a,r);s++)for(let c=-s;c<=s;c++)for(let d=-s;d<=s;d++)if(!(Math.abs(c)!==s&&Math.abs(d)!==s)&&(n.x=t+c,n.y=o+d,ct(n,e,i,a,r)))return{x:n.x,y:n.y};return null}function Tn(t){return t.slice().sort((o,n)=>o.id.localeCompare(n.id)).map(o=>`${o.id}:${o.x},${o.y},${o.orientation}`).join("|")}function xe(t,o){if(t.length===0||o.length===0)return 1/0;const n=new Map(o.map(a=>[a.id,a]));let e=0,i=0;for(const a of t){const r=n.get(a.id);r&&(e+=Math.abs(a.x-r.x),e+=Math.abs(a.y-r.y),e+=a.orientation===r.orientation?0:1,i++)}return i===0?1/0:e/i}function An(t,o,n,e){const i=t.map(r=>({...r}));let a=Q(i,o,n,e,!1);a===1/0&&(a=Q(i,o,n,e,!0));for(const r of i){const s=r.orientation;let c=s,d=a;for(const l of rt){if(l===s)continue;r.orientation=l;const g=H(r);if(r.x+g.width>n||r.y+g.height>e)continue;let u=!0;for(const p of i)if(p.id!==r.id&&de(r,p)){u=!1;break}if(!u)continue;const h=Q(i,o,n,e,!1);h<d&&(d=h,c=l)}r.orientation=c,a=d}return i}function Kt(t,o,n,e,i,a){return new Promise(r=>{let s=t.map(R=>({...R})),c=Q(s,o,n,e,i.useFastScore),d=s.map(R=>({...R})),l=c,g=i.initialTemp,u=0,h=0,p=0,f=0;const y=i.random??Math.random,m=i.operators??{largeMoveRate:.15,clusterMoveMinSize:2,clusterMoveMaxSize:4,adaptiveOps:!1,adaptiveWindow:80,adaptiveWarmupIterations:0,adaptiveMaxOperatorProb:1,adaptiveStagnationResetWindow:Number.MAX_SAFE_INTEGER,adaptiveFlattenFactor:0,largeMoveRateEarly:.15,largeMoveRateLate:.15,largeMoveCooldownAfterImprove:0,criticalNetRate:0,repairBeamWidth:1},b=ee(m),x=new Map;for(const R of b)x.set(R.id,{attempts:0,accepted:0,improved:0,recentGain:[]});const I=Math.max(20,m.adaptiveWindow),v=.9,M=R=>Math.max(6,R*.0125);let P=m;const O=()=>{P=Rn(m,g,i.initialTemp,i.minTemp,p,f);const R=ee(P),G=m.adaptiveOps&&u>=m.adaptiveWarmupIterations,S=R.map(z=>z.baseWeight),w=R.map(z=>z.minProbability);let A=S.slice();G&&(A=R.map((z,j)=>{const tt=x.get(z.id),et=tt?kn(tt.recentGain,v):0,q=1+Math.log1p(Math.max(0,et));return S[j]*q}));let C=be(A,w,G?m.adaptiveMaxOperatorProb:1);if(G&&m.adaptiveStagnationResetWindow>0&&p>=m.adaptiveStagnationResetWindow&&m.adaptiveFlattenFactor>0){const z=be(S,w,1);C=C.map((j,tt)=>j*(1-m.adaptiveFlattenFactor)+z[tt]*m.adaptiveFlattenFactor),C=Et(C)}const B=On(C,y);return R[B]??R[R.length-1]},k=()=>!!(i.shouldStop&&i.shouldStop()||i.maxIterations!==void 0&&u>=i.maxIterations);function N(){if(k()){r(d);return}const R=l;t:for(let G=0;G<i.batchSize&&g>i.minTemp;G++){for(let S=0;S<i.iterPerTemp;S++){if(k())break t;u++;const w=O(),A=c,C=ze(s,o,n,e,y,P,w.id),B=Q(C,o,n,e,i.useFastScore),z=x.get(w.id);z.attempts++;let j=0,tt=!1;if(B<1/0){const et=B-c;if((et<0||y()<Math.exp(-et/g))&&(s=C,c=B,j=Math.max(0,A-B),z.accepted++,B<l)){const q=l-B;l=B,d=C.map(ht=>({...ht})),z.improved++,tt=!0,m.largeMoveCooldownAfterImprove>0&&q>=M(l)&&(f=m.largeMoveCooldownAfterImprove)}}z.recentGain.push(j),z.recentGain.length>I&&z.recentGain.shift(),p=tt?0:p+1,f>0&&f--}g*=i.coolingRate}if(l>=R?h++:h=0,a){const G=pt(d,o,n,e);if(G)a(G.score,u);else{const S=Le(d,o,new Map(d.map(w=>[w.id,w])));S.totalScore<1/0&&a(S,u)}}h>5&&g>i.minTemp&&(g=Math.min(i.initialTemp*.5,g*3),s=d.map(G=>({...G})),c=l,h=0),g>i.minTemp&&!k()?setTimeout(N,0):r(d)}setTimeout(N,0)})}function Rn(t,o,n,e,i,a){const r=Math.max(1e-6,n-e);let d=Math.max(0,Math.min(1,(o-e)/r))>=.45?t.largeMoveRateEarly:t.largeMoveRateLate;i>Math.max(30,Math.floor(t.adaptiveStagnationResetWindow*.6))&&(d=Math.max(d,t.largeMoveRateEarly)),a>0&&(d=0);const l=Math.max(1e-6,Math.max(t.largeMoveRate,t.criticalNetRate)),g=Math.max(0,Math.min(1,t.criticalNetRate/l)),u=d*g;return{...t,largeMoveRate:d,criticalNetRate:u}}function kn(t,o){if(t.length===0)return 0;let n=0,e=0,i=1;for(let a=t.length-1;a>=0;a--){const r=Math.max(0,t[a]);n+=r*i,e+=i,i*=o}return e>0?n/e:0}function Et(t){if(t.length===0)return[];const o=t.map(e=>Number.isFinite(e)&&e>0?e:0),n=o.reduce((e,i)=>e+i,0);return n<=1e-12?o.map(()=>1/o.length):o.map(e=>e/n)}function be(t,o,n){const e=t.length;if(e===0)return[];const i=Math.max(1/e,Math.min(1,n)),a=o.map(u=>Math.max(0,Math.min(i,u))),r=a.reduce((u,h)=>u+h,0);if(r>=1-1e-9)return Et(a);const s=Et(t),c=a.slice();let d=Math.max(0,1-r),l=Array.from({length:e},(u,h)=>h).filter(u=>c[u]<i-1e-9),g=0;for(;d>1e-9&&l.length>0&&g<e*6;){g++;const u=l.reduce((m,b)=>m+s[b],0),h=u<=1e-12,p=h?l.length:u;let f=0,y=!1;for(const m of l){const b=h?1:s[m],x=d*(b/p),I=i-c[m],v=Math.min(I,x);c[m]+=v,f+=v,I-v<=1e-9&&(y=!0)}if(f<=1e-12||(d=Math.max(0,1-c.reduce((m,b)=>m+b,0)),!y))break;l=l.filter(m=>c[m]<i-1e-9)}if(d>1e-9){const u=Array.from({length:e},(h,p)=>p).filter(h=>c[h]<i-1e-9);if(u.length>0){const h=d/u.length;for(const p of u)c[p]+=Math.min(i-c[p],h)}}return Et(c)}function On(t,o){const n=Et(t),e=o();let i=0;for(let a=0;a<n.length;a++)if(i+=n[a],e<=i)return a;return Math.max(0,n.length-1)}function Q(t,o,n,e,i){for(let r=0;r<t.length;r++){const s=H(t[r]);if(t[r].x<0||t[r].y<0||t[r].x+s.width>n||t[r].y+s.height>e)return 1/0;for(let c=r+1;c<t.length;c++)if(de(t[r],t[c]))return 1/0}const a=new Map(t.map(r=>[r.id,r]));if(i)return _t(t,o,a);{const r=$t(t,o,n,e);if(r)return ut(r).totalScore;const s=_t(t,o,a);if(s===1/0)return 1/0;const c=fn+o.length*pn+t.length*mn;return s+c}}function _t(t,o,n){return Le(t,o,n).totalScore}function Le(t,o,n){let e=0,i=0,a=1/0,r=1/0,s=-1/0,c=-1/0;const d=(h,p)=>{a=Math.min(a,h),r=Math.min(r,p),s=Math.max(s,h),c=Math.max(c,p)},l=h=>{const p=H(h);d(h.x,h.y),d(h.x+p.width-1,h.y+p.height-1)};for(const h of t)l(h);for(const h of o){const p=n.get(h.sourceMachineId),f=n.get(h.targetMachineId);if(!p||!f)return{totalBelts:1/0,boundingBoxArea:1/0,cornerCount:1/0,totalScore:1/0};const y=L(p),m=L(f),b=y.outputs[h.sourcePortIndex],x=m.inputs[h.targetPortIndex];if(!b||!x)return{totalBelts:1/0,boundingBoxArea:1/0,cornerCount:1/0,totalScore:1/0};const I=St(b),v=St(x);d(I.x,I.y),d(v.x,v.y);const M=Math.abs(I.x-v.x),P=Math.abs(I.y-v.y);e+=M+P,M>0&&P>0&&i++}const g=a<=s&&r<=c?(s-a+1)*(c-r+1):0,u=e*ke+g*Oe+i*Be;return{totalBelts:e,boundingBoxArea:g,cornerCount:i,totalScore:u}}function ee(t){const o=Math.max(0,Math.min(.6,t?.largeMoveRate??.15)),n=Math.max(0,Math.min(o,t?.criticalNetRate??0)),e=Math.max(0,o-n),i=e>1e-9?Math.min(.03,e*.35):0,a=n>1e-9?Math.min(.02,n*.35):0,r=Math.max(.05,1-o);return[{id:"move_toward_neighbor",baseWeight:.25*r,minProbability:.02},{id:"port_facing_jump",baseWeight:.15*r,minProbability:.02},{id:"random_shift",baseWeight:.15*r,minProbability:.02},{id:"swap_positions",baseWeight:.15*r,minProbability:.02},{id:"rotate_best",baseWeight:.15*r,minProbability:.02},{id:"joint_move_rotate",baseWeight:.15*r,minProbability:.02},{id:"cluster_destroy_repair",baseWeight:e,minProbability:i},{id:"critical_net_focus",baseWeight:n,minProbability:a}]}function Bn(t,o){const n=t.reduce((a,r)=>a+r.baseWeight,0),e=o()*(n||1);let i=0;for(const a of t)if(i+=a.baseWeight,e<=i)return a;return t[t.length-1]}function ze(t,o,n,e,i=Math.random,a,r){const s=t.map(h=>({...h})),c=ee(a),d=r?c.find(h=>h.id===r)??c[0]:Bn(c,i),l=Math.min(a?.clusterMoveMinSize??2,a?.clusterMoveMaxSize??5),g=Math.max(a?.clusterMoveMinSize??2,a?.clusterMoveMaxSize??5),u=Math.max(1,Math.floor(a?.repairBeamWidth??1));switch(d.id){case"move_toward_neighbor":$n(s,o,i);break;case"port_facing_jump":Wn(s,o,n,e,i);break;case"random_shift":{const h=Math.floor(i()*s.length),p=Math.floor(i()*3)+1;switch(Math.floor(i()*4)){case 0:s[h].x+=p;break;case 1:s[h].x-=p;break;case 2:s[h].y+=p;break;case 3:s[h].y-=p;break}s[h].x=Math.max(0,Math.min(n-1,s[h].x)),s[h].y=Math.max(0,Math.min(e-1,s[h].y));break}case"swap_positions":if(s.length>1){const h=Math.floor(i()*s.length),p=(h+1+Math.floor(i()*(s.length-1)))%s.length,f=s[h].x,y=s[h].y;s[h].x=s[p].x,s[h].y=s[p].y,s[p].x=f,s[p].y=y}break;case"rotate_best":{const h=Math.floor(i()*s.length),p=new Map(s.map(m=>[m.id,m]));let f=s[h].orientation,y=1/0;for(const m of rt){s[h].orientation=m;const b=H(s[h]);if(s[h].x+b.width>n||s[h].y+b.height>e)continue;let x=0;for(const I of o){if(I.sourceMachineId!==s[h].id&&I.targetMachineId!==s[h].id)continue;const v=p.get(I.sourceMachineId),M=p.get(I.targetMachineId);if(!v||!M)continue;const P=L(v).outputs[I.sourcePortIndex],O=L(M).inputs[I.targetPortIndex];P&&O&&(x+=st(P,O))}x<y&&(y=x,f=m)}s[h].orientation=f;break}case"joint_move_rotate":{const h=Math.floor(i()*s.length),p=Math.floor(i()*2)+1;switch(Math.floor(i()*4)){case 0:s[h].x+=p;break;case 1:s[h].x-=p;break;case 2:s[h].y+=p;break;case 3:s[h].y-=p;break}s[h].x=Math.max(0,Math.min(n-1,s[h].x)),s[h].y=Math.max(0,Math.min(e-1,s[h].y)),s[h].orientation=rt[Math.floor(i()*4)];break}case"cluster_destroy_repair":Ie(s,o,n,e,u,i,(h,p)=>_e(h,o,n,e,l,g,p));break;case"critical_net_focus":Ie(s,o,n,e,u,i,(h,p)=>Nn(h,o,n,e,l,g,p));break}return s}function _e(t,o,n,e,i,a,r,s){if(t.length<2||o.length===0)return!1;const c=new Map(t.map(f=>[f.id,f])),d=Fn(o),l=s&&s.length>0?Array.from(new Set(s.filter(f=>c.has(f)))):Ln(t,d,i,a,r);if(l.length<2)return!1;const g=new Set(l),u=new Map;for(const f of l){const y=c.get(f);y&&u.set(f,{...y})}const h=new Set(t.filter(f=>!g.has(f.id)).map(f=>f.id)),p=l.slice().sort((f,y)=>{const m=Se(f,o,g);return Se(y,o,g)-m});for(const f of p){const y=c.get(f);if(!y)continue;const m=$e(y,t,o,h,n,e,r);if(!m){for(const[b,x]of u){const I=c.get(b);I&&(I.x=x.x,I.y=x.y,I.orientation=x.orientation)}return!1}y.x=m.x,y.y=m.y,y.orientation=m.orientation,h.add(f)}return!0}function Ie(t,o,n,e,i,a,r){const s=t.map(u=>({...u})),c=Math.max(1,Math.floor(i));let d=null,l=1/0;for(let u=0;u<c;u++){const h=s.map(m=>({...m})),p=c===1?a:Ne((Math.floor(a()*4294967296)>>>0^(u+1)*2654435761)>>>0);if(!r(h,p))continue;const y=Q(h,o,n,e,!1);Number.isFinite(y)&&y<l&&(l=y,d=h)}const g=d??s;for(let u=0;u<t.length&&u<g.length;u++)t[u].x=g[u].x,t[u].y=g[u].y,t[u].orientation=g[u].orientation}function Nn(t,o,n,e,i,a,r){if(t.length<2||o.length===0)return!1;const s=new Map(t.map(y=>[y.id,y])),c=o.map(y=>({connection:y,pain:Dn(y,s)})).filter(y=>Number.isFinite(y.pain)&&y.pain>0).sort((y,m)=>m.pain-y.pain);if(c.length===0)return!1;const d=Math.max(1,Math.floor(c.length*.35)),l=c[Math.floor(r()*d)].connection,g=new Map;for(const y of c.slice(0,Math.max(d,4)))g.set(y.connection.sourceMachineId,(g.get(y.connection.sourceMachineId)??0)+y.pain),g.set(y.connection.targetMachineId,(g.get(y.connection.targetMachineId)??0)+y.pain);const u=new Set([l.sourceMachineId,l.targetMachineId]),h=Math.max(2,Math.min(Math.max(2,i),Math.min(a,4))),p=Array.from(g.entries()).sort((y,m)=>m[1]-y[1]).map(([y])=>y);for(const y of p){if(u.size>=h)break;u.add(y)}if(u.size>=2&&_e(t,o,n,e,u.size,u.size,r,Array.from(u)))return!0;const f=[l.sourceMachineId,l.targetMachineId].sort((y,m)=>(g.get(m)??0)-(g.get(y)??0));for(const y of f){const m=s.get(y);if(!m)continue;const b={x:m.x,y:m.y,orientation:m.orientation},x=new Set(t.filter(v=>v.id!==y).map(v=>v.id)),I=$e(m,t,o,x,n,e,r);if(I&&(m.x=I.x,m.y=I.y,m.orientation=I.orientation,I.x!==b.x||I.y!==b.y||I.orientation!==b.orientation))return!0}return!1}function Dn(t,o){const n=o.get(t.sourceMachineId),e=o.get(t.targetMachineId);if(!n||!e)return 1/0;const i=L(n).outputs[t.sourcePortIndex],a=L(e).inputs[t.targetPortIndex];if(!i||!a)return 1/0;const r=Math.abs(i.x-a.x),s=Math.abs(i.y-a.y),c=r>0&&s>0?1:0;return st(i,a)+c*2}function Se(t,o,n){let e=0;for(const i of o)i.sourceMachineId===t&&!n.has(i.targetMachineId)&&e++,i.targetMachineId===t&&!n.has(i.sourceMachineId)&&e++;return e}function Fn(t){const o=new Map,n=(e,i)=>{o.has(e)||o.set(e,new Map);const a=o.get(e);a.set(i,(a.get(i)??0)+1)};for(const e of t)n(e.sourceMachineId,e.targetMachineId),n(e.targetMachineId,e.sourceMachineId);return o}function Ln(t,o,n,e,i){if(t.length===0)return[];const a=Math.max(2,Math.min(n,t.length)),r=Math.max(a,Math.min(e,t.length)),s=a+Math.floor(i()*(r-a+1)),c=t[Math.floor(i()*t.length)].id,d=new Set([c]);for(;d.size<s;){const l=new Map;for(const p of d){const f=o.get(p);if(f)for(const[y,m]of f)d.has(y)||l.set(y,(l.get(y)??0)+m)}if(l.size===0)break;const g=Array.from(l.values()).reduce((p,f)=>p+f,0);let u=i()*(g||1),h=null;for(const[p,f]of l)if(u-=f,u<=0){h=p;break}if(h||(h=l.keys().next().value??null),!h)break;d.add(h)}return Array.from(d)}function $e(t,o,n,e,i,a,r){const s=new Map(o.map(m=>[m.id,m])),c=new Set;for(const m of n)m.sourceMachineId===t.id&&e.has(m.targetMachineId)&&c.add(m.targetMachineId),m.targetMachineId===t.id&&e.has(m.sourceMachineId)&&c.add(m.sourceMachineId);const d={x:t.x,y:t.y,orientation:t.orientation};let l=d.x,g=d.y,u=d.orientation,h=1/0,p=!1;const f=(m,b,x)=>{if(t.x=m,t.y=b,t.orientation=x,!ct(t,o,e,i,a))return;const I=_n(t.id,o,n);Number.isFinite(I)&&I<h&&(h=I,l=m,g=b,u=x,p=!0)};for(const m of c){const b=s.get(m);if(!b)continue;const x=H(b);for(const I of rt){t.orientation=I;const v=H(t),M=[{x:b.x,y:b.y+x.height+1},{x:b.x+Math.floor((x.width-v.width)/2),y:b.y+x.height+1},{x:b.x,y:b.y-v.height-1},{x:b.x+Math.floor((x.width-v.width)/2),y:b.y-v.height-1},{x:b.x+x.width+1,y:b.y},{x:b.x+x.width+1,y:b.y+Math.floor((x.height-v.height)/2)},{x:b.x-v.width-1,y:b.y},{x:b.x-v.width-1,y:b.y+Math.floor((x.height-v.height)/2)}];for(const P of M)f(P.x,P.y,I)}}const y=zn(c,s,d);for(let m=0;m<24;m++){const b=rt[Math.floor(r()*rt.length)],x=Math.round(y.x+(r()*10-5)),I=Math.round(y.y+(r()*10-5));f(x,I,b)}return f(d.x,d.y,d.orientation),t.x=d.x,t.y=d.y,t.orientation=d.orientation,p?{x:l,y:g,orientation:u}:null}function zn(t,o,n){if(t.size===0)return n;let e=0,i=0,a=0;for(const r of t){const s=o.get(r);s&&(e+=s.x,i+=s.y,a++)}return a===0?n:{x:e/a,y:i/a}}function _n(t,o,n){const e=new Map(o.map(a=>[a.id,a]));let i=0;for(const a of n){if(a.sourceMachineId!==t&&a.targetMachineId!==t)continue;const r=e.get(a.sourceMachineId),s=e.get(a.targetMachineId);if(!r||!s)continue;const c=L(r).outputs[a.sourcePortIndex],d=L(s).inputs[a.targetPortIndex];if(!c||!d)return 1/0;i+=st(c,d)}return i}function $n(t,o,n){const e=Math.floor(n()*t.length),i=t[e],a=new Map;for(const u of o)u.sourceMachineId===i.id&&a.set(u.targetMachineId,(a.get(u.targetMachineId)||0)+1),u.targetMachineId===i.id&&a.set(u.sourceMachineId,(a.get(u.sourceMachineId)||0)+1);if(a.size===0)return;let r=null,s=0;for(const[u,h]of a)h>s&&(s=h,r=u);if(!r)return;const c=t.find(u=>u.id===r);if(!c)return;const d=Math.sign(c.x-i.x),l=Math.sign(c.y-i.y),g=Math.floor(n()*3)+1;i.x+=d*g,i.y+=l*g}function Wn(t,o,n,e,i){const a=Math.floor(i()*t.length),r=t[a],s=new Map;for(const b of o)b.sourceMachineId===r.id&&s.set(b.targetMachineId,(s.get(b.targetMachineId)||0)+1),b.targetMachineId===r.id&&s.set(b.sourceMachineId,(s.get(b.sourceMachineId)||0)+1);if(s.size===0)return;let c=null,d=0;for(const[b,x]of s)x>d&&(d=x,c=b);if(!c)return;const l=t.find(b=>b.id===c);if(!l)return;const g=H(l),u=new Map(t.map(b=>[b.id,b])),h=new Set(t.filter(b=>b.id!==r.id).map(b=>b.id));let p=1/0,f=r.x,y=r.y,m=r.orientation;for(const b of rt){r.orientation=b;const x=H(r),I=[{x:l.x,y:l.y+g.height+1},{x:l.x+Math.floor((g.width-x.width)/2),y:l.y+g.height+1},{x:l.x,y:l.y-x.height-1},{x:l.x+Math.floor((g.width-x.width)/2),y:l.y-x.height-1},{x:l.x+g.width+1,y:l.y},{x:l.x+g.width+1,y:l.y+Math.floor((g.height-x.height)/2)},{x:l.x-x.width-1,y:l.y},{x:l.x-x.width-1,y:l.y+Math.floor((g.height-x.height)/2)}];for(const v of I){if(r.x=v.x,r.y=v.y,!ct(r,t,h,n,e))continue;let M=0;for(const P of o){if(P.sourceMachineId!==r.id&&P.targetMachineId!==r.id)continue;const O=u.get(P.sourceMachineId),k=u.get(P.targetMachineId);if(!O||!k)continue;const N=L(O).outputs[P.sourcePortIndex],R=L(k).inputs[P.targetPortIndex];N&&R&&(M+=st(N,R))}M<p&&(p=M,f=v.x,y=v.y,m=b)}}r.x=f,r.y=y,r.orientation=m}function Dt(t,o,n,e){const i=t.map(u=>({...u})),a=new Map(i.map(u=>[u.id,u])),r=o.map(u=>({...u})),s=o.map(u=>({...u})),c=new Map,d=new Map,l=s.map(u=>{const h=a.get(u.sourceMachineId),p=a.get(u.targetMachineId);if(!h||!p)return{conn:u,est:1/0};const f=L(h),y=L(p),m=f.outputs[u.sourcePortIndex],b=y.inputs[u.targetPortIndex],x=m&&b?st(m,b):1/0;return{conn:u,est:x}});l.sort((u,h)=>h.est-u.est);for(const{conn:u}of l){const h=a.get(u.sourceMachineId),p=a.get(u.targetMachineId);if(!h||!p)continue;const f=L(h),y=L(p),m=te(h),b=te(p),x=c.get(h.id)||new Set,I=d.get(p.id)||new Set;let v=u.sourcePortIndex,M=u.targetPortIndex,P=1/0;for(let O=0;O<m;O++)if(!x.has(O))for(let k=0;k<b;k++){if(I.has(k))continue;const N=f.outputs[O],R=y.inputs[k];if(!N||!R)continue;const G=st(N,R);G<P&&(P=G,v=O,M=k)}u.sourcePortIndex=v,u.targetPortIndex=M,x.add(v),I.add(M),c.set(h.id,x),d.set(p.id,I)}const g=Gn(i,r,s,n,e);return o.length=0,o.push(...g.map(u=>({...u}))),i}function Gn(t,o,n,e,i){const a=pt(t,o,e,i),r=pt(t,n,e,i);if(a&&r)return r.score.totalScore<=a.score.totalScore?n:o;if(r)return n;if(a)return o;const s=new Map(t.map(l=>[l.id,l])),c=_t(t,o,s);return _t(t,n,s)<=c?n:o}function Un(t,o,n,e){const i=t.map(f=>({...f})),a=Q(i,o,n,e,!1),r=i.map(f=>({...f})),s=new Set(r.map(f=>f.id));let c=1/0,d=1/0;for(const f of r)c=Math.min(c,f.x),d=Math.min(d,f.y);const l=c-1,g=d-1;for(const f of r)f.x-=l,f.y-=g;let u=!0,h=0;for(;u&&h<30;){u=!1,h++,r.sort((f,y)=>f.x+f.y-(y.x+y.y));for(const f of r){for(;f.x>0;){if(f.x--,!ct(f,r,s,n,e)){f.x++;break}u=!0}for(;f.y>0;){if(f.y--,!ct(f,r,s,n,e)){f.y++;break}u=!0}}}return Q(r,o,n,e,!1)<=a?r:i}function $t(t,o,n,e){const i=se(n,e);for(const a of t)if(!mt(i,a))return null;for(const a of o)i.connections.set(a.id,a);for(const a of o){const r=i.machines.get(a.sourceMachineId),s=i.machines.get(a.targetMachineId);if(!r||!s)return null;const c=L(r),d=L(s),l=c.outputs[a.sourcePortIndex],g=d.inputs[a.targetPortIndex];if(!l||!g)return null;const u=Gt(i,l,g,a.id);if(!u)return null;Ut(i,u)}return i}function pt(t,o,n,e){const i=$t(t,o,n,e);return i?{grid:i,score:ut(i)}:null}const Tt=50;let T=se(Tt,Tt),nt=null,At=wt.M3x3,gt="place",Vt=!1,Wt=!1,bt=!1;const Hn=2200,Yn=12e4,ve=1e-6;let Pt=[],ot=null,ue=!1,We=0,Ge=0,ne=0,oe=0,he=!1,Ue=0,He=0,Ye=0,Xe=0,vt=Y.NORTH,ie=0,re=0;const Xn=document.getElementById("app");Xn.innerHTML=`
  <div id="toolbar">
    <div class="toolbar-group">
      <span class="toolbar-label">Mode</span>
      <button id="btn-place" class="tool-btn active" data-mode="place" title="Place Machine">
        <span class="icon">âŠž</span> Place <kbd>P</kbd>
      </button>
      <button id="btn-select" class="tool-btn" data-mode="select" title="Select/Move">
        <span class="icon">âŠ¡</span> Select <kbd>S</kbd>
      </button>
      <button id="btn-connect" class="tool-btn" data-mode="connect" title="Connect Ports">
        <span class="icon">âŸ·</span> Connect <kbd>C</kbd>
      </button>
      <button id="btn-delete" class="tool-btn" data-mode="delete" title="Delete">
        <span class="icon">âœ•</span> Delete <kbd>D</kbd>
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <span class="toolbar-label">Machine</span>
      <button id="btn-3x3" class="type-btn active" data-type="3x3">3Ã—3 <kbd>1</kbd></button>
      <button id="btn-5x3" class="type-btn" data-type="5x3">5Ã—3 <kbd>2</kbd></button>
      <button id="btn-5x5" class="type-btn" data-type="5x5">5Ã—5 <kbd>3</kbd></button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <button id="btn-rotate" class="tool-btn" title="Rotate">
        <span class="icon">â†»</span> Rotate <kbd>R</kbd>
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <button id="btn-optimize" class="tool-btn optimize-btn" title="Auto-Arrange">
        <span class="icon">âš¡</span> Optimize <kbd>O</kbd>
      </button>
      <button id="btn-search-deeper" class="tool-btn deep-search-btn" title="Run longer optimizer search">
        <span class="icon">ðŸ”</span> Search Deeper
      </button>
      <button id="btn-stop-search" class="tool-btn stop-search-btn" title="Stop continuous deep search" disabled>
        <span class="icon">â– </span> Stop
      </button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <span class="toolbar-label">File</span>
      <button id="btn-export" class="tool-btn" title="Export Layout">
        <span class="icon">ðŸ’¾</span> Export
      </button>
      <button id="btn-import" class="tool-btn" title="Import Layout">
        <span class="icon">ðŸ“‚</span> Import
      </button>
      <input type="file" id="import-file" accept=".json" style="display:none" />
    </div>
    <div class="toolbar-divider"></div>
    <div id="score-panel">
      <span id="score-belts">Belts: 0</span>
      <span id="score-area">Area: 0</span>
      <span id="score-corners">Corners: 0</span>
      <span id="score-total">Score: 0</span>
    </div>
  </div>
  <div id="status-bar">
    <span id="status-text">Place mode â€” Click grid to place a machine</span>
    <span id="coord-text">0, 0</span>
  </div>
  <div id="canvas-container">
    <canvas id="grid-canvas"></canvas>
  </div>
`;const lt=document.getElementById("grid-canvas"),W=document.getElementById("status-text"),jn=document.getElementById("coord-text"),_=new sn(lt);_.camera.x=40;_.camera.y=60;const je=document.querySelectorAll(".tool-btn[data-mode]");je.forEach(t=>{t.addEventListener("click",()=>{It(t.dataset.mode)})});function It(t){gt=t,ot=null,_.setGhost(null),je.forEach(o=>o.classList.toggle("active",o.dataset.mode===gt)),Ht(),Z()}const qe=document.querySelectorAll(".type-btn");qe.forEach(t=>{t.addEventListener("click",()=>{Ft(t.dataset.type)})});function Ft(t){At=t,qe.forEach(o=>o.classList.toggle("active",o.dataset.type===t)),It("place")}document.getElementById("btn-rotate").addEventListener("click",()=>{Ke()});document.getElementById("btn-optimize").addEventListener("click",()=>{fe("normal")});document.getElementById("btn-search-deeper").addEventListener("click",()=>{fe("deep")});document.getElementById("btn-stop-search").addEventListener("click",()=>{Ze()});const Lt=document.getElementById("import-file");document.getElementById("btn-export").addEventListener("click",()=>{qn()});document.getElementById("btn-import").addEventListener("click",()=>{Lt.click()});Lt.addEventListener("change",()=>{const t=Lt.files?.[0];if(!t)return;const o=new FileReader;o.onload=()=>{Jn(o.result),Lt.value=""},o.readAsText(t)});function qn(){const t={version:1,gridSize:Tt,machines:Array.from(T.machines.values()),connections:Array.from(T.connections.values())},o=JSON.stringify(t,null,2),n=new Blob([o],{type:"application/json"}),e=URL.createObjectURL(n),i=document.createElement("a");i.href=e,i.download=`factory-layout-${Date.now()}.json`,i.click(),URL.revokeObjectURL(e),W.textContent=`Exported ${T.machines.size} machines, ${T.connections.size} connections`}function Jn(t){try{const o=JSON.parse(t);if(!o.machines||!o.connections){W.textContent="Invalid layout file â€” missing machines or connections";return}T=se(Tt,Tt),nt=null,_.setSelectedMachine(null);for(const n of o.machines)mt(T,{...n});for(const n of o.connections){T.connections.set(n.id,n);const e=T.machines.get(n.sourceMachineId),i=T.machines.get(n.targetMachineId);if(!e||!i)continue;const a=L(e),r=L(i),s=a.outputs[n.sourcePortIndex],c=r.inputs[n.targetPortIndex];if(!s||!c)continue;const d=Gt(T,s,c,n.id);d&&Ut(T,d)}yt(),Z(),W.textContent=`Imported ${o.machines.length} machines, ${o.connections.length} connections`}catch{W.textContent="Failed to import â€” invalid JSON file"}}document.addEventListener("keydown",t=>{if(!(t.target instanceof HTMLInputElement))switch(t.key.toLowerCase()){case"p":It("place");break;case"s":It("select");break;case"c":It("connect");break;case"d":It("delete");break;case"r":gt==="place"?to():Ke();break;case"o":fe(t.shiftKey?"deep":"normal");break;case"1":Ft(wt.M3x3);break;case"2":Ft(wt.M5x3);break;case"3":Ft(wt.M5x5);break;case"escape":if(Wt){Ze();break}nt=null,ot=null,_.setSelectedMachine(null),_.setGhost(null),Ht(),Z();break}});lt.addEventListener("mousedown",t=>{const o=lt.getBoundingClientRect(),n=t.clientX-o.left,e=t.clientY-o.top;if(t.button===1||t.button===2){he=!0,Ue=t.clientX,He=t.clientY,Ye=_.camera.x,Xe=_.camera.y,t.preventDefault();return}const{gx:i,gy:a}=_.screenToGrid(n,e);switch(gt){case"place":Kn(i,a);break;case"select":Vn(i,a,t);break;case"connect":Zn(i,a);break;case"delete":Qn(i,a);break}});lt.addEventListener("mousemove",t=>{const o=lt.getBoundingClientRect(),n=t.clientX-o.left,e=t.clientY-o.top,{gx:i,gy:a}=_.screenToGrid(n,e);if(jn.textContent=`${i}, ${a}`,he){_.camera.x=Ye+(t.clientX-Ue),_.camera.y=Xe+(t.clientY-He),Z();return}if(gt==="place"&&(ie=i,re=a,Je(),Z()),ue&&nt){const r=T.machines.get(nt);if(!r)return;const s=32*_.camera.zoom,c=Math.round((t.clientX-We)/s),d=Math.round((t.clientY-Ge)/s),l=ne+c,g=oe+d;(l!==r.x||g!==r.y)&&(le(T,r.id),Ve(r.id),r.x=l,r.y=g,mt(T,r)||(r.x=ne,r.y=oe,mt(T,r)),ae(r.id),Z())}});lt.addEventListener("mouseup",()=>{ue=!1,he=!1});lt.addEventListener("wheel",t=>{t.preventDefault();const o=lt.getBoundingClientRect(),n=t.clientX-o.left,e=t.clientY-o.top,i=_.camera.zoom,a=t.deltaY>0?.9:1.1;_.camera.zoom=Math.max(.3,Math.min(3,_.camera.zoom*a)),_.camera.x=n-(n-_.camera.x)*(_.camera.zoom/i),_.camera.y=e-(e-_.camera.y)*(_.camera.zoom/i),Z()},{passive:!1});lt.addEventListener("contextmenu",t=>t.preventDefault());function Kn(t,o){const n={id:Ae(),type:At,x:t,y:o,orientation:vt};mt(T,n)&&(nt=n.id,_.setSelectedMachine(n.id),yt(),Z())}function Vn(t,o,n){const e=T.cells[o]?.[t];if(e?.machineId){nt=e.machineId,_.setSelectedMachine(e.machineId),ue=!0,We=n.clientX,Ge=n.clientY;const i=T.machines.get(e.machineId);ne=i.x,oe=i.y}else nt=null,_.setSelectedMachine(null);Ht(),Z()}function Zn(t,o){const n=eo(t,o);if(!n){W.textContent="No port at this position";return}if(!ot){if(n.portType!=="OUTPUT"){W.textContent="Click an OUTPUT port (orange) first";return}if(Pe(n.machineId,n.index,"output")){W.textContent="This output port already has a connection";return}ot=n,W.textContent=`Selected output port ${n.index} â€” Now click an INPUT port`;return}if(n.portType!=="INPUT"){W.textContent="Click an INPUT port (blue) to complete the connection";return}if(n.machineId===ot.machineId){W.textContent="Cannot connect a machine to itself";return}if(Pe(n.machineId,n.index,"input")){W.textContent="This input port already has a connection",ot=null;return}const e={id:Ae(),sourceMachineId:ot.machineId,sourcePortIndex:ot.index,targetMachineId:n.machineId,targetPortIndex:n.index};T.connections.set(e.id,e);const i=Gt(T,ot,n,e.id);i?(Ut(T,i),W.textContent=`Connected! Belt length: ${i.segments.length}`):(W.textContent="No path found between these ports!",T.connections.delete(e.id)),ot=null,yt(),Z()}function Qn(t,o){const n=T.cells[o]?.[t];if(n&&n.machineId){const e=n.machineId,i=[];for(const[a,r]of T.connections)(r.sourceMachineId===e||r.targetMachineId===e)&&i.push(a);for(const a of i)Re(T,a),T.connections.delete(a);le(T,e),nt===e&&(nt=null,_.setSelectedMachine(null)),yt(),Z()}}function Je(){if(gt!=="place"){_.setGhost(null);return}const o=ce(T,{type:At,x:ie,y:re,orientation:vt});_.setGhost({gx:ie,gy:re,type:At,orientation:vt,valid:o})}function to(){const t=[Y.NORTH,Y.EAST,Y.SOUTH,Y.WEST],o=t.indexOf(vt);vt=t[(o+1)%4],Je(),Ht(),Z()}function eo(t,o){for(const n of T.machines.values()){const{inputs:e,outputs:i}=L(n);for(const a of[...e,...i])if(a.x===t&&a.y===o)return a}return null}function Pe(t,o,n){for(const e of T.connections.values())if(n==="input"&&e.targetMachineId===t&&e.targetPortIndex===o||n==="output"&&e.sourceMachineId===t&&e.sourcePortIndex===o)return!0;return!1}function Ke(){if(!nt)return;const t=T.machines.get(nt);if(!t)return;const o=[Y.NORTH,Y.EAST,Y.SOUTH,Y.WEST],n=o.indexOf(t.orientation),e=o[(n+1)%4];le(T,t.id),Ve(t.id),t.orientation=e,ce(T,t)?(mt(T,t),ae(t.id)):(t.orientation=o[n],mt(T,t),ae(t.id)),yt(),Z()}function Ve(t){for(const[o,n]of T.connections)(n.sourceMachineId===t||n.targetMachineId===t)&&Re(T,o)}function ae(t){for(const[o,n]of T.connections)if(n.sourceMachineId===t||n.targetMachineId===t){const e=T.machines.get(n.sourceMachineId),i=T.machines.get(n.targetMachineId);if(!e||!i)continue;const a=L(e),r=L(i),s=a.outputs[n.sourcePortIndex],c=r.inputs[n.targetPortIndex];if(!s||!c)continue;const d=Gt(T,s,c,o);d&&Ut(T,d)}}async function fe(t="normal"){if(Vt)return;if(T.machines.size===0){W.textContent="No machines to optimize!";return}const o=document.getElementById("btn-optimize"),n=document.getElementById("btn-search-deeper"),e=document.getElementById("btn-stop-search"),i=ut(T).totalScore,a=t==="deep";a&&(Pt=[]),Vt=!0,Wt=a,bt=!1,o.disabled=!0,n.disabled=!0,e.disabled=!a,o.textContent=a?"âš¡ Optimize":"âš¡ Optimizing...",n.textContent=a?"ðŸ” Searching...":"ðŸ” Search Deeper",e.textContent="â–  Stop",W.textContent=a?"Search Deeper started â€” running continuously from current layout...":"Running optimizer...";try{if(!a){const p=await pe(T,{mode:"normal"},(f,y,m)=>{W.textContent=`${m} â€” iter ${y} | belts: ${f.totalBelts} | area: ${f.boundingBoxArea} | score: ${f.totalScore.toFixed(1)}`});T=p.grid,yt(),W.textContent=`Optimization complete! ${p.iterations} iterations, score: ${p.score.totalScore.toFixed(1)}`,Z();return}const r=performance.now();let s=r,c=i,d=0,l=0,g=!1;for(;!bt;){l++;const p=l,f={mode:"deep",timeBudgetMs:Hn,useExplorationSeeds:!0,phase1Restarts:2,phase2Attempts:2,localPolishPasses:2,persistEliteArchive:!0,incomingEliteArchive:Pt,adaptiveWarmupIterations:100,adaptiveMaxOperatorProb:.45,adaptiveStagnationResetWindow:160,adaptiveFlattenFactor:.55,largeMoveRate:.02,largeMoveRateEarly:.03,largeMoveRateLate:.005,largeMoveCooldownAfterImprove:70,criticalNetRate:.005,repairBeamWidth:1},y=await pe(T,f,(x,I,v)=>{const M=performance.now()-r,P=performance.now()-s,O=Math.min(c,x.totalScore);W.textContent=`Search Deeper #${p} â€” ${v} iter ${I} | best ${O.toFixed(1)} | elapsed ${ft(M)} | idle ${ft(P)}`});d+=y.iterations,T=y.grid,yt(),Z(),Pt=no(f.outgoingEliteArchive)??Pt,y.score.totalScore+ve<c&&(c=y.score.totalScore,s=performance.now());const m=performance.now()-r,b=performance.now()-s;if(b>=Yn){g=!0;break}W.textContent=`Search Deeper cycle ${p} complete | best ${c.toFixed(1)} | elapsed ${ft(m)} | idle ${ft(b)} | continuing...`}const u=performance.now()-r,h=c+ve<i;g?W.textContent=h?`Search Deeper auto-stopped (plateau) â€” improved ${i.toFixed(1)} â†’ ${c.toFixed(1)} in ${ft(u)}`:`Search Deeper auto-stopped (plateau) â€” no improvement after ${ft(u)} (best ${c.toFixed(1)})`:bt?W.textContent=h?`Search Deeper stopped â€” improved ${i.toFixed(1)} â†’ ${c.toFixed(1)} in ${ft(u)}`:`Search Deeper stopped â€” no better layout found (best ${c.toFixed(1)})`:W.textContent=h?`Search Deeper complete â€” improved ${i.toFixed(1)} â†’ ${c.toFixed(1)} in ${d} iterations`:`Search Deeper complete â€” no better layout found (score ${c.toFixed(1)})`}catch(r){console.error(r),W.textContent=a?"Search Deeper failed":"Optimization failed"}finally{Vt=!1,Wt=!1,bt=!1,Pt=[],o.disabled=!1,n.disabled=!1,e.disabled=!0,o.textContent="âš¡ Optimize",n.textContent="ðŸ” Search Deeper",e.textContent="â–  Stop"}}function Ze(){if(!Wt||bt)return;bt=!0;const t=document.getElementById("btn-stop-search");t.disabled=!0,t.textContent="â–  Stopping...",W.textContent="Stopping Search Deeper after current chunk..."}function ft(t){const o=Math.max(0,Math.floor(t/1e3)),n=Math.floor(o/60),e=o%60;return`${n}:${e.toString().padStart(2,"0")}`}function no(t){if(!Array.isArray(t))return null;const o=[];for(const n of t){if(!n||typeof n!="object")continue;const e=n.machines,i=n.connections;!Array.isArray(e)||!Array.isArray(i)||o.push({machines:e,connections:i})}return o}function yt(){const t=ut(T);document.getElementById("score-belts").textContent=`Belts: ${t.totalBelts}`,document.getElementById("score-area").textContent=`Area: ${t.boundingBoxArea}`,document.getElementById("score-corners").textContent=`Corners: ${t.cornerCount}`,document.getElementById("score-total").textContent=`Score: ${t.totalScore.toFixed(1)}`}function Ht(){switch(gt){case"place":W.textContent=`Place mode â€” ${At} [${vt}] â€” R to rotate, click to place`;break;case"select":W.textContent=nt?"Selected machine â€” Drag to move, R to rotate":"Select mode â€” Click a machine to select it";break;case"connect":W.textContent=ot?"Click an INPUT port (blue) to complete the connection":"Connect mode â€” Click an OUTPUT port (orange) to start";break;case"delete":W.textContent="Delete mode â€” Click a machine to delete it";break}}let Zt=!1;function Z(){Zt||(Zt=!0,requestAnimationFrame(()=>{_.render(T),Zt=!1}))}Z();</script>
  <style rel="stylesheet" crossorigin>@import"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap";*{margin:0;padding:0;box-sizing:border-box}:root{--bg-primary: #0f0f1a;--bg-secondary: #1a1a2e;--bg-tertiary: #252542;--accent-primary: #5b57d1;--accent-hover: #7b78e8;--accent-glow: rgba(91, 87, 209, .3);--text-primary: #e0e0ff;--text-secondary: #9090b0;--text-muted: #606080;--border-color: #303060;--success: #7bc950;--warning: #ffd166;--danger: #e05656;--info: #5bc0eb;--radius: 8px;--toolbar-height: 52px;--status-height: 32px}html,body{width:100%;height:100%;overflow:hidden;background:var(--bg-primary);color:var(--text-primary);font-family:Inter,system-ui,-apple-system,sans-serif}#app{width:100%;height:100%;display:flex;flex-direction:column}#toolbar{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);height:var(--toolbar-height);flex-shrink:0;z-index:10}.toolbar-group{display:flex;align-items:center;gap:4px}.toolbar-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-right:4px}.toolbar-divider{width:1px;height:28px;background:var(--border-color);margin:0 4px}.tool-btn{display:flex;align-items:center;gap:4px;padding:6px 12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius);color:var(--text-secondary);font-family:Inter,sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s ease;white-space:nowrap}.tool-btn:hover{background:var(--accent-primary);color:#fff;border-color:var(--accent-hover)}.tool-btn.active{background:var(--accent-primary);color:#fff;border-color:var(--accent-hover);box-shadow:0 0 12px var(--accent-glow)}.tool-btn:disabled{opacity:.5;cursor:not-allowed}.tool-btn .icon{font-size:14px}.tool-btn kbd,.type-btn kbd{display:inline-block;padding:1px 5px;margin-left:4px;font-family:JetBrains Mono,monospace;font-size:10px;font-weight:600;line-height:1.4;color:var(--text-muted);background:#ffffff0f;border:1px solid rgba(255,255,255,.1);border-radius:3px;vertical-align:baseline}.tool-btn.active kbd,.type-btn.active kbd{color:#fff9;background:#ffffff1a;border-color:#ffffff26}.optimize-btn{background:linear-gradient(135deg,#2d6b3f,#1a4a2d);border-color:#3d8b4f}.optimize-btn:hover{background:linear-gradient(135deg,#3d8b4f,#2d6b3f);border-color:#4dab5f;box-shadow:0 0 16px #3d8b4f66}.deep-search-btn{background:linear-gradient(135deg,#2a5f85,#1a3d57);border-color:#3a7ca8}.deep-search-btn:hover{background:linear-gradient(135deg,#3a7ca8,#2a5f85);border-color:#4e95c8;box-shadow:0 0 16px #3a7ca866}.stop-search-btn{background:linear-gradient(135deg,#8c2e35,#641f24);border-color:#ad3c45}.stop-search-btn:hover{background:linear-gradient(135deg,#ad3c45,#8c2e35);border-color:#c94f58;box-shadow:0 0 16px #ad3c4566}.type-btn{padding:6px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius);color:var(--text-secondary);font-family:JetBrains Mono,monospace;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s ease}.type-btn:hover{border-color:var(--info);color:var(--info)}.type-btn.active{background:#5bc0eb26;border-color:var(--info);color:var(--info);box-shadow:0 0 10px #5bc0eb33}#score-panel{display:flex;align-items:center;gap:12px;margin-left:auto;font-family:JetBrains Mono,monospace;font-size:11px;color:var(--text-secondary)}#score-panel span{padding:4px 8px;background:var(--bg-tertiary);border-radius:4px;border:1px solid var(--border-color)}#score-total{color:var(--warning)!important;border-color:#ffd1664d!important;font-weight:600}#status-bar{display:flex;align-items:center;justify-content:space-between;padding:4px 12px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-color);height:var(--status-height);flex-shrink:0;font-size:12px}#status-text{color:var(--text-secondary)}#coord-text{font-family:JetBrains Mono,monospace;color:var(--text-muted);font-size:11px}#canvas-container{flex:1;overflow:hidden;position:relative;cursor:crosshair}#grid-canvas{display:block;width:100%;height:100%}</style>
</head>

<body>
  <div id="app"></div>
</body>

</html>